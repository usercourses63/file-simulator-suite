# File Simulator Suite - Values Configuration
# Deploy to separate namespace: file-simulator (recommended)

global:
  # Shared storage configuration
  storage:
    # Host path on Windows (mounted in Minikube)
    hostPath: /mnt/simulator-data
    # Storage size for PVC
    size: 10Gi
    # Storage class (use "" for default, "standard" for minikube)
    storageClass: ""
  
  # Common labels
  labels:
    app.kubernetes.io/part-of: file-simulator-suite
    environment: development

# Namespace configuration
namespace:
  create: true
  name: file-simulator

# ============================================
# Management UI - FileBrowser
# ============================================
management:
  enabled: true
  image:
    repository: filebrowser/filebrowser
    tag: v2.27.0
    pullPolicy: IfNotPresent
  
  service:
    type: NodePort
    port: 8080
    nodePort: 30180
  
  # Default credentials (change in production!)
  auth:
    username: admin
    password: admin123
  
  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "200m"

# ============================================
# FTP Server
# ============================================
ftp:
  enabled: true
  image:
    repository: fauria/vsftpd
    tag: latest
    pullPolicy: IfNotPresent
  
  service:
    type: NodePort
    port: 21
    nodePort: 30021
    # Passive mode port range
    passivePorts:
      start: 21100
      end: 21110
  
  # FTP user configuration
  auth:
    username: ftpuser
    password: ftppass123
  
  # Directory mappings inside container
  directories:
    input: /home/vsftpd/input
    output: /home/vsftpd/output
  
  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "200m"

# ============================================
# SFTP Server
# ============================================
sftp:
  enabled: true
  image:
    repository: atmoz/sftp
    tag: alpine
    pullPolicy: IfNotPresent
  
  service:
    type: NodePort
    port: 22
    nodePort: 30022
  
  # SFTP user configuration (format: user:pass:uid:gid:dir)
  users:
    - username: sftpuser
      password: sftppass123
      uid: 1000
      gid: 1000
  
  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "200m"

# ============================================
# HTTP File Server (nginx for serving, ugeek/webdav for uploads)
# ============================================
http:
  enabled: true
  image:
    repository: nginx
    tag: alpine
    pullPolicy: IfNotPresent
  # Dedicated WebDAV server image for upload/management
  webdavImage:
    repository: ugeek/webdav
    tag: amd64-alpine
    pullPolicy: IfNotPresent
  
  service:
    type: NodePort
    port: 80
    nodePort: 30088
  
  # Enable WebDAV for read/write access
  webdav:
    enabled: true
    auth:
      username: httpuser
      password: httppass123
  
  # Enable directory listing
  autoindex: true
  
  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "200m"

# ============================================
# NAS Simulator (NFS Server)
# ============================================
nas:
  enabled: true
  image:
    repository: erichough/nfs-server
    tag: latest
    pullPolicy: IfNotPresent

  service:
    type: NodePort
    port: 2049
    nodePort: 32149
  
  # NFS export configuration
  exports:
    # Format: path client(options)
    - path: /data
      clients: "*(rw,sync,no_subtree_check,no_root_squash)"
  
  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "200m"

# ============================================
# NAS Test - Single Instance Validation
# Uses init container + unfs3 pattern (non-privileged)
# Purpose: Prove Windows directories can be exposed via NFS
# ============================================
nasTest:
  enabled: false  # Disabled by default, enable for testing

  # Init container image (for rsync)
  initImage:
    repository: alpine
    tag: latest
    pullPolicy: IfNotPresent

  # NFS server container image (for unfs3)
  image:
    repository: alpine
    tag: latest
    pullPolicy: IfNotPresent

  # NAS instance configuration
  name: nas-test-1
  fsid: 1

  # Host path for Windows data (under global.storage.hostPath)
  dataPath: nas-test-1

  # NFS export options
  exportOptions: "*(rw,sync,no_root_squash)"

  service:
    type: ClusterIP  # ClusterIP for internal, NodePort for Windows access
    port: 2049
    nodePort: 32150  # Used if type is NodePort

  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "200m"

# ============================================
# S3-Compatible Storage (MinIO)
# ============================================
s3:
  enabled: true
  image:
    repository: minio/minio
    tag: latest
    pullPolicy: IfNotPresent
  
  service:
    api:
      type: NodePort
      port: 9000
      nodePort: 30900
    console:
      type: NodePort
      port: 9001
      nodePort: 30901
  
  # MinIO credentials
  auth:
    rootUser: minioadmin
    rootPassword: minioadmin123
  
  # Default buckets to create
  defaultBuckets:
    - name: input
      policy: public
    - name: output
      policy: public
    - name: temp
      policy: none
  
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "1Gi"
      cpu: "500m"

# ============================================
# SMB/CIFS Server (Samba)
# ============================================
smb:
  enabled: true
  image:
    repository: dperson/samba
    tag: latest
    pullPolicy: IfNotPresent

  service:
    # Use LoadBalancer for real port 445 (requires minikube tunnel)
    # This makes Minikube behave exactly like production
    type: LoadBalancer
    port: 445
    # For NodePort fallback (note: SMBLibrary has issues with non-standard ports):
    # type: NodePort
    # nodePort: 30445
  
  # Samba shares configuration
  shares:
    - name: simulator
      path: /data
      browseable: true
      readonly: false
      guest: false
  
  # Samba users
  users:
    - username: smbuser
      password: smbpass123
  
  resources:
    requests:
      memory: "128Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "300m"

# ============================================
# API Gateway / Unified Access Layer
# ============================================
gateway:
  enabled: true
  image:
    repository: nginx
    tag: alpine
    pullPolicy: IfNotPresent
  
  service:
    type: NodePort
    port: 8000
    nodePort: 30000
  
  # Routes to backend services
  routes:
    - path: /ftp
      upstream: ftp
    - path: /sftp
      upstream: sftp
    - path: /http
      upstream: http
    - path: /s3
      upstream: s3
    - path: /smb
      upstream: smb
  
  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "200m"

# ============================================
# Monitoring & Health Checks
# ============================================
monitoring:
  enabled: true

  # Health check endpoints
  healthCheck:
    enabled: true
    path: /health
    port: 8081

  # Prometheus metrics (if you have Prometheus)
  prometheus:
    enabled: false
    port: 9090
    path: /metrics

# ============================================
# Control API - v2.0 Control Plane
# ============================================
controlApi:
  enabled: true

  # Container image (will be built from src/FileSimulator.ControlApi)
  image:
    repository: localhost:5000/file-simulator-control-api
    tag: latest
    pullPolicy: IfNotPresent

  # Service configuration
  service:
    type: NodePort
    httpPort: 5000
    nodePort: 30500  # External access from Windows

  # RBAC configuration
  rbac:
    create: true
    # Permissions for Phase 11 dynamic server management (full CRUD)
    rules:
      - apiGroups: [""]
        resources: ["pods", "services", "configmaps", "persistentvolumeclaims"]
        verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
      - apiGroups: ["apps"]
        resources: ["deployments"]
        verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

  # Resource limits - sized to coexist with v1.0 servers
  # Current cluster: 8GB RAM, 4 CPU
  # v1.0 usage: ~706Mi request, ~2.85Gi limit
  # Control API: adds 256Mi request, 1Gi limit (within budget)
  resources:
    requests:
      memory: "256Mi"
      cpu: "200m"
    limits:
      memory: "1Gi"
      cpu: "1"

  # Health check configuration
  healthCheck:
    path: /health
    initialDelaySeconds: 10
    periodSeconds: 30
    timeoutSeconds: 5
    failureThreshold: 3

  # SignalR configuration
  signalr:
    # Hub path for WebSocket connections
    hubPath: /hubs/status
    # Keep-alive interval (seconds)
    keepAliveInterval: 15

  # Persistence for metrics database (SQLite)
  persistence:
    enabled: true
    # Use hostPath for Minikube (same pattern as simulator-data)
    hostPath: /mnt/control-data
    # Mount path inside container (matches Program.cs connection string)
    mountPath: /mnt/control-data

# ============================================
# Dashboard - Web UI for File Simulator Suite
# ============================================
dashboard:
  enabled: true

  # Container image (built from src/FileSimulator.Dashboard)
  image:
    repository: localhost:5000/file-simulator-dashboard
    tag: latest
    pullPolicy: IfNotPresent

  # Service configuration
  service:
    type: NodePort
    port: 80
    nodePort: 30080

  # Resource limits - lightweight React SPA served by nginx
  resources:
    requests:
      memory: "32Mi"
      cpu: "25m"
    limits:
      memory: "128Mi"
      cpu: "200m"

# ============================================
# Kafka Message Broker (KRaft mode - no ZooKeeper)
# ============================================
kafka:
  enabled: true

  image:
    repository: apache/kafka
    tag: "3.9.0"
    pullPolicy: IfNotPresent

  service:
    type: NodePort
    port: 9092
    nodePort: 30092
    externalPort: 9094
    externalNodePort: 30094

  heap: "512m"

  defaultTopics:
    - name: test-events
      partitions: 3
    - name: test-commands
      partitions: 1
    - name: test-notifications
      partitions: 1

  retention:
    ms: 86400000  # 24 hours

  resources:
    requests:
      memory: "768Mi"
      cpu: "200m"
    limits:
      memory: "1536Mi"
      cpu: "1"

# ============================================
# Kafka UI (Provectus)
# ============================================
kafkaUi:
  enabled: true

  image:
    repository: provectuslabs/kafka-ui
    tag: latest
    pullPolicy: IfNotPresent

  service:
    type: NodePort
    port: 8080
    nodePort: 30093

  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"

# ============================================
# Redis (Optional SignalR Backplane)
# ============================================
redis:
  # Disabled by default - enable for multi-replica Control API deployments
  enabled: false

  image:
    repository: redis
    tag: "7-alpine"
    pullPolicy: IfNotPresent

  service:
    type: ClusterIP
    port: 6379

  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "200m"

# ============================================
# Ingress Configuration (optional)
# ============================================
ingress:
  enabled: false
  className: nginx
  annotations: {}
  hosts:
    - host: files.local
      paths:
        - path: /
          pathType: Prefix
          service: management
  tls: []

# ============================================
# Pod Security & Service Account
# ============================================
serviceAccount:
  create: true
  name: file-simulator-sa
  annotations: {}

podSecurityContext:
  fsGroup: 1000

securityContext:
  runAsNonRoot: false  # Some services need root
  
# ============================================
# Node Affinity (optional)
# ============================================
nodeSelector: {}
tolerations: []
affinity: {}
