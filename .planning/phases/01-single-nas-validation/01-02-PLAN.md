---
phase: 01-single-nas-validation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - scripts/test-nas-pattern.ps1
autonomous: false

must_haves:
  truths:
    - "nas-test-1 pod deployed and running without privileged security context"
    - "File created in C:\\simulator-data\\nas-test-1\\ appears via NFS mount within 30 seconds"
    - "Pod restart re-syncs Windows files (init container runs again)"
    - "NFS client pod can mount nas-test-1:/data and list files"
    - "unfs3 exports /data with rw,sync,no_root_squash,fsid=1 options"
  artifacts:
    - path: "scripts/test-nas-pattern.ps1"
      provides: "Validation script for NAS pattern"
      min_lines: 50
  key_links:
    - from: "scripts/test-nas-pattern.ps1"
      to: "nas-test-1 pod"
      via: "kubectl and PowerShell commands"
      pattern: "kubectl.*nas-test"
---

<objective>
Deploy and validate the init container + unfs3 NAS pattern in Minikube.

Purpose: Prove the core architectural pattern works end-to-end before scaling to 7 NAS servers. This is the make-or-break validation - if this fails, the entire approach needs rethinking.

Output: Running nas-test-1 pod exposing Windows files via NFS, validated with test file creation and NFS mount access, documented in a reusable test script.
</objective>

<execution_context>
@C:\Users\UserC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\UserC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:\Users\UserC\source\repos\file-simulator-suite\.planning\PROJECT.md
@C:\Users\UserC\source\repos\file-simulator-suite\.planning\ROADMAP.md
@C:\Users\UserC\source\repos\file-simulator-suite\.planning\phases\01-single-nas-validation\01-RESEARCH.md

# Prior plan output (template created)
@C:\Users\UserC\source\repos\file-simulator-suite\.planning\phases\01-single-nas-validation\01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deploy nas-test-1 and verify pod health</name>
  <files>None (deployment verification)</files>
  <action>
Deploy the nas-test-1 NAS server to Minikube and verify it runs correctly.

Steps:
1. Ensure Minikube is running with mount: `minikube status` (if not running, inform user)
2. Create Windows directory if missing: Check C:\simulator-data\nas-test-1 exists
3. Deploy with Helm:
   ```
   helm upgrade --install file-sim ./helm-chart/file-simulator \
     --namespace file-simulator --create-namespace \
     --set nasTest.enabled=true
   ```
4. Wait for pod ready: `kubectl wait --for=condition=ready pod -l app.kubernetes.io/component=nas-test-1 -n file-simulator --timeout=120s`
5. Verify pod is running: `kubectl get pods -n file-simulator -l app.kubernetes.io/component=nas-test-1`
6. Check pod is NOT privileged: `kubectl get pod -n file-simulator -l app.kubernetes.io/component=nas-test-1 -o jsonpath='{.items[0].spec.containers[0].securityContext}'` - should show capabilities, not privileged:true
7. Check init container completed: `kubectl logs -n file-simulator -l app.kubernetes.io/component=nas-test-1 -c sync-windows-data`
8. Check NFS server logs: `kubectl logs -n file-simulator -l app.kubernetes.io/component=nas-test-1 -c nfs-server`

If pod crashes, check events: `kubectl describe pod -n file-simulator -l app.kubernetes.io/component=nas-test-1`
  </action>
  <verify>
`kubectl get pods -n file-simulator -l app.kubernetes.io/component=nas-test-1 -o jsonpath='{.items[0].status.phase}'` returns "Running"
  </verify>
  <done>
nas-test-1 pod is Running, init container completed rsync, NFS server container started on port 2049, pod is NOT using privileged security context.
  </done>
</task>

<task type="auto">
  <name>Task 2: Validate Windows-to-NFS file sync</name>
  <files>None (validation)</files>
  <action>
Validate files placed in Windows directory appear via NFS export.

Steps:
1. Create test file on Windows:
   - Create C:\simulator-data\nas-test-1\test-from-windows.txt with content "Created from Windows at [timestamp]"

2. Trigger re-sync (restart pod to run init container again):
   ```
   kubectl delete pod -n file-simulator -l app.kubernetes.io/component=nas-test-1
   kubectl wait --for=condition=ready pod -l app.kubernetes.io/component=nas-test-1 -n file-simulator --timeout=120s
   ```

3. Verify file visible in NFS export:
   ```
   kubectl exec -n file-simulator -l app.kubernetes.io/component=nas-test-1 -c nfs-server -- ls -la /data
   kubectl exec -n file-simulator -l app.kubernetes.io/component=nas-test-1 -c nfs-server -- cat /data/test-from-windows.txt
   ```

4. Verify NFS export configuration:
   ```
   kubectl exec -n file-simulator -l app.kubernetes.io/component=nas-test-1 -c nfs-server -- cat /etc/exports
   ```
   Should show: `/data *(rw,sync,no_root_squash,fsid=1)`

5. Test NFS connectivity from another pod (create test client pod):
   ```yaml
   kubectl run nfs-test-client --rm -i --tty \
     --image=alpine:latest \
     --restart=Never \
     --overrides='{"spec":{"containers":[{"name":"nfs-test-client","image":"alpine:latest","command":["sh","-c","apk add --no-cache nfs-utils && sleep 3600"],"securityContext":{"privileged":true,"capabilities":{"add":["SYS_ADMIN"]}}}]}}' \
     -n file-simulator
   ```
   Then in the client:
   ```
   mkdir -p /mnt/nfs
   mount -t nfs -o nfsvers=3,tcp file-sim-file-simulator-nas-test-1.file-simulator.svc.cluster.local:/data /mnt/nfs
   ls -la /mnt/nfs
   cat /mnt/nfs/test-from-windows.txt
   ```

Note: The NFS client pod needs privileged mode for mount operation (this is expected - only the SERVER needs to be non-privileged).
  </action>
  <verify>
File test-from-windows.txt visible in NFS export at /data. NFS client can mount and read the file. Export options match expected configuration.
  </verify>
  <done>
Windows file visible via NFS export. NFS client pod can mount nas-test-1:/data and read files. Pod restart preserves Windows file (init container re-syncs).
  </done>
</task>

<task type="auto">
  <name>Task 3: Create validation test script</name>
  <files>scripts/test-nas-pattern.ps1</files>
  <action>
Create a PowerShell script that automates the NAS pattern validation for future use.

Script should:
1. Check Minikube status (warn if not running)
2. Create test directory C:\simulator-data\nas-test-1 if missing
3. Create test file with timestamp
4. Deploy nas-test-1 if not already deployed
5. Wait for pod ready
6. Verify pod security context (not privileged)
7. Verify file visible in /data
8. Verify exports configuration
9. Create NFS test client pod
10. Mount and verify file accessible via NFS
11. Cleanup test client pod
12. Report SUCCESS or FAILURE

Include helpful output messages for each step.

Error handling:
- If Minikube not running, exit with instructions
- If deployment fails, show pod describe output
- If NFS mount fails, show troubleshooting suggestions

The script should be idempotent (safe to run multiple times).
  </action>
  <verify>
Script exists at scripts/test-nas-pattern.ps1 and is executable. Script has clear output and error handling.
  </verify>
  <done>
test-nas-pattern.ps1 script created with complete validation flow, error handling, and cleanup.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Single NAS test deployment (nas-test-1) using init container + unfs3 pattern without privileged mode.

The deployment proves:
1. Windows directory (C:\simulator-data\nas-test-1) exposed via NFS
2. unfs3 userspace NFS server works in non-privileged container
3. Files sync from Windows to NFS export via init container
4. NFS client can mount and access files
  </what-built>
  <how-to-verify>
1. Create a test file on Windows:
   - Navigate to C:\simulator-data\nas-test-1\
   - Create a file named "manual-test.txt" with any content

2. Restart the NAS pod to trigger re-sync:
   ```
   kubectl delete pod -n file-simulator -l app.kubernetes.io/component=nas-test-1
   kubectl wait --for=condition=ready pod -l app.kubernetes.io/component=nas-test-1 -n file-simulator --timeout=60s
   ```

3. Verify file appears in NFS export:
   ```
   kubectl exec -n file-simulator -l app.kubernetes.io/component=nas-test-1 -c nfs-server -- ls -la /data
   ```
   You should see "manual-test.txt" in the listing.

4. Optionally run the test script:
   ```
   .\scripts\test-nas-pattern.ps1
   ```
   Should complete with SUCCESS.
  </how-to-verify>
  <resume-signal>Type "approved" if validation passes, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
Phase 1 Success Criteria (from Roadmap):

1. [x] Single NAS pod (nas-test-1) deployed and running without privileged security context
   - Verify: `kubectl get pod ... -o jsonpath='{.items[0].spec.containers[0].securityContext}'` shows capabilities, not privileged:true

2. [x] File written to Windows directory C:\simulator-data\nas-test-1\ appears via NFS mount within 30 seconds
   - Verify: Create file on Windows, restart pod, check /data in container

3. [x] Pod restart preserves Windows files (init container re-syncs on startup)
   - Verify: Delete pod, wait for new pod, files still in /data

4. [x] NFS client can mount nas-test-1:/data and list files
   - Verify: Test client pod mounts and reads files

5. [x] unfs3 exports /data with rw,sync,no_root_squash options
   - Verify: `cat /etc/exports` in container shows correct options
</verification>

<success_criteria>
- nas-test-1 pod runs with non-privileged security context (capabilities only)
- Windows files appear in NFS export after pod restart
- NFS client pod can mount and access files
- test-nas-pattern.ps1 script validates the complete flow
- Human verification confirms pattern works as expected
</success_criteria>

<output>
After completion, create `.planning/phases/01-single-nas-validation/01-02-SUMMARY.md`
</output>
