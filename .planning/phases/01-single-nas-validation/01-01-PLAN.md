---
phase: 01-single-nas-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - helm-chart/file-simulator/templates/nas-test.yaml
  - helm-chart/file-simulator/values.yaml
autonomous: true

must_haves:
  truths:
    - "nas-test.yaml template exists with init container + main container pattern"
    - "Init container uses alpine with rsync to copy from hostPath to emptyDir"
    - "Main container uses alpine with unfs3 serving /data"
    - "unfs3 runs with -d -p -t -n 2049 flags (foreground, no portmap, TCP, port 2049)"
    - "Security context uses NET_BIND_SERVICE capability, not privileged mode"
    - "values.yaml has nasTest configuration section with all required options"
  artifacts:
    - path: "helm-chart/file-simulator/templates/nas-test.yaml"
      provides: "Single NAS test deployment with init container pattern"
      min_lines: 100
    - path: "helm-chart/file-simulator/values.yaml"
      provides: "nasTest configuration section"
      contains: "nasTest:"
  key_links:
    - from: "helm-chart/file-simulator/templates/nas-test.yaml"
      to: "helm-chart/file-simulator/values.yaml"
      via: ".Values.nasTest"
      pattern: "\\.Values\\.nasTest"
---

<objective>
Create Helm template for single NAS test deployment using init container + unfs3 pattern.

Purpose: Implement the core architecture pattern that will prove Windows directories can be exposed via NFS without privileged containers. This is the make-or-break validation that the entire multi-NAS topology depends on.

Output: Working Helm template (nas-test.yaml) and values configuration that deploys a single NAS pod with init container (rsync) + main container (unfs3).
</objective>

<execution_context>
@C:\Users\UserC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\UserC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:\Users\UserC\source\repos\file-simulator-suite\.planning\PROJECT.md
@C:\Users\UserC\source\repos\file-simulator-suite\.planning\ROADMAP.md
@C:\Users\UserC\source\repos\file-simulator-suite\.planning\phases\01-single-nas-validation\01-RESEARCH.md

# Existing templates for reference patterns
@C:\Users\UserC\source\repos\file-simulator-suite\helm-chart\file-simulator\templates\_helpers.tpl
@C:\Users\UserC\source\repos\file-simulator-suite\helm-chart\file-simulator\templates\ftp-multi.yaml
@C:\Users\UserC\source\repos\file-simulator-suite\helm-chart\file-simulator\values.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create nas-test.yaml Helm template</name>
  <files>helm-chart/file-simulator/templates/nas-test.yaml</files>
  <action>
Create a new Helm template for the NAS test deployment implementing the init container + unfs3 pattern from research.

Structure:
1. Conditional block: `{{- if .Values.nasTest.enabled }}`
2. Deployment with:
   - initContainers section: alpine container that installs rsync, syncs /windows-mount/ to /nfs-data/
   - containers section: alpine container that installs unfs3, creates /etc/exports, runs `unfsd -d -p -t -n 2049 -e /etc/exports`
   - Two volumes: windows-data (hostPath to /mnt/simulator-data/nas-test-1) and nfs-export (emptyDir)
3. Service with ClusterIP and optional NodePort

Key implementation details from research:
- Init container: `apk add --no-cache rsync` then `rsync -av --delete /windows-mount/ /nfs-data/`
- Main container: `apk add --no-cache unfs3` then write exports file with fsid=1, start unfsd
- Security context on main container: `capabilities: {add: [NET_BIND_SERVICE], drop: [ALL]}`, `allowPrivilegeEscalation: false`
- Do NOT use `privileged: true` - this is the whole point of the validation
- Use TCP liveness/readiness probes on port 2049
- hostPath type: DirectoryOrCreate (auto-creates Windows directory if missing - WIN-07)

Follow label patterns from ftp-multi.yaml: use `app.kubernetes.io/component: nas-test-1` and `simulator.protocol: nfs`.
  </action>
  <verify>
Run: `helm template file-sim helm-chart/file-simulator --set nasTest.enabled=true 2>&1 | grep -A 200 "nas-test"` - should show complete deployment YAML without errors.
  </verify>
  <done>
nas-test.yaml template exists, renders without Helm errors, contains initContainers with rsync and containers with unfs3, uses NET_BIND_SERVICE capability without privileged mode.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add nasTest configuration to values.yaml</name>
  <files>helm-chart/file-simulator/values.yaml</files>
  <action>
Add a new `nasTest` section to values.yaml after the existing `nas` section.

Configuration structure:
```yaml
# ============================================
# NAS Test - Single Instance Validation
# Uses init container + unfs3 pattern (non-privileged)
# ============================================
nasTest:
  enabled: false  # Disabled by default, enable for testing

  # Init container image (for rsync)
  initImage:
    repository: alpine
    tag: latest
    pullPolicy: IfNotPresent

  # NFS server container image (for unfs3)
  image:
    repository: alpine
    tag: latest
    pullPolicy: IfNotPresent

  # NAS instance configuration
  name: nas-test-1
  fsid: 1

  # Host path for Windows data (under global.storage.hostPath)
  dataPath: nas-test-1

  # NFS export options
  exportOptions: "*(rw,sync,no_root_squash)"

  service:
    type: ClusterIP  # ClusterIP for internal, NodePort for Windows access
    port: 2049
    nodePort: 32150  # Used if type is NodePort

  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "200m"
```

This covers requirements:
- DEP-04: Configurable resource limits (resources section)
- NAS-07: Unique fsid (fsid: 1)
- EXP-03: Export options (exportOptions)
- WIN-01: Separate Windows directory (dataPath)
  </action>
  <verify>
Run: `helm lint helm-chart/file-simulator` - should pass without errors. Then check: `grep -A 30 "nasTest:" helm-chart/file-simulator/values.yaml` should show complete configuration.
  </verify>
  <done>
values.yaml contains nasTest section with all configuration options (enabled, initImage, image, name, fsid, dataPath, exportOptions, service, resources).
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `helm lint helm-chart/file-simulator` passes
2. `helm template file-sim helm-chart/file-simulator --set nasTest.enabled=true` renders complete deployment
3. Rendered YAML shows:
   - initContainers section with rsync
   - containers section with unfs3
   - securityContext with NET_BIND_SERVICE capability
   - NO `privileged: true` anywhere
   - hostPath volume pointing to /mnt/simulator-data/nas-test-1
   - emptyDir volume for NFS export
</verification>

<success_criteria>
- nas-test.yaml template renders without Helm errors
- Template implements init container + unfs3 pattern exactly as specified in research
- Security context uses capabilities, not privileged mode
- values.yaml has complete nasTest configuration section
- All configuration values (fsid, exportOptions, resources) are parameterized via values
</success_criteria>

<output>
After completion, create `.planning/phases/01-single-nas-validation/01-01-SUMMARY.md`
</output>
