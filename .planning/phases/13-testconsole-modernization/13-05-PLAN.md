# Plan 13-05: Playwright E2E test setup and Start-Simulator integration

---
wave: 2
depends_on: []
files_modified:
  - tests/FileSimulator.E2ETests/FileSimulator.E2ETests.csproj (new)
  - tests/FileSimulator.E2ETests/Fixtures/SimulatorTestFixture.cs (new)
  - tests/FileSimulator.E2ETests/Support/WaitHelpers.cs (new)
  - tests/FileSimulator.E2ETests/PlaywrightSettings.json (new)
  - scripts/Start-Simulator.ps1 (new)
  - file-simulator-suite.sln
autonomous: true
---

## Objective

Set up the Playwright E2E testing infrastructure including the test project, simulator test fixture that integrates with Start-Simulator.ps1, and supporting utilities for browser-based testing of the React dashboard.

## Context

E2E tests will validate the dashboard UI by automating browser interactions. The tests need:
1. A running simulator environment (Control API + Dashboard + Kubernetes services)
2. Browser automation via Playwright
3. Test fixtures that handle simulator lifecycle

The Start-Simulator.ps1 script will start all required services for local E2E testing.

## Tasks

<task id="1">
Create the E2E test project.

Create directory: tests/FileSimulator.E2ETests/

Create file: tests/FileSimulator.E2ETests/FileSimulator.E2ETests.csproj

```xml
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
    <IsPackable>false</IsPackable>
    <IsTestProject>true</IsTestProject>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.Playwright.Xunit" Version="1.58.0" />
    <PackageReference Include="xunit" Version="2.9.0" />
    <PackageReference Include="xunit.runner.visualstudio" Version="2.8.2">
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
    <PackageReference Include="FluentAssertions" Version="6.12.2" />
    <PackageReference Include="Microsoft.NET.Test.Sdk" Version="17.12.0" />
  </ItemGroup>

  <ItemGroup>
    <Content Include="PlaywrightSettings.json">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </Content>
  </ItemGroup>
</Project>
```
</task>

<task id="2">
Create Playwright settings configuration.

Create file: tests/FileSimulator.E2ETests/PlaywrightSettings.json

```json
{
  "Dashboard": {
    "BaseUrl": "http://localhost:3000",
    "ApiUrl": "http://localhost:5000"
  },
  "Playwright": {
    "Headless": true,
    "SlowMo": 0,
    "Timeout": 30000,
    "BrowserType": "chromium"
  },
  "Simulator": {
    "StartScript": "../../scripts/Start-Simulator.ps1",
    "StartupTimeout": 300000,
    "UseExistingInstance": false
  }
}
```
</task>

<task id="3">
Create the SimulatorTestFixture class.

Create file: tests/FileSimulator.E2ETests/Fixtures/SimulatorTestFixture.cs

Implement IAsyncLifetime fixture:
- Properties: DashboardUrl, ApiUrl, Browser, Context
- InitializeAsync():
  1. Load PlaywrightSettings.json
  2. Check if USE_EXISTING_SIMULATOR env var is set (for CI)
  3. If not using existing, start Start-Simulator.ps1 process
  4. Wait for API health check at /api/health
  5. Wait for dashboard at root URL
  6. Create Playwright instance and launch browser
  7. Create browser context with viewport 1920x1080
- DisposeAsync():
  1. Close browser and Playwright
  2. If started simulator process, kill process tree
  3. Log cleanup completion
</task>

<task id="4">
Create WaitHelpers utility class.

Create file: tests/FileSimulator.E2ETests/Support/WaitHelpers.cs

Implement:
- WaitForServiceHealthyAsync(string url, TimeSpan timeout) - poll health endpoint
- WaitForUrlAccessibleAsync(string url, TimeSpan timeout) - poll for 200 response
- GetRepoRootPath() - traverse up to find .git directory
- LoadPlaywrightSettings() - deserialize PlaywrightSettings.json
</task>

<task id="5">
Create Start-Simulator.ps1 script.

Create file: scripts/Start-Simulator.ps1

Implement PowerShell script that:
1. Checks if Minikube file-simulator profile is running
2. If not, warns user to start it first (don't auto-start cluster)
3. Starts Control API (dotnet run in background)
4. Starts Dashboard (npm start in background)
5. Waits for both services to be healthy
6. Opens browser to dashboard (unless -NoBrowser specified)
7. Keeps running until Ctrl+C
8. On exit, kills child processes

Parameters:
- -NoBrowser: Don't open browser
- -ApiOnly: Only start Control API
- -DashboardOnly: Only start Dashboard
- -Wait: Wait for services and exit (for test integration)
</task>

<task id="6">
Add project to solution.

Update: file-simulator-suite.sln

Add the E2E test project:
```
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "FileSimulator.E2ETests", "tests\FileSimulator.E2ETests\FileSimulator.E2ETests.csproj", "{GUID}"
EndProject
```

Create tests folder structure if needed.
</task>

<task id="7">
Create test collection for shared fixture.

Create file: tests/FileSimulator.E2ETests/SimulatorTestCollection.cs

```csharp
[CollectionDefinition("Simulator")]
public class SimulatorTestCollection : ICollectionFixture<SimulatorTestFixture>
{
}
```

This allows multiple test classes to share one simulator instance.
</task>

<task id="8">
Create a sample test to verify setup.

Create file: tests/FileSimulator.E2ETests/Tests/SmokeTests.cs

```csharp
[Collection("Simulator")]
public class SmokeTests
{
    private readonly SimulatorTestFixture _fixture;

    public SmokeTests(SimulatorTestFixture fixture)
    {
        _fixture = fixture;
    }

    [Fact]
    public async Task Dashboard_Loads_Successfully()
    {
        var page = await _fixture.Context.NewPageAsync();
        await page.GotoAsync(_fixture.DashboardUrl);
        await page.WaitForLoadStateAsync(LoadState.NetworkIdle);

        var title = await page.TitleAsync();
        title.Should().Contain("File Simulator");

        await page.CloseAsync();
    }

    [Fact]
    public async Task Api_Health_Returns_Success()
    {
        using var client = new HttpClient();
        var response = await client.GetAsync($"{_fixture.ApiUrl}/api/health");
        response.IsSuccessStatusCode.Should().BeTrue();
    }
}
```
</task>

<task id="9">
Create PowerShell script for Playwright browser installation.

Create file: scripts/Install-PlaywrightBrowsers.ps1

```powershell
# Install Playwright browsers for E2E testing
$projectDir = Join-Path $PSScriptRoot "..\tests\FileSimulator.E2ETests"
Push-Location $projectDir

# Build project to generate playwright.ps1
dotnet build

# Run browser installation
$playwrightScript = Join-Path $projectDir "bin\Debug\net9.0\playwright.ps1"
if (Test-Path $playwrightScript) {
    & pwsh $playwrightScript install
} else {
    Write-Error "playwright.ps1 not found. Build the project first."
}

Pop-Location
```
</task>

## Verification

```powershell
# Build E2E test project
cd C:\Users\UserC\source\repos\file-simulator-suite\tests\FileSimulator.E2ETests
dotnet build

# Install Playwright browsers (one-time)
pwsh ..\..\scripts\Install-PlaywrightBrowsers.ps1

# Run smoke tests (requires simulator running)
# Option 1: Use existing simulator
$env:USE_EXISTING_SIMULATOR = "true"
dotnet test --filter "FullyQualifiedName~SmokeTests"

# Option 2: Let fixture start simulator
$env:USE_EXISTING_SIMULATOR = ""
dotnet test --filter "FullyQualifiedName~SmokeTests"

# Verify Start-Simulator.ps1 works
cd C:\Users\UserC\source\repos\file-simulator-suite
.\scripts\Start-Simulator.ps1 -NoBrowser

# Expected:
# - Control API starts at http://localhost:5000
# - Dashboard starts at http://localhost:3000
# - Health checks pass
```

## must_haves

These criteria must be TRUE for the plan to be considered complete:

1. FileSimulator.E2ETests project created with Playwright.Xunit package
2. SimulatorTestFixture can start/stop simulator environment
3. SimulatorTestFixture can connect to existing instance via environment variable
4. Start-Simulator.ps1 starts Control API and Dashboard
5. Smoke tests pass (dashboard loads, API health returns success)
6. Playwright browsers can be installed via script
7. Project is added to solution file
