# Plan 13-03: TestConsole dynamic server creation and testing

---
wave: 1
depends_on:
  - 13-01-PLAN.md
files_modified:
  - src/FileSimulator.TestConsole/DynamicServerTests.cs (new)
  - src/FileSimulator.TestConsole/Models/DynamicServerTestResult.cs (new)
  - src/FileSimulator.TestConsole/Program.cs
autonomous: true
---

## Objective

Extend TestConsole to test the dynamic server management functionality by creating dynamic FTP, SFTP, and NAS servers via the Control API, testing connectivity, and then cleaning up by deleting them.

## Context

Phase 11 added dynamic server management to the Control API. Servers can be created, monitored, and deleted via:
- POST /api/servers - create new server
- GET /api/servers/{name} - get server status
- DELETE /api/servers/{name} - delete server

Dynamic servers support three protocols:
- FTP (CreateFtpServerRequest)
- SFTP (CreateSftpServerRequest)
- NAS (CreateNasServerRequest)

Each dynamic server gets:
- Unique name (user-provided or auto-generated)
- Kubernetes Deployment and Service
- NodePort in 31000-31999 range
- Configurable credentials and directory

## Tasks

<task id="1">
Create DynamicServerTestResult model class.

Create file: src/FileSimulator.TestConsole/Models/DynamicServerTestResult.cs

Include:
- Protocol (string: FTP/SFTP/NAS)
- ServerName (string)
- CreateSuccess (bool)
- CreateMs (long)
- WaitForReadySuccess (bool)
- WaitForReadyMs (long)
- ConnectivitySuccess (bool)
- ConnectivityMs (long)
- FileOperationSuccess (bool?)
- FileOperationMs (long?)
- DeleteSuccess (bool)
- DeleteMs (long)
- TotalMs (long)
- Error (string?)
</task>

<task id="2">
Create DynamicServerTests class with test lifecycle.

Create file: src/FileSimulator.TestConsole/DynamicServerTests.cs

Implement static class with:
- TestDynamicServersAsync(string apiBaseUrl) - main entry point
- CreateDynamicServerAsync(HttpClient client, string protocol, string name) - create server
- WaitForServerReadyAsync(HttpClient client, string name, TimeSpan timeout) - poll until ready
- TestServerConnectivityAsync(string protocol, string host, int port, string username, string password) - test connection
- DeleteDynamicServerAsync(HttpClient client, string name) - delete server
- DisplayDynamicResults(List<DynamicServerTestResult> results) - render results
</task>

<task id="3">
Implement server creation for each protocol.

In CreateDynamicServerAsync:

For FTP:
```json
{
  "name": "test-ftp-{timestamp}",
  "username": "testuser",
  "password": "testpass123",
  "directory": "input/test-dynamic"
}
```

For SFTP:
```json
{
  "name": "test-sftp-{timestamp}",
  "username": "testuser",
  "password": "testpass123",
  "directory": "input/test-dynamic"
}
```

For NAS:
```json
{
  "name": "test-nas-{timestamp}",
  "directory": "input/test-dynamic",
  "readOnly": false
}
```

Use timestamp format: yyyyMMddHHmmss to ensure unique names.
POST to /api/servers with appropriate content type.
</task>

<task id="4">
Implement wait-for-ready polling.

In WaitForServerReadyAsync:
- Poll GET /api/servers/{name} every 2 seconds
- Check response for status == "Running" and podReady == true
- Timeout after 60 seconds with meaningful error
- Return the server info (host, port, credentials) on success
- Log progress: "Waiting for server {name}... (attempt X/30)"
</task>

<task id="5">
Implement connectivity testing per protocol.

In TestServerConnectivityAsync:

For FTP:
- Use FluentFTP AsyncFtpClient
- Connect with provided credentials
- Verify IsConnected == true
- Disconnect cleanly

For SFTP:
- Use SSH.NET SftpClient
- Connect with provided credentials
- Verify IsConnected == true
- Disconnect cleanly

For NAS:
- Use TcpClient to verify port accessibility
- NFS protocol testing requires mount (mark as TCP-only)
</task>

<task id="6">
Implement optional file operations test.

After connectivity test, optionally test file operations:
- Create test file with unique content
- Read back and verify content matches
- Delete test file

This is optional (--full-dynamic-test flag) because:
- Adds significant time to tests
- Connectivity test is sufficient for validation
- Full file ops already covered in protocol-specific tests
</task>

<task id="7">
Implement server cleanup (deletion).

In DeleteDynamicServerAsync:
- Send DELETE to /api/servers/{name}
- Verify 200/204 response
- Optionally poll to verify pod is removed (max 30 seconds)
- Handle case where server doesn't exist (already deleted)
</task>

<task id="8">
Update Program.cs to include dynamic server tests.

Modify: src/FileSimulator.TestConsole/Program.cs

Add:
- Command-line flag --dynamic to run dynamic server tests
- Command-line flag --full-dynamic-test to include file operations
- Call DynamicServerTests.TestDynamicServersAsync() when flag present
- Skip dynamic tests by default (they're slower and modify cluster state)
</task>

<task id="9">
Implement comprehensive results display.

In DisplayDynamicResults:
- Use Spectre.Console table: Protocol, Name, Create, Ready, Connect, FileOps, Delete, Total
- Color-code: green for pass, red for fail, grey for skipped
- Show timing for each phase
- Display error messages for failures
- Summary: X/3 protocols tested successfully
</task>

<task id="10">
Add cleanup-on-failure handling.

Ensure that if any test step fails:
- Still attempt to delete the server (cleanup)
- Log the failure but don't leave orphaned resources
- Use try/finally pattern for cleanup
</task>

## Verification

```powershell
# Build TestConsole
cd C:\Users\UserC\source\repos\file-simulator-suite\src\FileSimulator.TestConsole
dotnet build

# Run dynamic server tests (requires Control API and cluster)
dotnet run -- --dynamic

# Run with full file operations test
dotnet run -- --dynamic --full-dynamic-test

# Expected output:
# - Creates test-ftp-{timestamp}, waits for ready, tests connection, deletes
# - Creates test-sftp-{timestamp}, waits for ready, tests connection, deletes
# - Creates test-nas-{timestamp}, waits for ready, tests TCP, deletes
# - All 3 protocols show PASS
# - No orphaned resources left in cluster

# Verify no leftover resources
kubectl --context=file-simulator get pods -n file-simulator | Select-String "test-"
# Should return nothing
```

## must_haves

These criteria must be TRUE for the plan to be considered complete:

1. TestConsole can create dynamic FTP, SFTP, and NAS servers via API
2. TestConsole waits for dynamic servers to become ready (with timeout)
3. TestConsole tests connectivity to each dynamic server
4. TestConsole deletes dynamic servers after testing (cleanup)
5. No orphaned resources left after test completes (even on failure)
6. Results displayed with timing for each phase (create, ready, connect, delete)
7. --dynamic flag enables dynamic server tests (disabled by default)
