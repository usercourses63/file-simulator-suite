# Plan 13-02: TestConsole NAS server testing (7 multi-NAS servers)

---
wave: 1
depends_on:
  - 13-01-PLAN.md
files_modified:
  - src/FileSimulator.TestConsole/NasServerTests.cs (new)
  - src/FileSimulator.TestConsole/Models/NasTestResult.cs (new)
  - src/FileSimulator.TestConsole/Program.cs
autonomous: true
---

## Objective

Extend TestConsole to test all 7 NAS servers in the multi-NAS topology (nas-input-1/2/3, nas-backup, nas-output-1/2/3) with comprehensive file operations testing.

## Context

The v1.0 release added a 7-server NAS topology that replicates production OCP network architecture:
- 3 input NAS servers (nas-input-1, nas-input-2, nas-input-3) on ports 32150-32152
- 1 backup NAS server (nas-backup, read-only) on port 32153
- 3 output NAS servers (nas-output-1, nas-output-2, nas-output-3) on ports 32154-32156

Each NAS server has:
- Unique DNS name: file-sim-nas-{name}.file-simulator.svc.cluster.local:2049
- Unique NodePort for external access
- Isolated storage at C:\simulator-data\nas-{name}\
- Output servers have bidirectional sync (init container + sidecar)

## Tasks

<task id="1">
Create NasTestResult model class.

Create file: src/FileSimulator.TestConsole/Models/NasTestResult.cs

Include:
- ServerName (string)
- ServerType (string: input/backup/output)
- TcpConnected (bool)
- ConnectMs (long)
- MountPathExists (bool)
- WriteSuccess (bool?)
- WriteMs (long?)
- ReadSuccess (bool?)
- ReadMs (long?)
- ListSuccess (bool?)
- ListMs (long?)
- DeleteSuccess (bool?)
- DeleteMs (long?)
- SyncVerified (bool?) - for output servers, verify NFS->Windows sync
- Error (string?)
</task>

<task id="2">
Create NasServerTests class with test methods.

Create file: src/FileSimulator.TestConsole/NasServerTests.cs

Implement static class with:
- TestAllNasServersAsync(TestConfiguration config) - main entry point
- TestNasServerAsync(ServerConfig server, string testContent, string testFileName) - test single server
- DisplayNasResults(List<NasTestResult> results) - render Spectre.Console table

Test flow for each NAS server:
1. TCP connectivity test to NodePort
2. Check Windows mount path exists (C:\simulator-data\nas-{name}\)
3. Write test file via Windows mount
4. Read test file back and verify content
5. List directory and verify file appears
6. Delete test file and verify removal
7. For output servers: verify sync timing (file should appear within expected window)
</task>

<task id="3">
Implement NAS server filtering logic.

In NasServerTests.cs, add methods to:
- FilterNasServers(TestConfiguration config) - return only NAS/NFS servers from config
- GroupByType(List<ServerConfig> servers) - group into input/backup/output
- GetMountPath(ServerConfig server) - return Windows mount path based on server name

Handle both:
- API-driven config (servers have Type="nas" and Protocol="NFS")
- Fallback config (may need to detect NAS servers by port range 32150-32156)
</task>

<task id="4">
Add special handling for backup NAS (read-only).

In TestNasServerAsync:
- Detect backup server by name or type
- Skip write and delete tests for backup server
- Only test: TCP connectivity, mount exists, read existing files, list directory
- Mark write/delete results as null (N/A) not false (FAIL)
</task>

<task id="5">
Add sync verification for output NAS servers.

In TestNasServerAsync, for output servers only:
- After writing file via Windows mount, test if it appears via NFS
- Measure sync timing (expected: 15-30 seconds based on sidecar)
- Use TCP connection to verify NFS port is accessible
- Log sync timing in result

Note: Full NFS mount verification requires Linux/WSL. For Windows, verify:
- File written to mount path
- TCP connection to NFS port succeeds
- Mark sync as "verified" if both pass
</task>

<task id="6">
Update Program.cs to include NAS tests.

Modify: src/FileSimulator.TestConsole/Program.cs

Add:
- Command-line flag --nas-only to run only NAS tests
- Command-line flag --skip-nas to skip NAS tests
- Call NasServerTests.TestAllNasServersAsync() after existing protocol tests
- Handle case when no NAS servers found (display warning, not error)
</task>

<task id="7">
Implement comprehensive results display.

In DisplayNasResults:
- Use Spectre.Console table with columns: Server, Type, TCP, Mount, Write, Read, List, Delete, Sync, Total(ms)
- Color-code results: green for pass, red for fail, grey for N/A
- Show error messages for failed tests
- Display summary panel: X/7 servers passed
- Group results by type (input, backup, output)
</task>

## Verification

```powershell
# Build and run with NAS tests
cd C:\Users\UserC\source\repos\file-simulator-suite\src\FileSimulator.TestConsole
dotnet build
dotnet run

# Run only NAS tests
dotnet run -- --nas-only

# Skip NAS tests (run other protocols only)
dotnet run -- --skip-nas

# Expected output (when simulator running):
# - 7 NAS servers listed in results table
# - Input servers (1-3): All operations should pass
# - Backup server: Read/list pass, write/delete show N/A
# - Output servers (1-3): All operations pass, sync verified

# Verify mount paths exist
Test-Path C:\simulator-data\nas-input-1
Test-Path C:\simulator-data\nas-input-2
Test-Path C:\simulator-data\nas-input-3
Test-Path C:\simulator-data\nas-backup
Test-Path C:\simulator-data\nas-output-1
Test-Path C:\simulator-data\nas-output-2
Test-Path C:\simulator-data\nas-output-3
```

## must_haves

These criteria must be TRUE for the plan to be considered complete:

1. TestConsole tests all 7 NAS servers (input-1/2/3, backup, output-1/2/3)
2. Each NAS server test includes: TCP connectivity, mount path check, file operations
3. Backup NAS is handled as read-only (write/delete skipped, not failed)
4. Output NAS servers include sync verification
5. Results displayed in formatted table with pass/fail/N/A indicators
6. Summary shows X/7 servers passed
7. --nas-only and --skip-nas flags work correctly
