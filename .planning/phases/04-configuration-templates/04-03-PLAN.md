---
phase: 04-configuration-templates
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - helm-chart/file-simulator/examples/deployments/multi-mount-example.yaml
  - helm-chart/file-simulator/examples/deployments/README.md
  - helm-chart/file-simulator/docs/NAS-INTEGRATION-GUIDE.md
autonomous: true

must_haves:
  truths:
    - "Example deployment mounts 6 NAS servers simultaneously (3 input + 3 output)"
    - "Example deployment uses PVC names from 04-01"
    - "Example deployment references ConfigMap from 04-02"
    - "Integration guide explains production OCP pattern replication"
    - "Documentation covers multi-NFS mount configuration"
  artifacts:
    - path: "helm-chart/file-simulator/examples/deployments/multi-mount-example.yaml"
      provides: "Example Kubernetes deployment mounting 6 NAS servers"
      contains: "nas-input-1-pvc"
    - path: "helm-chart/file-simulator/examples/deployments/README.md"
      provides: "Deployment instructions for example"
      contains: "kubectl apply"
    - path: "helm-chart/file-simulator/docs/NAS-INTEGRATION-GUIDE.md"
      provides: "Complete integration documentation"
      contains: "PersistentVolume"
  key_links:
    - from: "multi-mount-example.yaml"
      to: "pvc/nas-input-1-pvc.yaml"
      via: "persistentVolumeClaim.claimName"
      pattern: "claimName: nas-input-1-pvc"
    - from: "multi-mount-example.yaml"
      to: "configmap/nas-endpoints-configmap.yaml"
      via: "configMapRef.name"
      pattern: "file-simulator-nas-endpoints"
---

<objective>
Create multi-NAS mount example deployment and comprehensive integration documentation

Purpose: Demonstrate production-style multi-NFS mount pattern (INT-05) and provide complete guidance for developers integrating with the NAS infrastructure. This is the capstone deliverable that ties together PVs, PVCs, ConfigMap, and Windows setup.

Output:
- Example deployment mounting 6 NAS servers (excludes read-only backup)
- README with step-by-step deployment instructions
- Comprehensive integration guide (NAS-INTEGRATION-GUIDE.md)
</objective>

<execution_context>
@C:\Users\UserC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\UserC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-configuration-templates/04-RESEARCH.md
@.planning/phases/04-configuration-templates/04-01-SUMMARY.md
@.planning/phases/04-configuration-templates/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create multi-mount example deployment</name>
  <files>helm-chart/file-simulator/examples/deployments/multi-mount-example.yaml</files>
  <action>
Create Kubernetes Deployment YAML demonstrating how to mount 6 NAS servers simultaneously.

Following the pattern from 04-RESEARCH.md, create deployment that:
- Mounts 3 input NAS servers (nas-input-1/2/3) at /mnt/input-1, /mnt/input-2, /mnt/input-3
- Mounts 3 output NAS servers (nas-output-1/2/3) at /mnt/output-1, /mnt/output-2, /mnt/output-3
- Does NOT mount nas-backup (read-only, typically not needed by applications)
- Uses ConfigMap for environment variable injection
- Demonstrates realistic mount paths

Deployment structure:
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: multi-nas-app
  namespace: default
  labels:
    app: multi-nas-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: multi-nas-app
  template:
    metadata:
      labels:
        app: multi-nas-app
    spec:
      containers:
        - name: app
          image: busybox:latest
          command: [shell script that lists all mounts then sleeps]
          volumeMounts: [6 mounts to /mnt/input-* and /mnt/output-*]
          envFrom:
            - configMapRef:
                name: file-simulator-nas-endpoints
      volumes: [6 PVC references]
```

Include detailed comment header explaining:
1. What this example demonstrates
2. Prerequisites (PVs, PVCs, ConfigMap deployed)
3. How to customize for production use
4. How to add/remove NAS mounts

The command script should:
1. Print header showing this is the multi-NAS mount example
2. List contents of each mounted directory
3. Sleep to keep pod running for inspection
  </action>
  <verify>
Verify deployment file exists:
```bash
ls helm-chart/file-simulator/examples/deployments/multi-mount-example.yaml
# Expected: file exists
```

Verify 6 volume mounts (not 7 - excludes backup):
```bash
grep -c "mountPath:" helm-chart/file-simulator/examples/deployments/multi-mount-example.yaml
# Expected: 6
```

Verify 6 PVC references:
```bash
grep -c "claimName:" helm-chart/file-simulator/examples/deployments/multi-mount-example.yaml
# Expected: 6
```

Verify ConfigMap reference:
```bash
grep -c "file-simulator-nas-endpoints" helm-chart/file-simulator/examples/deployments/multi-mount-example.yaml
# Expected: 1
```

Validate deployment syntax:
```bash
kubectl apply --dry-run=client -f helm-chart/file-simulator/examples/deployments/multi-mount-example.yaml
# Expected: deployment.apps/multi-nas-app created (dry run)
```
  </verify>
  <done>
Multi-mount example deployment YAML exists with 6 NAS volume mounts, ConfigMap reference, passes kubectl dry-run validation
  </done>
</task>

<task type="auto">
  <name>Task 2: Create deployment README with step-by-step instructions</name>
  <files>helm-chart/file-simulator/examples/deployments/README.md</files>
  <action>
Create README.md with complete deployment instructions for the multi-mount example.

README structure:
1. Overview - What this example demonstrates
2. Prerequisites - What must be deployed first
3. Step-by-step deployment instructions
4. Verification commands
5. Troubleshooting guide
6. Customization tips

Content must include:

## Deploying the Multi-NAS Example

### Prerequisites
1. File Simulator Suite deployed (Phase 1-3 complete)
2. All 7 NAS servers running in file-simulator namespace
3. Windows directories created (run setup-windows.ps1)

### Step 1: Apply PersistentVolumes
```bash
kubectl apply -f ../pv/
kubectl get pv -l type=nfs
# Expected: 7 PVs in Available state
```

### Step 2: Apply PersistentVolumeClaims
```bash
kubectl apply -f ../pvc/ -n default
kubectl get pvc -n default
# Expected: 7 PVCs in Bound state
```

### Step 3: Apply ConfigMap
```bash
# Optionally update MINIKUBE_IP first
kubectl apply -f ../configmap/ -n default
kubectl get configmap file-simulator-nas-endpoints -n default
```

### Step 4: Deploy Example Application
```bash
kubectl apply -f multi-mount-example.yaml -n default
kubectl get pod -n default -l app=multi-nas-app
# Expected: Pod in Running state
```

### Step 5: Verify Multi-Mount
```bash
kubectl logs -n default -l app=multi-nas-app
# Expected: Lists showing contents of all 6 NAS mounts
```

### Troubleshooting
- PVC Pending: Check PV labels match PVC selector
- Mount fails: Verify NAS pods running in file-simulator namespace
- Empty mounts: Check Windows directories exist and contain files
  </action>
  <verify>
Verify README exists:
```bash
ls helm-chart/file-simulator/examples/deployments/README.md
# Expected: file exists
```

Verify key sections exist:
```bash
grep -c "Prerequisites\|Step 1\|Step 2\|Step 3\|Step 4\|Step 5\|Troubleshooting" helm-chart/file-simulator/examples/deployments/README.md
# Expected: 7+ matches
```

Verify kubectl commands documented:
```bash
grep -c "kubectl apply" helm-chart/file-simulator/examples/deployments/README.md
# Expected: 4+ (PV, PVC, ConfigMap, Deployment)
```
  </verify>
  <done>
README.md exists with complete step-by-step deployment instructions, verification commands, and troubleshooting guide
  </done>
</task>

<task type="auto">
  <name>Task 3: Create comprehensive NAS integration guide</name>
  <files>helm-chart/file-simulator/docs/NAS-INTEGRATION-GUIDE.md</files>
  <action>
Create comprehensive integration documentation (NAS-INTEGRATION-GUIDE.md) that serves as the authoritative reference for developers integrating with the NAS infrastructure.

Document structure:

# NAS Integration Guide

## Overview
- What the NAS infrastructure provides
- How it replicates production OCP patterns
- When to use PV/PVC vs direct NFS mount

## Architecture
- Diagram showing 7 NAS servers
- Role of each server type (input/backup/output)
- How Windows directories map to NFS exports

## Quick Start
- Minimal steps to mount a single NAS server
- Reference to full multi-mount example

## Configuration Templates Reference

### PersistentVolumes
- Location: examples/pv/
- What each PV provides
- Label schema explanation
- How to customize capacity

### PersistentVolumeClaims
- Location: examples/pvc/
- Namespace considerations
- Selector binding mechanism
- How to deploy to different namespace

### ConfigMap
- Location: examples/configmap/
- Environment variable naming convention
- How to substitute MINIKUBE_IP
- Usage with envFrom

### Example Deployment
- Location: examples/deployments/
- What the example demonstrates
- How to adapt for production

## Production OCP Pattern Replication (INT-02)
- Why static provisioning matches OCP
- How labels enable reliable binding
- Reclaim policy considerations
- Capacity planning notes

## Multi-NFS Mount Patterns (INT-05)
- Mounting multiple NAS servers simultaneously
- Mount path conventions
- readOnly flag usage
- Subdirectory mounts

## Windows Directory Setup
- Running setup-windows.ps1
- Directory structure created
- How init containers sync files

## Troubleshooting
- Common issues and solutions
- Diagnostic commands
- Log locations

## Reference
- NAS server DNS names
- NodePort mappings
- File paths

Target length: 200-300 lines of comprehensive documentation.
  </action>
  <verify>
Verify integration guide exists:
```bash
ls helm-chart/file-simulator/docs/NAS-INTEGRATION-GUIDE.md
# Expected: file exists
```

Verify key sections exist:
```bash
grep -c "## " helm-chart/file-simulator/docs/NAS-INTEGRATION-GUIDE.md
# Expected: 10+ section headers
```

Verify INT-02 coverage (production OCP patterns):
```bash
grep -c "production\|OCP\|static provisioning" helm-chart/file-simulator/docs/NAS-INTEGRATION-GUIDE.md
# Expected: 5+ matches
```

Verify INT-05 coverage (multi-mount):
```bash
grep -c "multi.*mount\|multiple.*NAS\|simultaneously" helm-chart/file-simulator/docs/NAS-INTEGRATION-GUIDE.md
# Expected: 3+ matches
```

Verify document length:
```bash
wc -l helm-chart/file-simulator/docs/NAS-INTEGRATION-GUIDE.md
# Expected: 150-350 lines
```
  </verify>
  <done>
NAS-INTEGRATION-GUIDE.md exists with comprehensive documentation covering PV/PVC patterns, ConfigMap usage, multi-mount configuration, production OCP replication, and troubleshooting
  </done>
</task>

</tasks>

<verification>
## Overall Verification

1. Example deployment requirements met:
   - Mounts 6 NAS servers (3 input + 3 output)
   - References correct PVC names from 04-01
   - Uses ConfigMap from 04-02
   - Passes kubectl dry-run validation

2. README requirements met:
   - Step-by-step deployment instructions
   - Verification commands for each step
   - Troubleshooting section

3. Integration guide requirements met:
   - Explains production OCP pattern replication (INT-02)
   - Covers multi-NFS mount configuration (INT-05)
   - References all example files
   - Comprehensive enough to be standalone reference
</verification>

<success_criteria>
- [ ] multi-mount-example.yaml mounts 6 NAS servers simultaneously
- [ ] Example uses PVC names from 04-01 (nas-input-*-pvc, nas-output-*-pvc)
- [ ] Example references ConfigMap from 04-02 (file-simulator-nas-endpoints)
- [ ] README.md provides complete deployment instructions
- [ ] NAS-INTEGRATION-GUIDE.md covers INT-02 (production OCP patterns)
- [ ] NAS-INTEGRATION-GUIDE.md covers INT-05 (multi-mount configuration)
- [ ] All YAML files pass kubectl dry-run validation
</success_criteria>

<output>
After completion, create `.planning/phases/04-configuration-templates/04-03-SUMMARY.md`
</output>
