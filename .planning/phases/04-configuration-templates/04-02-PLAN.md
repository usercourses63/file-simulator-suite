---
phase: 04-configuration-templates
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - helm-chart/file-simulator/examples/configmap/nas-endpoints-configmap.yaml
  - scripts/setup-windows.ps1
autonomous: true

must_haves:
  truths:
    - "ConfigMap contains service discovery endpoints for all 7 NAS servers"
    - "ConfigMap includes DNS names, ports, NodePorts, and PVC names"
    - "setup-windows.ps1 creates all 7 NAS directories automatically"
    - "setup-windows.ps1 creates README.txt in each NAS directory"
  artifacts:
    - path: "helm-chart/file-simulator/examples/configmap/nas-endpoints-configmap.yaml"
      provides: "Service discovery ConfigMap for all 7 NAS servers"
      contains: "NAS_INPUT_1_HOST"
    - path: "scripts/setup-windows.ps1"
      provides: "Windows setup script with NAS directory creation"
      contains: "nas-input-1"
  key_links:
    - from: "configmap/nas-endpoints-configmap.yaml"
      to: "values-multi-nas.yaml"
      via: "NAS server names and NodePorts"
      pattern: "NAS_.*_NODEPORT"
---

<objective>
Create service discovery ConfigMap and enhance Windows setup script for NAS directory automation

Purpose: Provide applications with centralized connection details (ConfigMap) and ensure Windows environment has all 7 NAS directories created before Minikube deployment (script enhancement).

Output:
- ConfigMap YAML with all 7 NAS endpoints
- Enhanced setup-windows.ps1 with NAS directory creation
</objective>

<execution_context>
@C:\Users\UserC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\UserC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-configuration-templates/04-RESEARCH.md
@helm-chart/file-simulator/values-multi-nas.yaml
@scripts/setup-windows.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NAS endpoints ConfigMap</name>
  <files>helm-chart/file-simulator/examples/configmap/nas-endpoints-configmap.yaml</files>
  <action>
Create ConfigMap YAML following the pattern from 04-RESEARCH.md.

ConfigMap structure:
- apiVersion: v1
- kind: ConfigMap
- metadata.name: file-simulator-nas-endpoints
- metadata.namespace: default (users deploy to their namespace)
- data: All NAS server connection details

Data fields for EACH of the 7 NAS servers:
- NAS_{NAME}_HOST: DNS name (file-sim-nas-{name}.file-simulator.svc.cluster.local)
- NAS_{NAME}_PORT: "2049" (NFS port)
- NAS_{NAME}_PATH: "/data" (unfs3 export path)
- NAS_{NAME}_NODEPORT: NodePort from values-multi-nas.yaml
- NAS_{NAME}_PVC: PVC name ({nas-name}-pvc)

Server mapping from values-multi-nas.yaml:
- nas-input-1: NodePort 32150
- nas-input-2: NodePort 32151
- nas-input-3: NodePort 32152
- nas-backup: NodePort 32153
- nas-output-1: NodePort 32154
- nas-output-2: NodePort 32155
- nas-output-3: NodePort 32156

Additional metadata fields:
- NAS_COUNT: "7"
- NAS_NAMESPACE: "file-simulator"
- MINIKUBE_IP: "<minikube-ip>" (placeholder, user substitutes)

Include comment header explaining:
1. Purpose of ConfigMap
2. How to deploy to application namespace
3. How to substitute MINIKUBE_IP placeholder
4. Usage example with envFrom
  </action>
  <verify>
Verify ConfigMap file exists:
```bash
ls helm-chart/file-simulator/examples/configmap/nas-endpoints-configmap.yaml
# Expected: file exists
```

Verify all 7 NAS servers have entries:
```bash
grep -c "NAS_.*_HOST:" helm-chart/file-simulator/examples/configmap/nas-endpoints-configmap.yaml
# Expected: 7
```

Verify NodePorts match values-multi-nas.yaml:
```bash
grep "NODEPORT" helm-chart/file-simulator/examples/configmap/nas-endpoints-configmap.yaml
# Expected: 7 entries with ports 32150-32156
```

Validate ConfigMap syntax:
```bash
kubectl apply --dry-run=client -f helm-chart/file-simulator/examples/configmap/nas-endpoints-configmap.yaml
# Expected: configmap/file-simulator-nas-endpoints created (dry run)
```
  </verify>
  <done>
ConfigMap YAML exists with all 7 NAS server endpoints, NodePorts matching values-multi-nas.yaml, passes kubectl dry-run validation
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance setup-windows.ps1 with NAS directory creation</name>
  <files>scripts/setup-windows.ps1</files>
  <action>
Modify existing setup-windows.ps1 to add NAS directory creation after the existing directory creation block.

Changes to make:
1. Add new step "[X/Y] Creating NAS server directories..." after existing directory creation
2. Create 7 NAS directories: nas-input-1, nas-input-2, nas-input-3, nas-backup, nas-output-1, nas-output-2, nas-output-3
3. Create README.txt in each NAS directory with purpose description
4. Update summary output to show NAS directory structure
5. Keep all existing functionality intact (FTP, SFTP, S3, SMB helper scripts)

NAS directory creation code (insert after line 34, existing directory creation):
```powershell
# NAS Server directories (Phase 4: Configuration Templates)
Write-Host "`n[X/Y] Creating NAS server directories..." -ForegroundColor Yellow

$nasServers = @(
    @{ name = "nas-input-1"; role = "Input files for processing" },
    @{ name = "nas-input-2"; role = "Input files for processing" },
    @{ name = "nas-input-3"; role = "Input files for processing" },
    @{ name = "nas-backup"; role = "Backup storage (read-only export)" },
    @{ name = "nas-output-1"; role = "Output files from processing" },
    @{ name = "nas-output-2"; role = "Output files from processing" },
    @{ name = "nas-output-3"; role = "Output files from processing" }
)

foreach ($nas in $nasServers) {
    $dir = "$SimulatorPath\$($nas.name)"
    if (-not (Test-Path $dir)) {
        New-Item -ItemType Directory -Path $dir -Force | Out-Null
        Write-Host "  Created: $dir" -ForegroundColor Green

        # Create README.txt with purpose
        $readme = @"
NAS Server: $($nas.name)
Created: $(Get-Date)
Purpose: $($nas.role)

This directory is mounted into the $($nas.name) NAS server pod.
Files placed here will be available via NFS mount after pod restart.
"@
        Set-Content -Path "$dir\README.txt" -Value $readme
    } else {
        Write-Host "  Exists: $dir" -ForegroundColor Gray
    }
}
```

Update step numbers throughout script (will change from 5 to 6 steps).

Update summary section to include NAS directories:
```
Directory Structure:
  $SimulatorPath\
  ├── input\       <- General input files
  ├── output\      <- General output files
  ├── temp\        <- Temporary files
  ├── config\      <- Helper scripts
  ├── nas-input-1\ <- NAS input server 1
  ├── nas-input-2\ <- NAS input server 2
  ├── nas-input-3\ <- NAS input server 3
  ├── nas-backup\  <- NAS backup server (read-only)
  ├── nas-output-1\<- NAS output server 1
  ├── nas-output-2\<- NAS output server 2
  └── nas-output-3\<- NAS output server 3
```
  </action>
  <verify>
Verify NAS servers array in script:
```bash
grep -c "nas-input" scripts/setup-windows.ps1
# Expected: at least 3 (nas-input-1, nas-input-2, nas-input-3)
```

Verify all 7 NAS directories referenced:
```bash
grep -E "nas-(input|output|backup)" scripts/setup-windows.ps1 | grep -c "name"
# Expected: 7
```

Verify README creation code exists:
```bash
grep -c "README.txt" scripts/setup-windows.ps1
# Expected: at least 1
```

Test script syntax (PowerShell):
```powershell
$null = [System.Management.Automation.PSParser]::Tokenize((Get-Content scripts/setup-windows.ps1 -Raw), [ref]$null)
# Expected: No errors (empty output)
```
  </verify>
  <done>
setup-windows.ps1 enhanced with NAS directory creation for all 7 servers, README.txt generation, and updated directory structure summary
  </done>
</task>

</tasks>

<verification>
## Overall Verification

1. ConfigMap requirements met:
   - Contains all 7 NAS server endpoints
   - DNS names follow pattern: file-sim-nas-{name}.file-simulator.svc.cluster.local
   - NodePorts match values-multi-nas.yaml (32150-32156)
   - Includes PVC name references
   - Passes kubectl dry-run validation

2. setup-windows.ps1 requirements met:
   - Creates all 7 NAS directories
   - Creates README.txt in each directory
   - Preserves all existing functionality
   - Updated step numbering
   - No PowerShell syntax errors
</verification>

<success_criteria>
- [ ] ConfigMap YAML created with all 7 NAS endpoints
- [ ] ConfigMap includes DNS, PORT, PATH, NODEPORT, PVC for each server
- [ ] ConfigMap passes kubectl --dry-run=client validation
- [ ] setup-windows.ps1 creates 7 NAS directories
- [ ] Each NAS directory gets README.txt with purpose description
- [ ] Existing setup-windows.ps1 functionality preserved
- [ ] PowerShell script has no syntax errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-configuration-templates/04-02-SUMMARY.md`
</output>
