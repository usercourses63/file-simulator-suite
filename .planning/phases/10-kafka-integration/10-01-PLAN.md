---
phase: 10-kafka-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - helm-chart/file-simulator/templates/kafka.yaml
  - helm-chart/file-simulator/templates/kafka-ui.yaml
  - helm-chart/file-simulator/values.yaml
autonomous: true

must_haves:
  truths:
    - "Kafka broker pod runs with ZooKeeper sidecar"
    - "ZooKeeper is ready before Kafka starts"
    - "Kafka-UI connects to broker and shows cluster"
    - "Default topics (test-events, test-commands, test-notifications) exist on startup"
  artifacts:
    - path: "helm-chart/file-simulator/templates/kafka.yaml"
      provides: "Kafka + ZooKeeper sidecar deployment"
      contains: "KAFKA_CFG_ZOOKEEPER_CONNECT"
    - path: "helm-chart/file-simulator/templates/kafka-ui.yaml"
      provides: "Kafka-UI deployment for power users"
      contains: "KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS"
    - path: "helm-chart/file-simulator/values.yaml"
      provides: "Kafka configuration section"
      contains: "kafka:"
  key_links:
    - from: "kafka.yaml"
      to: "ZooKeeper sidecar"
      via: "KAFKA_CFG_ZOOKEEPER_CONNECT=localhost:2181"
      pattern: "localhost:2181"
    - from: "kafka-ui.yaml"
      to: "Kafka broker"
      via: "KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS"
      pattern: "kafka:9092"
---

<objective>
Deploy Kafka broker with ZooKeeper sidecar and Kafka-UI management interface

Purpose: Establish Kafka infrastructure in the file-simulator namespace for pub/sub testing
Output: Running Kafka cluster accessible via NodePort, with Kafka-UI for power-user management
</objective>

<execution_context>
@C:\Users\UserC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\UserC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-kafka-integration/10-CONTEXT.md
@.planning/phases/10-kafka-integration/10-RESEARCH.md
@helm-chart/file-simulator/values.yaml
@helm-chart/file-simulator/templates/s3.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Kafka Helm template with ZooKeeper sidecar</name>
  <files>helm-chart/file-simulator/templates/kafka.yaml</files>
  <action>
Create Kafka deployment with ZooKeeper as sidecar container in same pod. Follow existing helm template patterns from s3.yaml.

**Pod structure:**
1. ZooKeeper container (bitnami/zookeeper:3.9):
   - Port: 2181
   - ZOO_HEAP_SIZE: "128" (128MB heap)
   - Memory: requests 256Mi, limits 512Mi
   - Readiness probe: `echo "ruok" | nc localhost 2181 | grep imok`

2. Kafka container (bitnami/kafka:3.7):
   - Ports: 9092 (internal PLAINTEXT), 9094 (external PLAINTEXT)
   - KAFKA_CFG_ZOOKEEPER_CONNECT: localhost:2181
   - KAFKA_CFG_LISTENERS: PLAINTEXT://:9092,EXTERNAL://:9094
   - KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,EXTERNAL://$(NODE_IP):30092
   - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
   - KAFKA_CFG_INTER_BROKER_LISTENER_NAME: PLAINTEXT
   - KAFKA_HEAP_OPTS: "-Xmx512m -Xms512m"
   - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE: "false" (explicit topic creation)
   - KAFKA_CFG_LOG_RETENTION_MS: "86400000" (24h retention)
   - Memory: requests 768Mi, limits 1536Mi
   - Startup probe waiting for ZooKeeper (checks localhost:2181)

**Service:**
- Type: NodePort
- Port 9092 (internal) -> nodePort 30092
- Port 9094 (external) -> nodePort 30094

**Init Job (post-install hook):**
Create default topics using kafka-topics.sh:
- test-events (3 partitions)
- test-commands (1 partition)
- test-notifications (1 partition)

Use hostPath volume for Kafka data persistence (kafka-data under controlApi.persistence.hostPath).

Include proper labels: app.kubernetes.io/component: kafka, app.kubernetes.io/part-of: file-simulator-suite
  </action>
  <verify>
`helm template file-sim helm-chart/file-simulator --set kafka.enabled=true | grep -A 50 "kind: Deployment" | grep "kafka"` shows Kafka deployment
  </verify>
  <done>
kafka.yaml template renders valid Kubernetes manifests with ZooKeeper sidecar, proper env vars, and topic init job
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Kafka-UI Helm template</name>
  <files>helm-chart/file-simulator/templates/kafka-ui.yaml</files>
  <action>
Create Kafka-UI deployment (provectuslabs/kafka-ui) following existing patterns.

**Deployment:**
- Image: provectuslabs/kafka-ui:latest
- Port: 8080
- Environment:
  - KAFKA_CLUSTERS_0_NAME: file-simulator
  - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: {{ fullname }}-kafka:9092
  - DYNAMIC_CONFIG_ENABLED: "true"
  - SERVER_PORT: "8080"
- Memory: requests 256Mi, limits 512Mi
- Liveness/readiness probes on /actuator/health

**Service:**
- Type: NodePort
- Port 8080 -> nodePort 30093

Use conditional `{{- if .Values.kafkaUi.enabled }}` wrapper.
  </action>
  <verify>
`helm template file-sim helm-chart/file-simulator --set kafkaUi.enabled=true | grep -A 30 "kafka-ui"` shows deployment
  </verify>
  <done>
kafka-ui.yaml template renders valid Kubernetes manifests with correct Kafka bootstrap server configuration
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Kafka configuration to values.yaml</name>
  <files>helm-chart/file-simulator/values.yaml</files>
  <action>
Add kafka and kafkaUi sections to values.yaml following existing pattern.

**Add after controlApi section:**

```yaml
# ============================================
# Kafka Message Broker (with ZooKeeper sidecar)
# ============================================
kafka:
  enabled: true

  image:
    repository: bitnami/kafka
    tag: "3.7"
    pullPolicy: IfNotPresent

  zookeeper:
    image:
      repository: bitnami/zookeeper
      tag: "3.9"
    heap: "128"
    resources:
      requests:
        memory: "256Mi"
        cpu: "100m"
      limits:
        memory: "512Mi"
        cpu: "500m"

  service:
    type: NodePort
    port: 9092
    nodePort: 30092
    externalPort: 9094
    externalNodePort: 30094

  heap: "512m"

  defaultTopics:
    - name: test-events
      partitions: 3
    - name: test-commands
      partitions: 1
    - name: test-notifications
      partitions: 1

  retention:
    ms: 86400000  # 24 hours

  resources:
    requests:
      memory: "768Mi"
      cpu: "200m"
    limits:
      memory: "1536Mi"
      cpu: "1"

# ============================================
# Kafka UI (Provectus)
# ============================================
kafkaUi:
  enabled: true

  image:
    repository: provectuslabs/kafka-ui
    tag: latest
    pullPolicy: IfNotPresent

  service:
    type: NodePort
    port: 8080
    nodePort: 30093

  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"
```

Also update the API root endpoint list in Program.cs context to include Kafka endpoints (this will be done in Plan 03).
  </action>
  <verify>
`helm template file-sim helm-chart/file-simulator | grep "kafka:"` shows Kafka values being used
  </verify>
  <done>
values.yaml contains complete kafka and kafkaUi configuration sections with resource limits appropriate for dev environment
  </done>
</task>

</tasks>

<verification>
1. Run `helm lint helm-chart/file-simulator` - no errors
2. Run `helm template file-sim helm-chart/file-simulator --debug` - templates render without errors
3. Kafka section appears in rendered output with ZooKeeper sidecar
4. Kafka-UI section appears with correct bootstrap server
5. Topic init job appears with correct topic names
</verification>

<success_criteria>
- Helm chart renders valid Kafka + ZooKeeper deployment
- Helm chart renders valid Kafka-UI deployment
- Default topics configured in init job
- Memory limits stay within budget (~1.5GB total for Kafka stack)
- NodePorts 30092, 30094, 30093 configured
</success_criteria>

<output>
After completion, create `.planning/phases/10-kafka-integration/10-01-SUMMARY.md`
</output>
