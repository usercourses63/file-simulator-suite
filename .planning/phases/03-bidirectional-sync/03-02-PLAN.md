---
phase: 03-bidirectional-sync
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - scripts/test-multi-nas.ps1
autonomous: false

must_haves:
  truths:
    - "Files written via NFS mount to nas-output-* appear on Windows within 60 seconds"
    - "Sidecar containers run continuously in output NAS pods (nas-output-1/2/3 only)"
    - "Input NAS pods (nas-input-1/2/3) have no sidecar containers"
    - "nas-backup has no sidecar container (read-only export)"
    - "Sidecar logs show periodic sync messages at configured interval"
    - "No sync loops or file corruption after multiple write cycles"
  artifacts:
    - path: "scripts/test-multi-nas.ps1"
      provides: "Bidirectional sync validation tests (WIN-03, WIN-05)"
      contains: "Test-NFSToWindows"
  key_links:
    - from: "scripts/test-multi-nas.ps1"
      to: "kubectl exec"
      via: "Write file to NFS, verify on Windows path"
      pattern: "Test-NFSToWindows"
    - from: "output NAS pods"
      to: "Windows directories"
      via: "sidecar rsync every 30s"
      pattern: "sync-to-windows"
---

<objective>
Deploy updated NAS topology with sidecars and validate NFS-to-Windows file synchronization.

Purpose: Verify that the sidecar pattern correctly syncs files from NFS to Windows, completing the output NAS requirement (WIN-03 - NFS-to-Windows sync within 60s).
Output: Running 7-server topology with sidecars on output servers and automated validation tests.

SCOPE CLARIFICATION (WIN-02):
WIN-02 requires "Files placed in Windows directory visible via NFS mount within 30 seconds". This phase implements NFS-to-Windows only (via sidecar). Windows-to-NFS visibility works via:
1. Init container sync at pod start (proven in Phase 2)
2. Pod restart triggers re-sync

Continuous Windows-to-NFS sync (without pod restart) would require a SECOND sidecar running in the reverse direction. This is NOT in scope for Phase 3 - the roadmap explicitly states "Sidecar rsync container runs continuously in output NAS pods" (singular direction).

For Phase 3, WIN-02 is validated by the existing init container pattern. The test script will note this limitation.
</objective>

<execution_context>
@C:\Users\UserC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\UserC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-bidirectional-sync/03-RESEARCH.md
@.planning/phases/03-bidirectional-sync/03-01-SUMMARY.md
@scripts/test-multi-nas.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deploy updated topology and verify pod status</name>
  <files>N/A (deployment verification)</files>
  <action>
Deploy the updated Helm chart:

```powershell
helm upgrade --install file-sim ./helm-chart/file-simulator `
    --kube-context=file-simulator `
    -f ./helm-chart/file-simulator/values-multi-nas.yaml `
    --namespace file-simulator
```

Wait for all pods to be ready:
```powershell
kubectl --context=file-simulator wait --for=condition=Ready pod -l simulator.protocol=nfs -n file-simulator --timeout=120s
```

Verify all 7 pods running:
```powershell
kubectl --context=file-simulator get pods -n file-simulator -l simulator.protocol=nfs --no-headers | Measure-Object | Select-Object -ExpandProperty Count
# Expected: 7
```

CRITICAL: Use --context=file-simulator for ALL kubectl commands.
  </action>
  <verify>
```powershell
$count = kubectl --context=file-simulator get pods -n file-simulator -l simulator.protocol=nfs --no-headers 2>$null | Measure-Object | Select-Object -ExpandProperty Count
if ($count -eq 7) { Write-Host "PASS: 7 pods running" } else { Write-Host "FAIL: Expected 7 pods, got $count" }
```
  </verify>
  <done>
- All 7 NAS pods running in file-simulator namespace
- Pods show STATUS=Running, READY=1/1
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify sidecar containers on output servers only</name>
  <files>N/A (deployment verification)</files>
  <action>
Verify sidecar containers are running ONLY on output servers (nas-output-1/2/3):

1. **Check output servers have sidecar running:**
```powershell
foreach ($nas in @("nas-output-1", "nas-output-2", "nas-output-3")) {
    $pod = kubectl --context=file-simulator get pod -n file-simulator `
        -l "app.kubernetes.io/component=$nas" `
        -o jsonpath='{.items[0].metadata.name}' 2>$null

    $sidecarState = kubectl --context=file-simulator get pod -n file-simulator $pod `
        -o jsonpath='{.status.initContainerStatuses[?(@.name=="sync-to-windows")].state}' 2>$null

    if ($sidecarState -match "running") {
        Write-Host "PASS: $nas has sidecar running"
    } else {
        Write-Host "FAIL: $nas sidecar not running. State: $sidecarState"
    }
}
```

2. **Verify nas-backup does NOT have sidecar (read-only export):**
```powershell
$pod = kubectl --context=file-simulator get pod -n file-simulator `
    -l "app.kubernetes.io/component=nas-backup" `
    -o jsonpath='{.items[0].metadata.name}' 2>$null

$initContainers = kubectl --context=file-simulator get pod -n file-simulator $pod `
    -o jsonpath='{.spec.initContainers[*].name}' 2>$null

if ($initContainers -notmatch "sync-to-windows") {
    Write-Host "PASS: nas-backup has no sidecar (correct - read-only export)"
} else {
    Write-Host "FAIL: nas-backup has unexpected sidecar"
}
```

3. **Verify input servers do NOT have sidecar:**
```powershell
foreach ($nas in @("nas-input-1", "nas-input-2", "nas-input-3")) {
    $pod = kubectl --context=file-simulator get pod -n file-simulator `
        -l "app.kubernetes.io/component=$nas" `
        -o jsonpath='{.items[0].metadata.name}' 2>$null

    $initContainers = kubectl --context=file-simulator get pod -n file-simulator $pod `
        -o jsonpath='{.spec.initContainers[*].name}' 2>$null

    if ($initContainers -notmatch "sync-to-windows") {
        Write-Host "PASS: $nas has no sidecar (correct)"
    } else {
        Write-Host "FAIL: $nas has unexpected sidecar"
    }
}
```

CRITICAL: Use --context=file-simulator for ALL kubectl commands.
  </action>
  <verify>
Output servers (3) show "sidecar running", input servers (3) and nas-backup show "no sidecar".
  </verify>
  <done>
- 3 output servers have sync-to-windows sidecar in running state
- 3 input servers have NO sidecar container
- nas-backup has NO sidecar container (read-only export)
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify sidecar logs show periodic sync</name>
  <files>N/A (deployment verification)</files>
  <action>
Check sidecar logs on an output server to verify sync is running:

```powershell
$pod = kubectl --context=file-simulator get pod -n file-simulator `
    -l app.kubernetes.io/component=nas-output-1 `
    -o jsonpath='{.items[0].metadata.name}'

kubectl --context=file-simulator logs -n file-simulator $pod -c sync-to-windows --tail=20
```

Expected output should show:
- "=== NAS nas-output-1 Sync Sidecar Starting ==="
- "Sync interval: 30s"
- "Direction: NFS export -> Windows mount"
- Periodic timestamps like "[HH:MM:SS] Synced to Windows in Xs"

Wait 60+ seconds and check logs again to confirm multiple sync cycles:
```powershell
Start-Sleep -Seconds 35
kubectl --context=file-simulator logs -n file-simulator $pod -c sync-to-windows --tail=5
```

Should show at least 2 sync entries with different timestamps.

CRITICAL: Use --context=file-simulator for ALL kubectl commands.
  </action>
  <verify>
Sidecar logs show startup message and at least 2 sync cycles with timestamps ~30s apart.
  </verify>
  <done>
- Sidecar logs show periodic sync messages
- Sync interval matches configured 30 seconds
- No error messages in sidecar logs
  </done>
</task>

<task type="auto">
  <name>Task 4: Add bidirectional sync validation to test script</name>
  <files>scripts/test-multi-nas.ps1</files>
  <action>
Add new test functions to scripts/test-multi-nas.ps1 for WIN-03 and WIN-05 validation:

1. **Add Test-NFSToWindows function** (WIN-03: NFS -> Windows sync):
```powershell
function Test-NFSToWindows {
    param(
        [string]$NasName,
        [int]$TimeoutSeconds = 60
    )

    $testId = Get-Date -Format "yyyyMMddHHmmss"
    $testFile = "nfs-to-windows-$testId.txt"
    $testContent = "Written via NFS at $(Get-Date)"
    $windowsPath = "C:\simulator-data\$NasName\$testFile"

    Write-Host "  Testing WIN-03: NFS -> Windows sync for $NasName"

    # Get pod name
    $pod = kubectl --context=file-simulator get pod -n file-simulator `
        -l "app.kubernetes.io/component=$NasName" `
        -o jsonpath='{.items[0].metadata.name}'

    if (-not $pod) {
        Write-Host "  FAIL: Could not find pod for $NasName"
        return $false
    }

    # Write file to NFS export via kubectl exec
    kubectl --context=file-simulator exec -n file-simulator $pod -c nfs-server -- `
        sh -c "echo '$testContent' > /data/$testFile"

    # Wait for file to appear on Windows (up to timeout)
    $elapsed = 0
    while ($elapsed -lt $TimeoutSeconds) {
        if (Test-Path $windowsPath) {
            $windowsContent = Get-Content $windowsPath -Raw -ErrorAction SilentlyContinue
            if ($windowsContent -match $testContent.Substring(0, 20)) {
                Write-Host "  PASS: File synced to Windows in ${elapsed}s"
                # Cleanup
                Remove-Item $windowsPath -Force -ErrorAction SilentlyContinue
                kubectl --context=file-simulator exec -n file-simulator $pod -c nfs-server -- `
                    rm -f "/data/$testFile" 2>$null
                return $true
            }
        }
        Start-Sleep -Seconds 5
        $elapsed += 5
        Write-Host "    Waiting... (${elapsed}s / ${TimeoutSeconds}s)"
    }

    Write-Host "  FAIL: File not synced to Windows within ${TimeoutSeconds}s"
    return $false
}
```

2. **Add Test-SidecarRunning function** (WIN-05: Sidecar verification):
```powershell
function Test-SidecarRunning {
    param([string]$NasName)

    Write-Host "  Testing WIN-05: Sidecar running for $NasName"

    # Get pod name
    $pod = kubectl --context=file-simulator get pod -n file-simulator `
        -l "app.kubernetes.io/component=$NasName" `
        -o jsonpath='{.items[0].metadata.name}'

    # Check if sync-to-windows init container is in running state
    $sidecarState = kubectl --context=file-simulator get pod -n file-simulator $pod `
        -o jsonpath='{.status.initContainerStatuses[?(@.name=="sync-to-windows")].state}'

    if ($sidecarState -match "running") {
        Write-Host "  PASS: Sidecar running"
        return $true
    } else {
        Write-Host "  FAIL: Sidecar not running. State: $sidecarState"
        return $false
    }
}
```

3. **Add Test-NoSidecar function** (verify input/backup servers have no sidecar):
```powershell
function Test-NoSidecar {
    param([string]$NasName)

    Write-Host "  Testing: $NasName should NOT have sidecar"

    $pod = kubectl --context=file-simulator get pod -n file-simulator `
        -l "app.kubernetes.io/component=$NasName" `
        -o jsonpath='{.items[0].metadata.name}'

    $initContainers = kubectl --context=file-simulator get pod -n file-simulator $pod `
        -o jsonpath='{.spec.initContainers[*].name}'

    if ($initContainers -notmatch "sync-to-windows") {
        Write-Host "  PASS: No sidecar (correct)"
        return $true
    } else {
        Write-Host "  FAIL: Unexpected sidecar found"
        return $false
    }
}
```

4. **Add bidirectional sync test section** at end of script:
```powershell
# ============================================================================
# PHASE 3: BIDIRECTIONAL SYNC TESTS (WIN-03, WIN-05)
# ============================================================================
# Scope: NFS -> Windows sync only (via sidecar on output servers)
# WIN-02 (Windows -> NFS) uses init container pattern (requires pod restart)
# ============================================================================

Write-Host ""
Write-Host "=== Phase 3: Bidirectional Sync Validation ==="
Write-Host ""

# Test WIN-05: Sidecar running on output servers only
Write-Host "Step B1: Verify sidecars on output servers only"
$sidecarResults = @()

# Output servers SHOULD have sidecar
foreach ($nas in @("nas-output-1", "nas-output-2", "nas-output-3")) {
    $result = Test-SidecarRunning -NasName $nas
    $sidecarResults += @{ Name = $nas; Result = $result; Expected = "sidecar" }
}

# Input servers and nas-backup should NOT have sidecar
foreach ($nas in @("nas-input-1", "nas-input-2", "nas-input-3", "nas-backup")) {
    $result = Test-NoSidecar -NasName $nas
    $sidecarResults += @{ Name = $nas; Result = $result; Expected = "no-sidecar" }
}

# Test WIN-03: NFS to Windows sync (only output servers with sidecar)
Write-Host ""
Write-Host "Step B2: Test NFS -> Windows sync (WIN-03)"
$nfsToWindowsResults = @()
foreach ($nas in @("nas-output-1", "nas-output-2", "nas-output-3")) {
    $result = Test-NFSToWindows -NasName $nas -TimeoutSeconds 60
    $nfsToWindowsResults += @{ Name = $nas; Result = $result }
}

# WIN-02 note (not tested - requires pod restart or second sidecar)
Write-Host ""
Write-Host "Step B3: Windows -> NFS visibility (WIN-02)"
Write-Host "  NOTE: WIN-02 uses init container pattern (proven in Phase 2)"
Write-Host "  Continuous Windows->NFS sync would require second sidecar (not in scope)"
Write-Host "  To test: Create file on Windows, restart pod, verify via kubectl exec"

# Summary
Write-Host ""
Write-Host "=== Phase 3 Results ==="
$phase3Pass = 0
$phase3Fail = 0

foreach ($r in $sidecarResults) {
    if ($r.Result -eq $true) { $phase3Pass++ }
    else { $phase3Fail++ }
}

foreach ($r in $nfsToWindowsResults) {
    if ($r.Result -eq $true) { $phase3Pass++ }
    else { $phase3Fail++ }
}

Write-Host "PASS: $phase3Pass"
Write-Host "FAIL: $phase3Fail"
Write-Host ""
Write-Host "Phase 3 tests complete."
```

Preserve all existing test steps from Phase 2.
  </action>
  <verify>
Run the updated test script:
```powershell
./scripts/test-multi-nas.ps1
```

Verify output includes:
- "Phase 3: Bidirectional Sync Validation" section
- Step B1: Sidecar verification (3 output with sidecar, 4 without)
- Step B2: NFS -> Windows sync tests with timing
- Step B3: Note about WIN-02 scope
- Final summary with PASS/FAIL counts
  </verify>
  <done>
- test-multi-nas.ps1 has Test-NFSToWindows function
- test-multi-nas.ps1 has Test-SidecarRunning function
- test-multi-nas.ps1 has Test-NoSidecar function
- Phase 3 tests execute and report PASS/FAIL
- Existing Phase 2 tests still work
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Bidirectional sync implementation:
1. Output NAS servers (nas-output-1/2/3) now have sidecar containers
2. Sidecar continuously syncs files from NFS export to Windows directory every 30 seconds
3. nas-backup has NO sidecar (read-only export cannot receive NFS writes)
4. Input servers remain unchanged (no sidecar needed)
5. Test script validates sidecar presence and NFS -> Windows sync timing
  </what-built>
  <how-to-verify>
1. **Verify all pods running:**
   ```powershell
   kubectl --context=file-simulator get pods -n file-simulator -l simulator.protocol=nfs
   ```
   All 7 pods should show STATUS=Running, READY=1/1

2. **Check sidecar logs on an output server:**
   ```powershell
   $pod = kubectl --context=file-simulator get pod -n file-simulator -l app.kubernetes.io/component=nas-output-1 -o jsonpath='{.items[0].metadata.name}'
   kubectl --context=file-simulator logs -n file-simulator $pod -c sync-to-windows --tail=10
   ```
   Should see periodic sync messages with timestamps

3. **Verify nas-backup has NO sidecar:**
   ```powershell
   $pod = kubectl --context=file-simulator get pod -n file-simulator -l app.kubernetes.io/component=nas-backup -o jsonpath='{.items[0].metadata.name}'
   kubectl --context=file-simulator get pod -n file-simulator $pod -o jsonpath='{.spec.initContainers[*].name}'
   ```
   Should show only "sync-windows-data" (NOT "sync-to-windows")

4. **Run the full test suite:**
   ```powershell
   ./scripts/test-multi-nas.ps1
   ```
   Expected: All Phase 2 tests still pass + Phase 3 tests pass

5. **Manual NFS -> Windows sync test:**
   a. Create test file via NFS:
      ```powershell
      $pod = kubectl --context=file-simulator get pod -n file-simulator -l app.kubernetes.io/component=nas-output-1 -o jsonpath='{.items[0].metadata.name}'
      kubectl --context=file-simulator exec -n file-simulator $pod -c nfs-server -- sh -c "echo 'Test file' > /data/manual-test.txt"
      ```
   b. Wait 30-60 seconds
   c. Check Windows directory:
      ```powershell
      Get-Content C:\simulator-data\nas-output-1\manual-test.txt
      ```
   d. File should contain "Test file"

6. **Verify no sync loops:**
   Watch sidecar logs for 2+ minutes - sync should run at steady 30s intervals, not continuously.
  </how-to-verify>
  <resume-signal>Type "approved" if bidirectional sync works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 3 success criteria validation:

1. [x] System writes file via NFS to nas-output-*:/data, file appears in C:\simulator-data\nas-output-*\ within 60 seconds
   - Validated by Test-NFSToWindows function with 60s timeout

2. [x] Sidecar rsync container runs continuously in output NAS pods (nas-output-1/2/3 ONLY)
   - Validated by Test-SidecarRunning function and kubectl logs
   - nas-backup excluded (read-only export)

3. [x] Input NAS servers remain one-way sync only (no sidecar overhead)
   - Validated by Test-NoSidecar function

4. [x] Bidirectional sync interval configurable via Helm values (default 30 seconds)
   - Configured in values-multi-nas.yaml, verified in sidecar logs

5. [x] No sync loops or file corruption after multiple write cycles
   - Validated by observing steady 30s sync interval in logs

6. [NOTE] Files placed in Windows directory visible via NFS mount (WIN-02)
   - Phase 3 scope: Uses init container pattern (sync at pod start)
   - Continuous Windows->NFS would require second sidecar (future enhancement)
</verification>

<success_criteria>
- [ ] All 7 NAS pods running after deployment
- [ ] 3 output servers have sidecar container running
- [ ] 3 input servers have NO sidecar container
- [ ] nas-backup has NO sidecar container (read-only export)
- [ ] test-multi-nas.ps1 Phase 3 section executes successfully
- [ ] Manual NFS -> Windows sync verified within 60 seconds
- [ ] No sync loops observed in sidecar logs
- [ ] Human approval received
</success_criteria>

<output>
After completion, create `.planning/phases/03-bidirectional-sync/03-02-SUMMARY.md`
</output>
