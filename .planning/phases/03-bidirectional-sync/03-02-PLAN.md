---
phase: 03-bidirectional-sync
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - scripts/test-multi-nas.ps1
autonomous: false

must_haves:
  truths:
    - "Files written via NFS mount appear on Windows within 60 seconds"
    - "Files placed on Windows appear via NFS mount within 30 seconds (after pod restart)"
    - "Sidecar containers run continuously in output NAS pods"
    - "Input NAS pods have no sidecar containers"
    - "No sync loops or file corruption after multiple write cycles"
  artifacts:
    - path: "scripts/test-multi-nas.ps1"
      provides: "Bidirectional sync validation tests (WIN-02, WIN-03)"
      contains: "Test-NFSToWindows"
  key_links:
    - from: "scripts/test-multi-nas.ps1"
      to: "kubectl exec"
      via: "Write file to NFS, verify on Windows path"
      pattern: "Test-NFSToWindows"
    - from: "output NAS pods"
      to: "Windows directories"
      via: "sidecar rsync every 30s"
      pattern: "sync-to-windows"
---

<objective>
Deploy updated NAS topology with sidecars and validate bidirectional file synchronization.

Purpose: Verify that the sidecar pattern correctly syncs files from NFS to Windows, completing the output NAS requirements (WIN-02, WIN-03, WIN-05).
Output: Running 7-server topology with bidirectional sync and automated validation tests.
</objective>

<execution_context>
@C:\Users\UserC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\UserC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-bidirectional-sync/03-RESEARCH.md
@.planning/phases/03-bidirectional-sync/03-01-SUMMARY.md
@scripts/test-multi-nas.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deploy updated topology and verify sidecar containers</name>
  <files>N/A (deployment verification)</files>
  <action>
Deploy the updated Helm chart and verify sidecar containers are running:

1. **Deploy updated chart:**
```powershell
helm upgrade --install file-sim ./helm-chart/file-simulator `
    --kube-context=file-simulator `
    -f ./helm-chart/file-simulator/values-multi-nas.yaml `
    --namespace file-simulator
```

2. **Wait for all pods to be ready:**
```powershell
kubectl --context=file-simulator wait --for=condition=Ready pod -l simulator.protocol=nfs -n file-simulator --timeout=120s
```

3. **Verify sidecar containers running in output pods:**
```powershell
# Output servers should have 2 containers: nfs-server + sync-to-windows (as init container with restartPolicy: Always)
kubectl --context=file-simulator get pods -n file-simulator -l app.kubernetes.io/component=nas-output-1 -o jsonpath='{.items[0].status.initContainerStatuses[?(@.name=="sync-to-windows")].state}'
# Should show: {"running":{"startedAt":"..."}}

# Verify all 4 output/backup servers have sidecar running
foreach ($nas in @("nas-output-1", "nas-output-2", "nas-output-3", "nas-backup")) {
    kubectl --context=file-simulator get pods -n file-simulator -l "app.kubernetes.io/component=$nas" -o jsonpath='{.items[0].status.initContainerStatuses[?(@.name=="sync-to-windows")].state}'
}
```

4. **Verify input servers do NOT have sidecar:**
```powershell
# Input servers should only have sync-windows-data init container, no sync-to-windows
kubectl --context=file-simulator get pods -n file-simulator -l app.kubernetes.io/component=nas-input-1 -o jsonpath='{.items[0].spec.initContainers[*].name}'
# Should show: sync-windows-data (NOT sync-to-windows)
```

5. **Check sidecar logs:**
```powershell
# Get sidecar logs from an output server
$pod = kubectl --context=file-simulator get pod -n file-simulator -l app.kubernetes.io/component=nas-output-1 -o jsonpath='{.items[0].metadata.name}'
kubectl --context=file-simulator logs -n file-simulator $pod -c sync-to-windows --tail=20
# Should show periodic sync messages
```

CRITICAL: Use --context=file-simulator for ALL kubectl commands.
  </action>
  <verify>
```powershell
# Verify all 7 pods running
kubectl --context=file-simulator get pods -n file-simulator -l simulator.protocol=nfs --no-headers | Measure-Object | Select-Object -ExpandProperty Count
# Should return: 7

# Verify output servers have 2 init containers
kubectl --context=file-simulator get pods -n file-simulator -l app.kubernetes.io/component=nas-output-1 -o jsonpath='{range .items[0].spec.initContainers[*]}{.name}{"\n"}{end}'
# Should show: sync-windows-data, sync-to-windows
```
  </verify>
  <done>
- All 7 NAS pods running in file-simulator namespace
- Output servers (4) have sync-to-windows sidecar in running state
- Input servers (3) have only sync-windows-data init container
- Sidecar logs show periodic sync messages
  </done>
</task>

<task type="auto">
  <name>Task 2: Add bidirectional sync validation to test script</name>
  <files>scripts/test-multi-nas.ps1</files>
  <action>
Add new test functions to scripts/test-multi-nas.ps1 for WIN-02, WIN-03, WIN-05 validation:

1. **Add Test-NFSToWindows function** (WIN-03: NFS -> Windows sync):
```powershell
function Test-NFSToWindows {
    param(
        [string]$NasName,
        [int]$TimeoutSeconds = 60
    )

    $testId = Get-Date -Format "yyyyMMddHHmmss"
    $testFile = "nfs-to-windows-$testId.txt"
    $testContent = "Written via NFS at $(Get-Date)"
    $windowsPath = "C:\simulator-data\$NasName\$testFile"

    Write-Host "  Testing WIN-03: NFS -> Windows sync for $NasName"

    # Get pod name
    $pod = kubectl --context=file-simulator get pod -n file-simulator `
        -l "app.kubernetes.io/component=$NasName" `
        -o jsonpath='{.items[0].metadata.name}'

    if (-not $pod) {
        Write-Host "  FAIL: Could not find pod for $NasName"
        return $false
    }

    # Write file to NFS export via kubectl exec
    kubectl --context=file-simulator exec -n file-simulator $pod -c nfs-server -- `
        sh -c "echo '$testContent' > /data/$testFile"

    # Wait for file to appear on Windows (up to timeout)
    $elapsed = 0
    while ($elapsed -lt $TimeoutSeconds) {
        if (Test-Path $windowsPath) {
            $windowsContent = Get-Content $windowsPath -Raw -ErrorAction SilentlyContinue
            if ($windowsContent -match $testContent.Substring(0, 20)) {
                Write-Host "  PASS: File synced to Windows in ${elapsed}s"
                # Cleanup
                Remove-Item $windowsPath -Force -ErrorAction SilentlyContinue
                kubectl --context=file-simulator exec -n file-simulator $pod -c nfs-server -- `
                    rm -f "/data/$testFile" 2>$null
                return $true
            }
        }
        Start-Sleep -Seconds 5
        $elapsed += 5
        Write-Host "    Waiting... (${elapsed}s / ${TimeoutSeconds}s)"
    }

    Write-Host "  FAIL: File not synced to Windows within ${TimeoutSeconds}s"
    return $false
}
```

2. **Add Test-WindowsToNFS function** (WIN-02: Windows -> NFS visibility):
Note: This tests the existing init container pattern (Windows -> NFS on pod start).
For continuous Windows -> NFS sync, that requires pod restart to trigger init container.

```powershell
function Test-WindowsToNFS {
    param(
        [string]$NasName
    )

    $testId = Get-Date -Format "yyyyMMddHHmmss"
    $testFile = "windows-to-nfs-$testId.txt"
    $testContent = "Written on Windows at $(Get-Date)"
    $windowsPath = "C:\simulator-data\$NasName\$testFile"

    Write-Host "  Testing WIN-02: Windows -> NFS visibility for $NasName"
    Write-Host "    Note: Requires pod restart to trigger init container sync"

    # Write file to Windows directory
    New-Item -Path $windowsPath -ItemType File -Force | Out-Null
    Set-Content -Path $windowsPath -Value $testContent

    # Verify file exists on Windows
    if (-not (Test-Path $windowsPath)) {
        Write-Host "  FAIL: Could not create file on Windows"
        return $false
    }

    Write-Host "    File created on Windows: $windowsPath"
    Write-Host "    To verify NFS visibility: restart the $NasName pod"
    Write-Host "  SKIP: Pod restart required for init container sync"

    # Cleanup
    Remove-Item $windowsPath -Force -ErrorAction SilentlyContinue
    return $null  # Return null for SKIP status
}
```

3. **Add Test-SidecarRunning function** (WIN-05: Sidecar verification):
```powershell
function Test-SidecarRunning {
    param([string]$NasName)

    Write-Host "  Testing WIN-05: Sidecar running for $NasName"

    # Get pod name
    $pod = kubectl --context=file-simulator get pod -n file-simulator `
        -l "app.kubernetes.io/component=$NasName" `
        -o jsonpath='{.items[0].metadata.name}'

    # Check if sync-to-windows init container is in running state
    $sidecarState = kubectl --context=file-simulator get pod -n file-simulator $pod `
        -o jsonpath='{.status.initContainerStatuses[?(@.name=="sync-to-windows")].state}'

    if ($sidecarState -match "running") {
        Write-Host "  PASS: Sidecar running"
        return $true
    } else {
        Write-Host "  FAIL: Sidecar not running. State: $sidecarState"
        return $false
    }
}
```

4. **Add bidirectional sync test section** at end of script:
```powershell
# ============================================================================
# PHASE 3: BIDIRECTIONAL SYNC TESTS (WIN-02, WIN-03, WIN-05)
# ============================================================================

Write-Host ""
Write-Host "=== Phase 3: Bidirectional Sync Validation ==="
Write-Host ""

# Test WIN-05: Sidecar running (only output servers)
Write-Host "Step B1: Verify sidecars running on output servers"
$sidecarResults = @()
foreach ($nas in @("nas-output-1", "nas-output-2", "nas-output-3", "nas-backup")) {
    $result = Test-SidecarRunning -NasName $nas
    $sidecarResults += @{ Name = $nas; Result = $result }
}

# Test WIN-03: NFS to Windows sync (only output servers with sidecar)
Write-Host ""
Write-Host "Step B2: Test NFS -> Windows sync (WIN-03)"
$nfsToWindowsResults = @()
foreach ($nas in @("nas-output-1", "nas-output-2", "nas-output-3", "nas-backup")) {
    $result = Test-NFSToWindows -NasName $nas -TimeoutSeconds 60
    $nfsToWindowsResults += @{ Name = $nas; Result = $result }
}

# Test WIN-02: Windows to NFS (skip - requires pod restart)
Write-Host ""
Write-Host "Step B3: Windows -> NFS visibility test (WIN-02) - SKIPPED"
Write-Host "  Note: WIN-02 requires pod restart for init container sync"
Write-Host "  Manual test: Create file on Windows, restart pod, verify via kubectl exec"

# Summary
Write-Host ""
Write-Host "=== Phase 3 Results ==="
$phase3Pass = 0
$phase3Fail = 0
$phase3Skip = 0

foreach ($r in ($sidecarResults + $nfsToWindowsResults)) {
    if ($r.Result -eq $true) { $phase3Pass++ }
    elseif ($r.Result -eq $false) { $phase3Fail++ }
    else { $phase3Skip++ }
}

Write-Host "PASS: $phase3Pass"
Write-Host "FAIL: $phase3Fail"
Write-Host "SKIP: $phase3Skip"
```

Preserve all existing test steps from Phase 2.
  </action>
  <verify>
Run the updated test script:
```powershell
./scripts/test-multi-nas.ps1
```

Verify output includes:
- "Phase 3: Bidirectional Sync Validation" section
- Step B1: Sidecar running tests for 4 output servers
- Step B2: NFS -> Windows sync tests with timing
- Step B3: Note about WIN-02 skip
- Final summary with PASS/FAIL/SKIP counts
  </verify>
  <done>
- test-multi-nas.ps1 has Test-NFSToWindows function
- test-multi-nas.ps1 has Test-SidecarRunning function
- Phase 3 tests execute and report PASS/FAIL/SKIP
- Existing Phase 2 tests still work
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Bidirectional sync implementation:
1. Output NAS servers (nas-output-1/2/3, nas-backup) now have sidecar containers
2. Sidecar continuously syncs files from NFS export to Windows directory every 30 seconds
3. Test script validates sidecar presence and NFS -> Windows sync timing
  </what-built>
  <how-to-verify>
1. **Verify all pods running:**
   ```powershell
   kubectl --context=file-simulator get pods -n file-simulator -l simulator.protocol=nfs
   ```
   All 7 pods should show STATUS=Running, READY=1/1

2. **Check sidecar logs on an output server:**
   ```powershell
   $pod = kubectl --context=file-simulator get pod -n file-simulator -l app.kubernetes.io/component=nas-output-1 -o jsonpath='{.items[0].metadata.name}'
   kubectl --context=file-simulator logs -n file-simulator $pod -c sync-to-windows --tail=10
   ```
   Should see periodic sync messages with timestamps

3. **Run the full test suite:**
   ```powershell
   ./scripts/test-multi-nas.ps1
   ```
   Expected: All Phase 2 tests still pass + Phase 3 sidecar/sync tests pass

4. **Manual bidirectional sync test:**
   a. Create test file via NFS:
      ```powershell
      $pod = kubectl --context=file-simulator get pod -n file-simulator -l app.kubernetes.io/component=nas-output-1 -o jsonpath='{.items[0].metadata.name}'
      kubectl --context=file-simulator exec -n file-simulator $pod -c nfs-server -- sh -c "echo 'Test file' > /data/manual-test.txt"
      ```
   b. Wait 30-60 seconds
   c. Check Windows directory:
      ```powershell
      Get-Content C:\simulator-data\nas-output-1\manual-test.txt
      ```
   d. File should contain "Test file"

5. **Verify no sync loops:**
   Watch sidecar logs for 2+ minutes - sync should run at steady 30s intervals, not continuously.
  </how-to-verify>
  <resume-signal>Type "approved" if bidirectional sync works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 3 success criteria validation:

1. [x] System writes file via NFS to nas-output-1:/data, file appears in C:\simulator-data\nas-output-1\ within 60 seconds
   - Validated by Test-NFSToWindows function with 60s timeout

2. [x] Sidecar rsync container runs continuously in output NAS pods (nas-output-1/2/3, nas-backup)
   - Validated by Test-SidecarRunning function and kubectl logs

3. [x] Input NAS servers remain one-way sync only (no sidecar overhead)
   - Validated by checking init container count on input servers

4. [x] Bidirectional sync interval configurable via Helm values (default 30 seconds)
   - Configured in values-multi-nas.yaml, verified in sidecar logs

5. [x] No sync loops or file corruption after 100 write cycles
   - Validated by observing steady 30s sync interval in logs

6. [ ] Files placed in Windows directory visible via NFS mount within 30 seconds (WIN-02)
   - SKIP: Requires pod restart for init container; continuous Windows->NFS needs additional sidecar
</verification>

<success_criteria>
- [ ] All 7 NAS pods running after deployment
- [ ] 4 output/backup servers have sidecar container running
- [ ] 3 input servers have NO sidecar container
- [ ] test-multi-nas.ps1 Phase 3 section executes successfully
- [ ] Manual NFS -> Windows sync verified within 60 seconds
- [ ] No sync loops observed in sidecar logs
- [ ] Human approval received
</success_criteria>

<output>
After completion, create `.planning/phases/03-bidirectional-sync/03-02-SUMMARY.md`
</output>
