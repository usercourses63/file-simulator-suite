---
phase: 03-bidirectional-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - helm-chart/file-simulator/values-multi-nas.yaml
  - helm-chart/file-simulator/templates/nas-multi.yaml
autonomous: true

must_haves:
  truths:
    - "Output NAS servers (nas-output-1/2/3) have sidecar.enabled: true in values"
    - "Input NAS servers (nas-input-1/2/3) have sidecar.enabled: false in values"
    - "nas-backup has sidecar.enabled: false (read-only export cannot receive NFS writes)"
    - "Sidecar container only deploys when sidecar.enabled is true"
    - "Sync interval is configurable per NAS server"
    - "emptyDir has sizeLimit to prevent disk exhaustion"
    - "Init container uses --delete only for input NAS (server name pattern check)"
  artifacts:
    - path: "helm-chart/file-simulator/values-multi-nas.yaml"
      provides: "Sidecar configuration for all 7 NAS servers"
      contains: "sidecar:"
    - path: "helm-chart/file-simulator/templates/nas-multi.yaml"
      provides: "Conditional sidecar init container with restartPolicy: Always"
      contains: "restartPolicy: Always"
  key_links:
    - from: "values-multi-nas.yaml"
      to: "nas-multi.yaml"
      via: "Helm range loop reads $nas.sidecar.enabled"
      pattern: "\\{\\{- if \\$nas\\.sidecar\\.enabled"
    - from: "nas-multi.yaml"
      to: "emptyDir"
      via: "sizeLimit configuration"
      pattern: "sizeLimit:"
    - from: "nas-multi.yaml"
      to: "init container rsync"
      via: "Server name pattern check for --delete flag"
      pattern: "contains.*nas-input"
---

<objective>
Add Kubernetes native sidecar configuration to output NAS servers for continuous NFS-to-Windows sync.

Purpose: Enable files written via NFS mount to appear on Windows within 60 seconds, completing the bidirectional sync pattern required for output NAS servers.
Output: Updated Helm values and template files ready for deployment with conditional sidecar support.
</objective>

<execution_context>
@C:\Users\UserC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\UserC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-bidirectional-sync/03-RESEARCH.md
@helm-chart/file-simulator/values-multi-nas.yaml
@helm-chart/file-simulator/templates/nas-multi.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sidecar configuration to values-multi-nas.yaml</name>
  <files>helm-chart/file-simulator/values-multi-nas.yaml</files>
  <action>
Add sidecar configuration block to each NAS server in nasServers array:

For INPUT servers (nas-input-1, nas-input-2, nas-input-3):
```yaml
sidecar:
  enabled: false  # No reverse sync needed - Windows is source of truth
```

For OUTPUT servers (nas-output-1, nas-output-2, nas-output-3):
```yaml
sidecar:
  enabled: true   # Continuous sync NFS -> Windows
  syncInterval: 30  # Seconds between sync cycles
  image:
    repository: alpine
    tag: latest
    pullPolicy: IfNotPresent
  resources:
    requests:
      memory: "32Mi"
      cpu: "25m"
    limits:
      memory: "64Mi"
      cpu: "100m"
```

For BACKUP server (nas-backup):
```yaml
sidecar:
  enabled: false  # Read-only export (ro) - nothing can write via NFS, so no sync needed
```

IMPORTANT: nas-backup has `exportOptions: "ro"` (read-only). Since NFS clients cannot write to a read-only export, there is nothing to sync back to Windows. The sidecar would be pointless overhead.

Also add a comment block at top of nasServers section documenting:
- Total additional resources: 3 sidecars x 32Mi = 96Mi request, 192Mi limit (only output servers)
- Sidecar purpose: Continuous sync from emptyDir (NFS) to Windows hostPath
- Default interval: 30 seconds (configurable per server)
- nas-backup excluded: read-only export cannot receive NFS writes

Preserve all existing configuration (fsid, exportOptions, service ports, etc.).
  </action>
  <verify>
Run: `helm template file-sim ./helm-chart/file-simulator -f ./helm-chart/file-simulator/values-multi-nas.yaml --debug 2>&1 | head -50`
Verify no template parsing errors.
  </verify>
  <done>
- All 7 NAS servers have sidecar configuration block
- Input servers (3): sidecar.enabled: false
- Output servers (3): sidecar.enabled: true with full config
- Backup server (1): sidecar.enabled: false (read-only export)
- Resource comment documents 96Mi additional memory request (3 sidecars)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add conditional sidecar to nas-multi.yaml template</name>
  <files>helm-chart/file-simulator/templates/nas-multi.yaml</files>
  <action>
Modify nas-multi.yaml to add Kubernetes native sidecar container AFTER existing init container:

1. **Add conditional sidecar init container** (after sync-windows-data container):
```yaml
{{- if $nas.sidecar.enabled }}
        # Kubernetes native sidecar: continuous sync NFS -> Windows
        - name: sync-to-windows
          image: {{ $nas.sidecar.image.repository }}:{{ $nas.sidecar.image.tag }}
          imagePullPolicy: {{ $nas.sidecar.image.pullPolicy }}
          restartPolicy: Always  # Makes this a native sidecar (K8s 1.29+)
          command:
            - sh
            - -c
            - |
              set -e
              echo "=== NAS {{ $nas.name }} Sync Sidecar Starting ==="
              apk add --no-cache rsync

              INTERVAL={{ $nas.sidecar.syncInterval | default 30 }}
              echo "Sync interval: ${INTERVAL}s"
              echo "Direction: NFS export -> Windows mount"

              while true; do
                SYNC_START=$(date +%s)
                rsync -av --delete /nfs-data/ /windows-mount/
                SYNC_END=$(date +%s)
                SYNC_DURATION=$((SYNC_END - SYNC_START))
                echo "[$(date +%H:%M:%S)] Synced to Windows in ${SYNC_DURATION}s"
                sleep ${INTERVAL}
              done
          volumeMounts:
            - name: nfs-export
              mountPath: /nfs-data
              readOnly: true  # Sidecar only reads from NFS export
            - name: windows-data
              mountPath: /windows-mount
          securityContext:
            runAsNonRoot: false
            allowPrivilegeEscalation: false
          resources:
            {{- toYaml $nas.sidecar.resources | nindent 12 }}
{{- end }}
```

2. **Modify init container rsync command based on server NAME pattern** (not sidecar.enabled):

The init container --delete decision must be based on whether this is an INPUT server, not whether sidecar is enabled:
- INPUT servers (nas-input-*): Use --delete because Windows is source of truth
- OUTPUT servers (nas-output-*): Do NOT use --delete - preserve NFS-written files across restarts
- BACKUP server (nas-backup): Do NOT use --delete - preserve backup files

Use Helm contains function to check server name:
```yaml
{{- if contains "nas-input" $nas.name }}
              # Input NAS: delete orphans - Windows is source of truth
              rsync -av --delete /windows-mount/ /nfs-data/
{{- else }}
              # Output/Backup NAS: don't delete - preserve NFS-written files across restarts
              rsync -av /windows-mount/ /nfs-data/
{{- end }}
```

WHY this is correct:
- `sidecar.enabled` indicates whether we SYNC BACK to Windows
- The --delete decision is about whether to PRESERVE NFS-WRITTEN FILES
- These are different concerns: nas-backup has sidecar.enabled: false (nothing to sync back) but ALSO should not delete files (it's not an input server)

3. **Add sizeLimit to emptyDir volume** (best practice from research):
```yaml
        - name: nfs-export
          emptyDir:
            sizeLimit: 500Mi  # Prevent disk exhaustion; pod evicted if exceeded
```

IMPORTANT:
- Use `restartPolicy: Always` on init container to make it a native sidecar
- Sidecar starts AFTER regular init container completes
- readOnly: true on nfs-export mount in sidecar prevents accidental writes
- Keep existing probe configurations unchanged
  </action>
  <verify>
Run: `helm template file-sim ./helm-chart/file-simulator -f ./helm-chart/file-simulator/values-multi-nas.yaml --debug 2>&1`

Verify:
1. Output servers (nas-output-1, nas-output-2, nas-output-3) have sync-to-windows init container
2. Input servers (nas-input-1, nas-input-2, nas-input-3) do NOT have sync-to-windows container
3. nas-backup does NOT have sync-to-windows container (read-only export)
4. sync-to-windows has `restartPolicy: Always`
5. emptyDir has sizeLimit: 500Mi
6. Input servers use `rsync -av --delete`
7. Output and backup servers use `rsync -av` (no --delete)
8. No template parsing errors
  </verify>
  <done>
- Sidecar init container with restartPolicy: Always appears only for servers with sidecar.enabled: true (3 output servers)
- Init container uses conditional rsync based on server NAME: --delete for nas-input-*, no --delete for nas-output-* and nas-backup
- emptyDir volume has sizeLimit: 500Mi
- Template renders without errors for all 7 servers
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Template renders all 7 NAS servers without errors:
   `helm template file-sim ./helm-chart/file-simulator -f ./helm-chart/file-simulator/values-multi-nas.yaml`

2. Verify sidecar presence in output servers only (3 servers):
   `helm template ... | grep -A 5 "sync-to-windows"` shows 3 occurrences (nas-output-1/2/3 only)

3. Verify sidecar absence in input servers AND nas-backup:
   Template output for nas-input-1/2/3 and nas-backup should NOT contain "sync-to-windows"

4. Verify emptyDir sizeLimit:
   `helm template ... | grep -A 2 "nfs-export"` shows sizeLimit: 500Mi

5. Verify init container --delete logic:
   - nas-input-* pods show `rsync -av --delete`
   - nas-output-* and nas-backup pods show `rsync -av` (no --delete)
</verification>

<success_criteria>
- [ ] values-multi-nas.yaml has sidecar config for all 7 servers
- [ ] Only output servers (3) have sidecar.enabled: true
- [ ] nas-backup has sidecar.enabled: false (read-only export rationale documented)
- [ ] nas-multi.yaml has conditional sidecar using restartPolicy: Always
- [ ] Init container uses conditional --delete based on server NAME pattern (not sidecar.enabled)
- [ ] emptyDir has sizeLimit: 500Mi
- [ ] helm template renders without errors
- [ ] Sidecar appears only for output servers (3 total)
</success_criteria>

<output>
After completion, create `.planning/phases/03-bidirectional-sync/03-01-SUMMARY.md`
</output>
