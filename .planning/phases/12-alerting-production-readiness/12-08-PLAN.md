# Phase 12 Plan 08: Verify-Production.ps1 Comprehensive Testing Script

## Goal
Create comprehensive verification script that tests all endpoints, protocols (FTP/SFTP/HTTP/S3/SMB/NFS/Kafka), dynamic servers, and health checks to ensure production readiness.

## Scope

### Files to Create
- `scripts/Verify-Production.ps1` - Comprehensive production verification script

### Files to Modify
- None (all new files)

## Tasks

### Task 1: Create Script Structure
- [ ] Create `scripts/Verify-Production.ps1`
- [ ] Add parameters: [string]$Profile = "file-simulator", [switch]$IncludeDynamic (test dynamic servers too)
- [ ] Add help documentation: .SYNOPSIS, .DESCRIPTION, .PARAMETER, .EXAMPLE
- [ ] Set $ErrorActionPreference = "Continue" (don't stop on first failure, collect all results)
- [ ] Define test result tracking: $script:totalTests = 0, $script:passedTests = 0, $script:failedTests = 0
- [ ] Function Test-Endpoint: param($Name, $Url, $ExpectedStatus = 200) - returns $true/$false
- [ ] Function Write-TestResult: param($Name, $Passed, $Message) - colored output (Green/Red)
- [ ] Function Write-Section: param($Title) - section headers with decorations

### Task 2: Implement Kubernetes Tests
- [ ] Write-Section "Kubernetes Cluster"
- [ ] Test 1: Cluster status - minikube status -p $Profile, check for "Running"
- [ ] Test 2: Context accessible - kubectl --context=$Profile cluster-info
- [ ] Test 3: Namespace exists - kubectl --context=$Profile get namespace file-simulator
- [ ] Test 4: All pods running - get pods, count Running vs Total, fail if any not Running
- [ ] Test 5: All services exist - check for control-api, dashboard, ftp, sftp, http, s3, kafka services
- [ ] Display pod list with status colors
- [ ] Count tests: 5 total

### Task 3: Implement Management UI Tests
- [ ] Write-Section "Management UI (Dashboard)"
- [ ] Test 6: Dashboard health - http://file-simulator.local:30080/health
- [ ] Test 7: Dashboard root - http://file-simulator.local:30080/ (expect 200)
- [ ] Test 8: Dashboard SPA routing - http://file-simulator.local:30080/servers (expect 200, not 404)
- [ ] Test 9: Control API health - http://file-simulator.local:30500/health
- [ ] Test 10: Control API servers - http://file-simulator.local:30500/api/servers (expect JSON array)
- [ ] Test 11: Control API alerts - http://file-simulator.local:30500/api/alerts/active (expect JSON array)
- [ ] Use Invoke-WebRequest with -TimeoutSec 5, catch exceptions
- [ ] Count tests: 6 total

### Task 4: Implement Protocol Connectivity Tests
- [ ] Write-Section "Protocol Servers"
- [ ] Test 12: HTTP server - http://file-simulator.local:30088 (expect 200 or 403)
- [ ] Test 13: S3 API - http://file-simulator.local:30900/minio/health/live (MinIO health)
- [ ] Test 14: FTP port - Test-NetConnection file-simulator.local -Port 30021 (expect TcpTestSucceeded)
- [ ] Test 15: SFTP port - Test-NetConnection file-simulator.local -Port 30022
- [ ] Test 16: Kafka port - Test-NetConnection kafka.file-simulator.local -Port 30094
- [ ] Test 17: NFS port - Test-NetConnection file-simulator.local -Port 32149
- [ ] Test 18: SMB service exists - kubectl --context=$Profile get svc -n file-simulator | grep smb
- [ ] Use Test-NetConnection for TCP checks, catch failures
- [ ] Count tests: 7 total

### Task 5: Implement File Operations Tests
- [ ] Write-Section "File Operations"
- [ ] Test 19: File browse - GET http://file-simulator.local:30500/api/files?path=/ (expect JSON)
- [ ] Test 20: File upload - POST http://file-simulator.local:30500/api/files/upload with test file (expect 200)
- [ ] Test 21: File download - GET http://file-simulator.local:30500/api/files/download?path=/test-file.txt (expect 200)
- [ ] Test 22: File delete - DELETE http://file-simulator.local:30500/api/files?path=/test-file.txt (expect 200)
- [ ] Use temporary test file: $testContent = "Verification test $(Get-Date)"
- [ ] Clean up test files after tests
- [ ] Count tests: 4 total

### Task 6: Implement Kafka Tests
- [ ] Write-Section "Kafka Integration"
- [ ] Test 23: Kafka topics - GET http://file-simulator.local:30500/api/kafka/topics (expect array with default topics)
- [ ] Test 24: Kafka produce - POST http://file-simulator.local:30500/api/kafka/topics/test-events/messages with JSON body
- [ ] Test 25: Kafka consume - GET http://file-simulator.local:30500/api/kafka/topics/test-events/messages?maxMessages=10
- [ ] Test 26: Kafka consumer groups - GET http://file-simulator.local:30500/api/kafka/consumer-groups
- [ ] Use Invoke-RestMethod for JSON endpoints
- [ ] Verify test-events topic created and contains message
- [ ] Count tests: 4 total

### Task 7: Implement Dynamic Server Tests
- [ ] Write-Section "Dynamic Servers (if -IncludeDynamic)"
- [ ] Skip section if -IncludeDynamic not specified
- [ ] Test 27: Create dynamic FTP - POST http://file-simulator.local:30500/api/servers/ftp with name "test-ftp"
- [ ] Wait 30 seconds for deployment
- [ ] Test 28: Dynamic FTP exists - GET http://file-simulator.local:30500/api/servers, check for test-ftp
- [ ] Test 29: Dynamic FTP port accessible - Test-NetConnection (get port from server response)
- [ ] Test 30: Delete dynamic FTP - DELETE http://file-simulator.local:30500/api/servers/test-ftp
- [ ] Wait 15 seconds for cleanup
- [ ] Test 31: Dynamic FTP removed - GET http://file-simulator.local:30500/api/servers, verify not present
- [ ] Count tests: 5 total (only if -IncludeDynamic)

### Task 8: Implement Metrics Tests
- [ ] Write-Section "Historical Metrics"
- [ ] Test 32: Metrics query - GET http://file-simulator.local:30500/api/metrics?from=(Get-Date).AddHours(-1)&to=(Get-Date) (expect JSON)
- [ ] Test 33: Metrics stats - GET http://file-simulator.local:30500/api/metrics/stats (expect summary data)
- [ ] Verify response contains expected fields: samples, servers, timeRange
- [ ] Count tests: 2 total

### Task 9: Implement Alert Tests
- [ ] Write-Section "Alert System"
- [ ] Test 34: Active alerts - GET http://file-simulator.local:30500/api/alerts/active (expect array)
- [ ] Test 35: Alert history - GET http://file-simulator.local:30500/api/alerts/history (expect array)
- [ ] Test 36: Alert stats - GET http://file-simulator.local:30500/api/alerts/stats (expect counts)
- [ ] Test 37: Health checks - GET http://file-simulator.local:30500/health (expect Healthy status)
- [ ] Verify response format matches AlertStats model
- [ ] Count tests: 4 total

### Task 10: Generate Summary Report
- [ ] Write-Section "Verification Summary"
- [ ] Calculate pass rate: $passRate = [math]::Round(($passedTests / $totalTests) * 100, 1)
- [ ] Display: Total: $totalTests, Passed: $passedTests (Green), Failed: $failedTests (Red)
- [ ] Display: Pass Rate: $passRate%
- [ ] If $failedTests -eq 0: Write-Host "`n✓ All tests passed - Production ready!" -ForegroundColor Green
- [ ] Else: Write-Host "`n✗ $failedTests test(s) failed - Review errors above" -ForegroundColor Red
- [ ] Exit with exit code: 0 if all passed, 1 if any failed
- [ ] Add recommendation: "Run kubectl --context=$Profile logs <pod> for detailed error logs"

## Verification
```powershell
# Test script syntax
powershell -File scripts/Verify-Production.ps1 -WhatIf

# Dry-run to check structure
Get-Help scripts/Verify-Production.ps1 -Full

# Check function definitions
Select-String -Path scripts/Verify-Production.ps1 -Pattern "function Test-"
```

## Success Criteria
- [ ] Script accepts -Profile parameter for cluster selection
- [ ] Script accepts -IncludeDynamic flag for dynamic server testing
- [ ] Script continues on failures to collect all results
- [ ] Test-Endpoint function tests HTTP endpoints with timeout
- [ ] Write-TestResult function displays colored pass/fail results
- [ ] Kubernetes tests verify cluster, namespace, pods, services (5 tests)
- [ ] Management UI tests verify Dashboard and Control API (6 tests)
- [ ] Protocol tests verify FTP/SFTP/HTTP/S3/Kafka/NFS/SMB (7 tests)
- [ ] File operations tests verify upload/download/delete cycle (4 tests)
- [ ] Kafka tests verify topics, produce, consume, consumer groups (4 tests)
- [ ] Dynamic server tests verify create/list/delete cycle (5 tests, optional)
- [ ] Metrics tests verify query and stats endpoints (2 tests)
- [ ] Alert tests verify active, history, stats, health (4 tests)
- [ ] Script tracks totalTests, passedTests, failedTests counters
- [ ] Script displays summary with pass rate percentage
- [ ] Script exits 0 if all tests pass, 1 if any fail
- [ ] Script uses colored output for visual clarity
- [ ] Script sections clearly separated with headers
- [ ] Total tests: 37 without -IncludeDynamic, 42 with -IncludeDynamic

## Commit
```bash
git add scripts
git commit -m "feat(12-08): add Verify-Production.ps1 comprehensive testing script

- Add 37+ verification tests covering all components
- Test Kubernetes cluster, pods, services, namespaces
- Test Dashboard and Control API health endpoints
- Test protocol connectivity (FTP/SFTP/HTTP/S3/Kafka/NFS/SMB)
- Test file operations (upload/download/delete cycle)
- Test Kafka integration (topics/produce/consume)
- Test dynamic server lifecycle (create/list/delete)
- Test historical metrics queries
- Test alert system endpoints
- Generate summary report with pass rate
- Support -IncludeDynamic flag for extended testing
- Exit with appropriate status code (0=pass, 1=fail)

Run after Deploy-Production.ps1 to verify production readiness.

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```
