# Phase 12 Plan 01: Backend Alert Infrastructure

## Goal
Implement backend alert management system with AlertService, custom health checks, Alert entity persistence, and SignalR broadcasting for real-time notifications.

## Scope

### Files to Create
- `src/FileSimulator.ControlApi/Models/Alert.cs` - Alert domain model
- `src/FileSimulator.ControlApi/Models/AlertSeverity.cs` - Severity enum (Info/Warning/Critical)
- `src/FileSimulator.ControlApi/Data/Entities/AlertEntity.cs` - EF Core entity for alerts
- `src/FileSimulator.ControlApi/Services/AlertService.cs` - Alert management and broadcasting service
- `src/FileSimulator.ControlApi/Services/DiskSpaceHealthCheck.cs` - Custom health check for disk space
- `src/FileSimulator.ControlApi/Services/KafkaHealthCheck.cs` - Custom health check for Kafka broker
- `src/FileSimulator.ControlApi/Hubs/AlertHub.cs` - SignalR hub for alert notifications

### Files to Modify
- `src/FileSimulator.ControlApi/Data/MetricsDbContext.cs` - Add AlertEntity DbSet and configuration
- `src/FileSimulator.ControlApi/Program.cs` - Register alert services, health checks, and AlertHub

## Tasks

### Task 1: Create Alert Domain Models
- [ ] Create `Models/Alert.cs` with properties: Id (Guid), Type (string), Severity (AlertSeverity), Title, Message, Source, TriggeredAt (DateTime), ResolvedAt (DateTime?), IsResolved (bool)
- [ ] Create `Models/AlertSeverity.cs` enum with values: Info, Warning, Critical
- [ ] Create `Data/Entities/AlertEntity.cs` with same properties as Alert for EF Core persistence
- [ ] Add snake_case table/column names in entity configuration (follows Phase 9 pattern)

### Task 2: Extend MetricsDbContext for Alerts
- [ ] Add `DbSet<AlertEntity> Alerts` property to MetricsDbContext
- [ ] Configure AlertEntity in OnModelCreating: table name "alerts", primary key, column names, max lengths
- [ ] Add composite index on (Type, Source, IsResolved) for efficient alert lookup queries
- [ ] Add index on TriggeredAt for retention cleanup queries
- [ ] Add migration: `dotnet ef migrations add AddAlertEntity --project src/FileSimulator.ControlApi`

### Task 3: Implement Custom Health Checks
- [ ] Create `Services/DiskSpaceHealthCheck.cs` implementing IHealthCheck
- [ ] Use DriveInfo.AvailableFreeSpace with 1GB threshold (1024*1024*1024 bytes)
- [ ] Check path from environment variable CONTROL_DATA_PATH or default: C:\simulator-data (Windows) / /mnt/simulator-data (Linux)
- [ ] Return HealthCheckResult.Degraded when below threshold with available/total/percent data
- [ ] Create `Services/KafkaHealthCheck.cs` implementing IHealthCheck
- [ ] Use TCP connection check to Kafka broker (file-sim-file-simulator-kafka:9092)
- [ ] Return HealthCheckResult.Unhealthy if broker unreachable with exception message

### Task 4: Implement AlertService
- [ ] Create `Services/AlertService.cs` implementing IHostedService
- [ ] Inject IDbContextFactory<MetricsDbContext>, IHubContext<AlertHub>, IServiceProvider, ILogger
- [ ] Define alert thresholds: DiskSpaceThresholdBytes = 1GB, AlertRetentionPeriod = 7 days
- [ ] Start 30-second timer in StartAsync for condition checking
- [ ] Implement CheckDiskSpaceAsync: call DiskSpaceHealthCheck, raise/resolve alerts based on condition
- [ ] Implement CheckKafkaHealthAsync: call KafkaHealthCheck, raise/resolve alerts based on condition
- [ ] Implement CheckServerHealthAsync: query HealthSamples for servers with consecutive failures, raise alerts
- [ ] Implement RaiseAlertAsync: check for existing unresolved alert (Type+Source), create or update, broadcast via SignalR
- [ ] Implement ResolveAlertsAsync: mark alerts resolved, set ResolvedAt timestamp, broadcast resolution via SignalR
- [ ] Implement CleanupOldAlertsAsync: delete alerts older than AlertRetentionPeriod
- [ ] Use _logger.LogWarning for raised alerts, LogInformation for resolved alerts

### Task 5: Create AlertHub
- [ ] Create `Hubs/AlertHub.cs` inheriting Hub
- [ ] Add methods: GetActiveAlerts (returns unresolved alerts from DB), GetAlertHistory (returns last 100 alerts)
- [ ] AlertService broadcasts: "AlertTriggered" event with Alert object
- [ ] AlertService broadcasts: "AlertResolved" event with Alert object

### Task 6: Register Services in Program.cs
- [ ] Add health checks: builder.Services.AddHealthChecks().AddCheck<DiskSpaceHealthCheck>("disk_space").AddCheck<KafkaHealthCheck>("kafka")
- [ ] Add AlertService as hosted service: builder.Services.AddHostedService<AlertService>()
- [ ] Add SignalR hub mapping for AlertHub: app.MapHub<AlertHub>("/hubs/alerts")
- [ ] Add health check endpoint: app.MapHealthChecks("/health")
- [ ] Ensure EF Core migration runs on startup: using (var scope = app.Services.CreateScope()) { scope.ServiceProvider.GetRequiredService<MetricsDbContext>().Database.Migrate(); }

## Verification
```bash
# Build Control API
dotnet build src/FileSimulator.ControlApi

# Run migrations
dotnet ef database update --project src/FileSimulator.ControlApi

# Check generated SQL
cat src/FileSimulator.ControlApi/Migrations/*_AddAlertEntity.cs
```

## Success Criteria
- [ ] Alert.cs and AlertSeverity.cs exist with proper domain model
- [ ] AlertEntity configured in MetricsDbContext with snake_case naming
- [ ] DiskSpaceHealthCheck returns Degraded when disk below 1GB
- [ ] KafkaHealthCheck returns Unhealthy when broker unreachable
- [ ] AlertService hosted service starts timer and checks conditions every 30 seconds
- [ ] RaiseAlertAsync creates alerts in database and broadcasts via SignalR
- [ ] ResolveAlertsAsync marks alerts resolved when conditions clear
- [ ] CleanupOldAlertsAsync removes alerts older than 7 days
- [ ] AlertHub exposes GetActiveAlerts and GetAlertHistory methods
- [ ] Health check endpoint /health returns 200 with aggregated status

## Commit
```bash
git add src/FileSimulator.ControlApi
git commit -m "feat(12-01): add backend alert infrastructure

- Add Alert domain model and AlertEntity persistence
- Add custom health checks for disk space and Kafka
- Add AlertService hosted service with 30-second condition checking
- Add AlertHub for real-time alert notifications via SignalR
- Add 7-day alert retention with auto-cleanup
- Add /health endpoint with aggregated health check status

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```
