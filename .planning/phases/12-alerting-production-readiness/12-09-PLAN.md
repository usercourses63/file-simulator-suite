# Phase 12 Plan 09: Setup-Hosts.ps1 Enhancement with Kafka and Dynamic NAS

## Goal
Update Setup-Hosts.ps1 to add Kafka DNS entry and implement -IncludeDynamic flag for automatic dynamic NAS server discovery via connection-info API.

## Scope

### Files to Modify
- `scripts/Setup-Hosts.ps1` - Add Kafka entry and dynamic server discovery

## Tasks

### Task 1: Add Kafka Hostname
- [ ] Edit `scripts/Setup-Hosts.ps1`
- [ ] Locate $hostnames array definition (currently has file-simulator.local, api.file-simulator.local, dashboard.file-simulator.local)
- [ ] Add "kafka.$Hostname" to array (e.g., kafka.file-simulator.local)
- [ ] Update comment explaining hostnames: "Static services: main, api, dashboard, kafka"

### Task 2: Add IncludeDynamic Parameter
- [ ] Add parameter: [switch]$IncludeDynamic to param block
- [ ] Add help documentation for parameter: "Include dynamic NAS servers by querying connection-info API"
- [ ] Add example usage: ".\Setup-Hosts.ps1 -IncludeDynamic" in help

### Task 3: Implement Dynamic NAS Discovery
- [ ] After static hostnames array, add conditional: if ($IncludeDynamic) { }
- [ ] Inside block: try { $connectionInfo = Invoke-RestMethod -Uri "http://${Hostname}:30500/api/connection-info" -TimeoutSec 5 }
- [ ] Catch block: Write-Warning "Could not fetch dynamic servers from API. Skipping dynamic entries."; continue with static only
- [ ] Filter NAS servers: $dynamicNas = $connectionInfo.servers | Where-Object { $_.protocol -eq 'NFS' -and $_.isDynamic -eq $true }
- [ ] Loop through dynamic NAS: foreach ($nas in $dynamicNas) { }
- [ ] Build hostname: $nasHostname = "nas-$($nas.name).$Hostname" (e.g., nas-backup-1.file-simulator.local)
- [ ] Add to hostnames array: $hostnames += $nasHostname
- [ ] Display: Write-Host "  Added dynamic NAS: $nasHostname" -ForegroundColor Cyan
- [ ] If no dynamic NAS found: Write-Host "  No dynamic NAS servers found" -ForegroundColor Yellow

### Task 4: Update Hosts File Processing
- [ ] Verify hosts file path logic still works: $hostsPath = "$env:SystemRoot\System32\drivers\etc\hosts"
- [ ] Verify Administrator check still present: if (-not ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator))
- [ ] Verify backup logic: copy existing hosts to hosts.backup before modification
- [ ] Verify removal of old entries: filter out lines containing "# file-simulator" tag
- [ ] Verify addition of new entries: foreach hostname in $hostnames, add "$MinikubeIP $hostname # file-simulator"
- [ ] Add comment in generated entries: "# file-simulator (managed by Setup-Hosts.ps1)"

### Task 5: Add Connection-Info API Response Handling
- [ ] Document expected API response format in comments
- [ ] Expected structure: { servers: [{ name, protocol, host, port, isDynamic }] }
- [ ] Handle case where API returns empty servers array (no dynamic servers)
- [ ] Handle case where API returns error (404, 500) - catch and warn
- [ ] Handle case where Control API not yet deployed (connection refused) - catch and warn

### Task 6: Update Script Help and Examples
- [ ] Update .SYNOPSIS: "Updates Windows hosts file with file-simulator hostnames, including optional dynamic servers"
- [ ] Update .DESCRIPTION: add paragraph about -IncludeDynamic flag querying Control API
- [ ] Add .EXAMPLE: Setup-Hosts.ps1 -IncludeDynamic -Profile file-simulator
- [ ] Add .NOTES: "Dynamic servers require Control API to be deployed and accessible"
- [ ] Add .NOTES: "Run without -IncludeDynamic for faster updates with static entries only"

### Task 7: Add Verbose Output
- [ ] Add progress messages: "Checking for dynamic servers..." when -IncludeDynamic specified
- [ ] Add summary: "Added X static hostnames, Y dynamic hostnames" at end
- [ ] Add warning if Minikube IP changed: "Minikube IP changed from previous run: old -> new"
- [ ] Add note: "Hosts file updated successfully" in green on completion
- [ ] Add troubleshooting hint if API unreachable: "Ensure Control API is deployed: kubectl --context=$Profile get pods -n file-simulator"

### Task 8: Test Script Scenarios
- [ ] Test 1: Run without -IncludeDynamic (should add static entries only: file-simulator.local, api, dashboard, kafka)
- [ ] Test 2: Run with -IncludeDynamic before Control API deployed (should warn and continue with static)
- [ ] Test 3: Run with -IncludeDynamic after Control API deployed (should query API and add dynamic NAS entries)
- [ ] Test 4: Run with -IncludeDynamic when no dynamic servers exist (should warn "No dynamic NAS servers found")
- [ ] Test 5: Run without Administrator privileges (should fail with error message)
- [ ] Verify hosts file contains correct entries after each test
- [ ] Verify backup file created before modifications

## Verification
```powershell
# Test script syntax
powershell -File scripts/Setup-Hosts.ps1 -WhatIf

# Check help documentation
Get-Help scripts/Setup-Hosts.ps1 -Full

# Test without dynamic servers (static only)
.\scripts\Setup-Hosts.ps1 -Profile file-simulator

# Check hosts file content
cat C:\Windows\System32\drivers\etc\hosts | Select-String "file-simulator"

# Test with dynamic servers (requires Control API)
.\scripts\Setup-Hosts.ps1 -Profile file-simulator -IncludeDynamic
```

## Success Criteria
- [ ] kafka.file-simulator.local added to static hostnames array
- [ ] -IncludeDynamic parameter added to script
- [ ] Script queries http://file-simulator.local:30500/api/connection-info when -IncludeDynamic specified
- [ ] Script filters servers by protocol=NFS and isDynamic=true
- [ ] Script builds nas-{name}.file-simulator.local hostnames for dynamic servers
- [ ] Script adds dynamic hostnames to $hostnames array
- [ ] Script displays "Added dynamic NAS: ..." messages in cyan
- [ ] Script warns when API unreachable but continues with static entries
- [ ] Script warns when no dynamic servers found
- [ ] Hosts file contains kafka.file-simulator.local entry after run
- [ ] Hosts file contains dynamic NAS entries when -IncludeDynamic used
- [ ] Hosts file entries tagged with "# file-simulator" comment
- [ ] Backup file created before modifications
- [ ] Script requires Administrator privileges
- [ ] Help documentation updated with -IncludeDynamic examples
- [ ] Verbose output shows count of static and dynamic hostnames added

## Commit
```bash
git add scripts
git commit -m "feat(12-09): enhance Setup-Hosts.ps1 with Kafka and dynamic NAS discovery

- Add kafka.file-simulator.local to static hostnames
- Add -IncludeDynamic flag for automatic dynamic server discovery
- Query connection-info API for dynamic NAS servers
- Build nas-{name}.file-simulator.local hostnames automatically
- Handle API unreachable scenarios gracefully (warn and continue)
- Display progress messages for dynamic server discovery
- Update help documentation with -IncludeDynamic examples
- Add verbose output showing static vs dynamic hostname counts

Usage:
  Static only (fast):  .\Setup-Hosts.ps1
  With dynamic (slow): .\Setup-Hosts.ps1 -IncludeDynamic

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```
