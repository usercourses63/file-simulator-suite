# Phase 12 Plan 05: Dashboard Containerization with Multi-Stage Dockerfile

## Goal
Create production-ready Dashboard container image with multi-stage Dockerfile (Node build → nginx serve) including nginx configuration for SPA routing and health endpoint.

## Scope

### Files to Create
- `src/dashboard/Dockerfile` - Multi-stage build: Node.js compile → nginx serve
- `src/dashboard/nginx.conf` - nginx configuration for SPA routing and health endpoint
- `src/dashboard/.dockerignore` - Exclude node_modules and build artifacts

### Files to Modify
- None (all new files)

## Tasks

### Task 1: Create .dockerignore File
- [ ] Create `src/dashboard/.dockerignore`
- [ ] Exclude: node_modules, dist, build, .git, .gitignore
- [ ] Exclude: *.log, npm-debug.log*, .DS_Store
- [ ] Exclude: coverage, .env, .env.local, .vscode
- [ ] Reduce image size by excluding unnecessary files

### Task 2: Create nginx Configuration
- [ ] Create `src/dashboard/nginx.conf`
- [ ] Define server block: listen 80, server_name _, root /usr/share/nginx/html, index index.html
- [ ] Add /health endpoint: location /health { access_log off; return 200 'healthy\n'; add_header Content-Type text/plain; }
- [ ] Add static asset caching: location /assets/ { expires 1y; add_header Cache-Control "public, immutable"; }
- [ ] Add SPA routing: location / { try_files $uri $uri/ /index.html; add_header Cache-Control "no-cache, no-store, must-revalidate"; }
- [ ] Enable gzip compression: gzip on; gzip_types text/plain text/css application/json application/javascript text/xml application/xml; gzip_min_length 256;
- [ ] Add comment explaining SPA routing: "Fallback to index.html for React Router client-side routing"

### Task 3: Create Multi-Stage Dockerfile
- [ ] Create `src/dashboard/Dockerfile`
- [ ] Stage 1 (builder): FROM node:20-alpine AS builder
- [ ] Set WORKDIR /app
- [ ] Copy package files: COPY package*.json ./
- [ ] Install dependencies: RUN npm ci (clean install for reproducible builds)
- [ ] Copy source: COPY . .
- [ ] Add build ARG: ARG VITE_API_BASE_URL=http://file-simulator.local:30500
- [ ] Set ENV: ENV VITE_API_BASE_URL=$VITE_API_BASE_URL
- [ ] Build: RUN npm run build (outputs to dist/)
- [ ] Stage 2 (production): FROM nginx:alpine AS production
- [ ] Copy built assets: COPY --from=builder /app/dist /usr/share/nginx/html
- [ ] Copy nginx config: COPY nginx.conf /etc/nginx/conf.d/default.conf
- [ ] Expose port: EXPOSE 80
- [ ] Add HEALTHCHECK: --interval=30s --timeout=3s --start-period=5s --retries=3 CMD wget --quiet --tries=1 --spider http://localhost/health || exit 1
- [ ] Set CMD: CMD ["nginx", "-g", "daemon off;"]
- [ ] Add comments explaining each stage and why multi-stage reduces size

### Task 4: Test Local Docker Build
- [ ] Build image: docker build -t file-simulator-dashboard:test -f src/dashboard/Dockerfile src/dashboard/
- [ ] Check image size: docker images file-simulator-dashboard:test (should be ~25-30MB total: nginx:alpine ~8MB + dist ~15-20MB)
- [ ] Run container: docker run -d -p 8080:80 --name dashboard-test file-simulator-dashboard:test
- [ ] Test health endpoint: curl http://localhost:8080/health (should return "healthy")
- [ ] Test root: curl http://localhost:8080/ (should return HTML)
- [ ] Test SPA routing: curl http://localhost:8080/servers (should return same HTML, not 404)
- [ ] Test in browser: http://localhost:8080 (should load dashboard UI)
- [ ] Cleanup: docker stop dashboard-test && docker rm dashboard-test

### Task 5: Document Build Arguments
- [ ] Add comment block at top of Dockerfile explaining build arguments
- [ ] VITE_API_BASE_URL: API endpoint for Control API (default: http://file-simulator.local:30500)
- [ ] Example usage: docker build --build-arg VITE_API_BASE_URL=http://custom-api:5000 ...
- [ ] Document for Deploy-Production.ps1 script usage in next plan

### Task 6: Verify nginx Configuration
- [ ] Check nginx syntax (after container running): docker exec dashboard-test nginx -t
- [ ] Check nginx logs: docker logs dashboard-test (should show successful startup)
- [ ] Verify gzip enabled: curl -H "Accept-Encoding: gzip" -I http://localhost:8080/assets/*.js (should have Content-Encoding: gzip)
- [ ] Verify cache headers: curl -I http://localhost:8080/assets/*.js (should have Cache-Control: public, immutable)
- [ ] Verify HTML no-cache: curl -I http://localhost:8080/index.html (should have Cache-Control: no-cache)

## Verification
```bash
# Build dashboard image
docker build -t file-simulator-dashboard:test -f src/dashboard/Dockerfile src/dashboard/

# Check image size
docker images file-simulator-dashboard:test

# Run and test
docker run -d -p 8080:80 --name dashboard-test file-simulator-dashboard:test
curl http://localhost:8080/health
curl -I http://localhost:8080/

# Check nginx config
docker exec dashboard-test nginx -t

# Cleanup
docker stop dashboard-test && docker rm dashboard-test
```

## Success Criteria
- [ ] .dockerignore excludes node_modules and build artifacts
- [ ] nginx.conf defines /health endpoint returning 200 "healthy"
- [ ] nginx.conf uses try_files for SPA routing fallback to index.html
- [ ] nginx.conf enables gzip compression for text files
- [ ] nginx.conf sets immutable cache for /assets/, no-cache for HTML
- [ ] Dockerfile uses node:20-alpine for build stage
- [ ] Dockerfile uses nginx:alpine for production stage
- [ ] Dockerfile accepts VITE_API_BASE_URL build argument
- [ ] Dockerfile includes HEALTHCHECK using wget
- [ ] Docker build completes successfully
- [ ] Image size under 40MB (nginx:alpine ~8MB + dist ~20MB + overhead)
- [ ] Health endpoint returns 200 "healthy"
- [ ] SPA routes (e.g., /servers, /history) return index.html, not 404
- [ ] Static assets have 1-year cache headers
- [ ] HTML files have no-cache headers
- [ ] gzip compression active for JS/CSS files
- [ ] nginx config validation passes (nginx -t)

## Commit
```bash
git add src/dashboard
git commit -m "feat(12-05): add dashboard Dockerfile and nginx config

- Add multi-stage Dockerfile (Node 20-alpine build → nginx:alpine serve)
- Add nginx.conf with SPA routing and /health endpoint
- Add .dockerignore to exclude node_modules and artifacts
- Add VITE_API_BASE_URL build argument for API endpoint configuration
- Add gzip compression and cache headers
- Add HEALTHCHECK for Kubernetes readiness/liveness probes
- Optimize image size: ~25-30MB total (nginx ~8MB + dist ~20MB)

Production-ready container image for Kubernetes deployment.

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```
