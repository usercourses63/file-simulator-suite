# Phase 12 Plan 07: Deploy-Production.ps1 Automation Script

## Goal
Create comprehensive production deployment script that builds container images, pushes to local registry, deploys Helm chart, updates hosts file, and verifies deployment.

## Scope

### Files to Create
- `scripts/Deploy-Production.ps1` - Main deployment automation script
- `scripts/Build-Images.ps1` - Helper script for building and pushing images

### Files to Modify
- None (all new files)

## Tasks

### Task 1: Create Build-Images Helper Script
- [ ] Create `scripts/Build-Images.ps1`
- [ ] Add parameters: [string]$RegistryHost = "localhost:5000", [string]$DashboardApiUrl = "http://file-simulator.local:30500"
- [ ] Set $ErrorActionPreference = "Stop" (fail fast)
- [ ] Function Build-ControlApi: docker build -t $RegistryHost/file-simulator-control-api:latest -f src/FileSimulator.ControlApi/Dockerfile src/
- [ ] Check $LASTEXITCODE after each docker command, throw on failure
- [ ] Function Build-Dashboard: docker build -t $RegistryHost/file-simulator-dashboard:latest --build-arg VITE_API_BASE_URL=$DashboardApiUrl -f src/dashboard/Dockerfile src/dashboard/
- [ ] Function Push-Images: docker push for both images
- [ ] Add verbose output: Write-Host with colors (Cyan for steps, Green for success, Red for errors)
- [ ] Export functions: Export-ModuleMember -Function Build-ControlApi, Build-Dashboard, Push-Images

### Task 2: Create Deploy-Production Script Structure
- [ ] Create `scripts/Deploy-Production.ps1`
- [ ] Add parameters: [switch]$Clean (delete and recreate cluster), [string]$Profile = "file-simulator", [int]$Memory = 12288, [int]$Cpus = 4
- [ ] Add help documentation: .SYNOPSIS, .DESCRIPTION, .PARAMETER, .EXAMPLE
- [ ] Set $ErrorActionPreference = "Stop"
- [ ] Define step counter for progress tracking: $step = 1, $totalSteps = 9
- [ ] Function Write-Step: param($Message) Write-Host "`n[$step/$totalSteps] $Message" -ForegroundColor Cyan; $script:step++
- [ ] Function Test-CommandExists: param($Command) (Get-Command $Command -ErrorAction SilentlyContinue) -ne $null
- [ ] Verify prerequisites: minikube, kubectl, helm, docker (throw if missing)

### Task 3: Implement Cluster Management
- [ ] Write-Step "Managing Minikube cluster..."
- [ ] If $Clean: minikube delete -p $Profile 2>$null; Write-Host "Deleted existing cluster" -ForegroundColor Yellow
- [ ] If $Clean or cluster doesn't exist: minikube start with params
- [ ] Params: --profile $Profile, --driver=hyperv, --memory=$Memory, --cpus=$Cpus, --disk-size=20g, --mount, --mount-string="C:\simulator-data:/mnt/simulator-data"
- [ ] Check $LASTEXITCODE after start command
- [ ] Else: verify cluster running with minikube status -p $Profile; throw if not running
- [ ] Write-Host "Cluster ready" -ForegroundColor Green

### Task 4: Implement Registry Setup
- [ ] Write-Step "Setting up container registry..."
- [ ] Enable registry addon: minikube addons enable registry -p $Profile
- [ ] Start port forward in background job: Start-Job -ScriptBlock { kubectl --context=$using:Profile port-forward --namespace kube-system service/registry 5000:80 }
- [ ] Wait for registry: Start-Sleep -Seconds 5
- [ ] Test registry: Invoke-WebRequest http://localhost:5000/v2/_catalog -TimeoutSec 3 (retry up to 3 times with 2s delay)
- [ ] Store job ID for cleanup: $script:registryJob = $job
- [ ] Write-Host "Registry accessible at localhost:5000" -ForegroundColor Green

### Task 5: Implement Image Building
- [ ] Write-Step "Building Control API image..."
- [ ] Call docker build for Control API (same command as Build-Images.ps1)
- [ ] Check $LASTEXITCODE, throw "Control API build failed" on error
- [ ] Write-Step "Building Dashboard image..."
- [ ] Call docker build for Dashboard with VITE_API_BASE_URL build arg
- [ ] Check $LASTEXITCODE, throw "Dashboard build failed" on error
- [ ] Write-Step "Pushing images to registry..."
- [ ] docker push localhost:5000/file-simulator-control-api:latest
- [ ] docker push localhost:5000/file-simulator-dashboard:latest
- [ ] Check both push operations succeed
- [ ] Write-Host "Images pushed successfully" -ForegroundColor Green

### Task 6: Implement Helm Deployment
- [ ] Write-Step "Deploying Helm chart..."
- [ ] Run: helm upgrade --install file-sim ./helm-chart/file-simulator --kube-context=$Profile --namespace file-simulator --create-namespace --wait --timeout 5m
- [ ] Check $LASTEXITCODE, throw "Helm deployment failed" on error
- [ ] Wait additional 30 seconds for pods to stabilize: Start-Sleep -Seconds 30
- [ ] Write-Host "Helm chart deployed" -ForegroundColor Green

### Task 7: Implement Hosts File Update
- [ ] Write-Step "Updating hosts file..."
- [ ] Check if running as Administrator: ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
- [ ] If not admin: Write-Warning "Skipping hosts file update (requires Administrator). Run .\scripts\Setup-Hosts.ps1 manually."
- [ ] If admin: .\scripts\Setup-Hosts.ps1 -Profile $Profile
- [ ] Continue on error (hosts file update failure shouldn't block deployment)
- [ ] Write-Host "Hosts file updated" -ForegroundColor Green

### Task 8: Implement Deployment Verification
- [ ] Write-Step "Verifying deployment..."
- [ ] Get pod status: kubectl --context=$Profile get pods -n file-simulator
- [ ] Count Running pods: (kubectl --context=$Profile get pods -n file-simulator -o json | ConvertFrom-Json).items | Where-Object { $_.status.phase -eq "Running" }
- [ ] Display pod list with colors: Running (Green), Pending (Yellow), Failed (Red)
- [ ] Check service endpoints: kubectl --context=$Profile get svc -n file-simulator
- [ ] Test Control API health: try { Invoke-WebRequest http://file-simulator.local:30500/health -TimeoutSec 5 } catch { Write-Warning "Control API not ready yet" }
- [ ] Test Dashboard health: try { Invoke-WebRequest http://file-simulator.local:30080/health -TimeoutSec 5 } catch { Write-Warning "Dashboard not ready yet" }
- [ ] Write-Host "Verification complete" -ForegroundColor Green

### Task 9: Implement Cleanup and Summary
- [ ] Write-Step "Cleaning up..."
- [ ] Stop registry port-forward job: Stop-Job $registryJob; Remove-Job $registryJob
- [ ] Write-Host "`n=== Deployment Complete ===" -ForegroundColor Green
- [ ] Display access URLs:
  - Dashboard: http://file-simulator.local:30080
  - Control API: http://file-simulator.local:30500
  - Kafka: kafka.file-simulator.local:30094
- [ ] Add note: "Run .\scripts\Verify-Production.ps1 for comprehensive testing"
- [ ] Add note: "Run .\scripts\Setup-Hosts.ps1 if hosts file not updated"

### Task 10: Add Error Handling
- [ ] Wrap entire script in try/catch block
- [ ] Catch block: Write-Host "Deployment failed: $_" -ForegroundColor Red
- [ ] Finally block: cleanup registry job if exists
- [ ] Exit with appropriate exit codes: 0 for success, 1 for failure

## Verification
```powershell
# Test script syntax
powershell -File scripts/Deploy-Production.ps1 -WhatIf

# Dry-run parameter validation
Get-Help scripts/Deploy-Production.ps1 -Full

# Test prerequisites check
$ErrorActionPreference = "SilentlyContinue"
Get-Command minikube, kubectl, helm, docker
```

## Success Criteria
- [ ] Build-Images.ps1 provides reusable image building functions
- [ ] Deploy-Production.ps1 accepts -Clean flag for cluster recreation
- [ ] Deploy-Production.ps1 accepts -Memory and -Cpus parameters
- [ ] Script verifies prerequisites (minikube, kubectl, helm, docker) exist
- [ ] Script handles missing cluster (prompts to use -Clean)
- [ ] Script enables registry addon and port-forwards to localhost:5000
- [ ] Script builds Control API image and handles build failures
- [ ] Script builds Dashboard image with VITE_API_BASE_URL build arg
- [ ] Script pushes both images to local registry
- [ ] Script deploys Helm chart with --wait flag
- [ ] Script updates hosts file when running as Administrator
- [ ] Script warns when not Administrator (skips hosts update)
- [ ] Script verifies pod status and displays Running/Pending/Failed
- [ ] Script tests Control API and Dashboard health endpoints
- [ ] Script cleans up registry port-forward job on completion
- [ ] Script displays access URLs on success
- [ ] Script fails fast on errors ($ErrorActionPreference = "Stop")
- [ ] Script shows progress with step numbers (1/9, 2/9, etc.)
- [ ] Script uses colored output (Cyan/Green/Yellow/Red)
- [ ] Exit code 0 on success, 1 on failure

## Commit
```bash
git add scripts
git commit -m "feat(12-07): add Deploy-Production.ps1 automation script

- Add comprehensive deployment automation script
- Add Build-Images.ps1 helper for container builds
- Support -Clean flag for cluster recreation
- Enable registry addon and push images to localhost:5000
- Build Control API and Dashboard images with proper build args
- Deploy Helm chart with wait and timeout
- Update hosts file when running as Administrator
- Verify deployment: pod status + health checks
- Display access URLs on success
- Fail fast with colored error messages
- Clean up background jobs on exit

Single command deployment: .\scripts\Deploy-Production.ps1

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```
