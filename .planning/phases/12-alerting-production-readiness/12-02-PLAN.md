# Phase 12 Plan 02: Alert REST API and Redis Backplane

## Goal
Create REST endpoints for alert history queries and add optional Redis backplane for SignalR scale-out (disabled by default, ready for multi-replica deployment).

## Scope

### Files to Create
- `src/FileSimulator.ControlApi/Controllers/AlertsController.cs` - REST API for alert queries
- `helm-chart/file-simulator/templates/redis.yaml` - Redis deployment and service (optional)

### Files to Modify
- `src/FileSimulator.ControlApi/FileSimulator.ControlApi.csproj` - Add Redis NuGet package
- `src/FileSimulator.ControlApi/Program.cs` - Configure Redis backplane when enabled
- `helm-chart/file-simulator/values.yaml` - Add Redis configuration (disabled by default)

## Tasks

### Task 1: Add Redis NuGet Package
- [ ] Add package: `dotnet add src/FileSimulator.ControlApi package Microsoft.AspNetCore.SignalR.StackExchangeRedis --version 9.0.0`
- [ ] Verify StackExchange.Redis transitive dependency appears in csproj

### Task 2: Create Alerts REST Controller
- [ ] Create `Controllers/AlertsController.cs` with [ApiController] and [Route("api/alerts")]
- [ ] Inject IDbContextFactory<MetricsDbContext> and ILogger
- [ ] Add GET endpoint: /api/alerts/active - returns unresolved alerts ordered by TriggeredAt descending
- [ ] Add GET endpoint: /api/alerts/history - returns last 100 alerts with optional ?severity filter
- [ ] Add GET endpoint: /api/alerts/{id} - returns specific alert by ID
- [ ] Add GET endpoint: /api/alerts/stats - returns alert counts by severity and type in last 24 hours
- [ ] Use async/await pattern with CancellationToken
- [ ] Return 404 NotFound for missing alert ID, 200 Ok with data otherwise
- [ ] Add Swagger/OpenAPI documentation attributes: [ProducesResponseType], [SwaggerOperation]

### Task 3: Configure Redis Backplane in Program.cs
- [ ] After AddSignalR(), check if Redis connection string exists: var redisConnection = builder.Configuration.GetConnectionString("Redis")
- [ ] If redisConnection not null/empty: builder.Services.AddSignalR().AddStackExchangeRedis(redisConnection, options => { options.Configuration.ChannelPrefix = RedisChannel.Literal("FileSimulator"); })
- [ ] Else: builder.Services.AddSignalR() (default in-memory backplane)
- [ ] Log enabled state: _logger.LogInformation("SignalR backplane: {Mode}", redisConnection != null ? "Redis" : "In-memory")
- [ ] Add connection string to appsettings.json: "ConnectionStrings": { "Redis": "file-sim-file-simulator-redis:6379" }
- [ ] Make Redis optional: connection string empty by default, only set when redis.enabled=true in Helm

### Task 4: Create Redis Helm Template
- [ ] Create `helm-chart/file-simulator/templates/redis.yaml`
- [ ] Add conditional: {{- if .Values.redis.enabled }}
- [ ] Define Deployment: name includes fullname helper, namespace, labels for component: redis
- [ ] Use image: redis:7-alpine (smallest production image)
- [ ] Single replica (StatefulSet not needed for ephemeral cache)
- [ ] Container port 6379, name: redis
- [ ] Resources: requests 64Mi/50m, limits 256Mi/200m (minimal for dev use)
- [ ] No persistence volume (cache only, acceptable data loss on restart)
- [ ] Define Service: ClusterIP type, port 6379 -> redis
- [ ] Selector matches deployment labels
- [ ] Add health check: livenessProbe with redis-cli ping command

### Task 5: Add Redis Configuration to values.yaml
- [ ] Add top-level section after kafkaUi
- [ ] redis.enabled: false (disabled by default)
- [ ] redis.image.repository: redis
- [ ] redis.image.tag: "7-alpine"
- [ ] redis.image.pullPolicy: IfNotPresent
- [ ] redis.service.type: ClusterIP
- [ ] redis.service.port: 6379
- [ ] redis.resources.requests: memory 64Mi, cpu 50m
- [ ] redis.resources.limits: memory 256Mi, cpu 200m
- [ ] Add comment: "Optional Redis backplane for SignalR scale-out. Enable when running multiple Control API replicas."

### Task 6: Update Control API Helm Template for Redis
- [ ] Edit `helm-chart/file-simulator/templates/control-api.yaml`
- [ ] Add environment variable to container env section: {{- if .Values.redis.enabled }}
- [ ] ConnectionStrings__Redis: "{{ include \"file-simulator.fullname\" . }}-redis:6379"
- [ ] {{- end }}
- [ ] This makes Redis connection string available only when Redis enabled

## Verification
```bash
# Build Control API with Redis package
dotnet build src/FileSimulator.ControlApi

# Check Redis package installed
dotnet list src/FileSimulator.ControlApi package | grep StackExchangeRedis

# Helm template dry-run (Redis disabled)
helm template file-sim ./helm-chart/file-simulator --set redis.enabled=false | grep -A 5 redis

# Helm template dry-run (Redis enabled)
helm template file-sim ./helm-chart/file-simulator --set redis.enabled=true | grep -A 20 "kind: Deployment" | grep redis
```

## Success Criteria
- [ ] Microsoft.AspNetCore.SignalR.StackExchangeRedis package added to Control API project
- [ ] AlertsController provides /api/alerts/active endpoint returning unresolved alerts
- [ ] AlertsController provides /api/alerts/history endpoint with last 100 alerts
- [ ] AlertsController provides /api/alerts/stats endpoint with 24h alert counts
- [ ] Program.cs configures Redis backplane when ConnectionStrings:Redis exists
- [ ] Program.cs logs SignalR backplane mode (Redis or In-memory)
- [ ] redis.yaml template creates Deployment and Service when redis.enabled=true
- [ ] Redis deployment uses redis:7-alpine image with 64Mi request, 256Mi limit
- [ ] values.yaml has redis.enabled=false by default
- [ ] Control API Helm template injects Redis connection string when redis.enabled=true
- [ ] Helm template renders nothing for Redis when disabled

## Commit
```bash
git add src/FileSimulator.ControlApi helm-chart/file-simulator
git commit -m "feat(12-02): add alert REST API and Redis backplane

- Add AlertsController with active, history, stats endpoints
- Add Redis NuGet package for SignalR scale-out
- Add conditional Redis backplane configuration in Program.cs
- Add Redis Helm template (disabled by default)
- Add redis.enabled flag to values.yaml
- Inject Redis connection string to Control API when enabled

Redis disabled by default - enable when scaling Control API replicas >1.

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```
