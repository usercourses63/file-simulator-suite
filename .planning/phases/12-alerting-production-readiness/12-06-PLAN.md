# Phase 12 Plan 06: Helm Dashboard Deployment and NFS Fix

## Goal
Create Dashboard Helm deployment template and incorporate NFS fix directly into nas.yaml template (eliminating need for manual nfs-fix-patch.yaml).

## Scope

### Files to Create
- `helm-chart/file-simulator/templates/dashboard.yaml` - Dashboard deployment and service

### Files to Modify
- `helm-chart/file-simulator/templates/nas.yaml` - Incorporate emptyDir NFS fix
- `helm-chart/file-simulator/values.yaml` - Add dashboard configuration section

## Tasks

### Task 1: Incorporate NFS Fix into nas.yaml
- [ ] Edit `helm-chart/file-simulator/templates/nas.yaml`
- [ ] Locate volumeMounts section in nfs-server container
- [ ] Add two volume mounts: { name: nfs-data, mountPath: /data } and { name: shared-data, mountPath: /shared }
- [ ] Locate volumes section at pod spec level
- [ ] Replace existing PVC volume with two volumes: { name: nfs-data, emptyDir: {} } and { name: shared-data, persistentVolumeClaim: { claimName: {{ include "file-simulator.fullname" . }}-pvc } }
- [ ] Add comment explaining fix: "NFS exports from emptyDir (not Windows hostPath). Shared storage via /shared mount."
- [ ] Update init container to sync from /shared instead of /data: rsync -av /shared/ /data/
- [ ] Keep export configuration pointing to /data (ephemeral, NFS-compatible)
- [ ] This eliminates "exportfs: /data does not support NFS export" error

### Task 2: Add Dashboard Configuration to values.yaml
- [ ] Edit `helm-chart/file-simulator/values.yaml`
- [ ] Add dashboard section after controlApi section (before kafka)
- [ ] dashboard.enabled: true
- [ ] dashboard.image.repository: localhost:5000/file-simulator-dashboard (local registry)
- [ ] dashboard.image.tag: latest
- [ ] dashboard.image.pullPolicy: IfNotPresent
- [ ] dashboard.service.type: NodePort
- [ ] dashboard.service.port: 80
- [ ] dashboard.service.nodePort: 30080
- [ ] dashboard.apiUrl: "http://file-simulator.local:30500" (used in Dockerfile build arg)
- [ ] dashboard.resources.requests: memory 32Mi, cpu 25m
- [ ] dashboard.resources.limits: memory 128Mi, cpu 200m
- [ ] Add comment: "Dashboard runs in nginx:alpine with minimal resource footprint"

### Task 3: Create Dashboard Deployment Template
- [ ] Create `helm-chart/file-simulator/templates/dashboard.yaml`
- [ ] Add conditional: {{- if .Values.dashboard.enabled }}
- [ ] Define Deployment metadata: name includes fullname helper, namespace, labels for component: dashboard
- [ ] Add app.kubernetes.io/part-of: file-simulator-suite label
- [ ] Single replica (StatefulSet not needed for stateless UI)
- [ ] Pod template labels match selector labels
- [ ] Container spec: name dashboard, image from values, imagePullPolicy from values
- [ ] Container port 80, name: http
- [ ] Add livenessProbe: httpGet path /health, port http, initialDelaySeconds 5, periodSeconds 10
- [ ] Add readinessProbe: httpGet path /health, port http, initialDelaySeconds 5, periodSeconds 10
- [ ] Set resources from values
- [ ] No volumes needed (stateless container)
- [ ] Add security context: runAsNonRoot: true, runAsUser: 101 (nginx user)

### Task 4: Create Dashboard Service Template
- [ ] Add to same `dashboard.yaml` file after deployment (use --- separator)
- [ ] Define Service metadata: name includes fullname helper, namespace, labels
- [ ] Service type from values (NodePort)
- [ ] Port spec: port 80, targetPort http, nodePort from values (30080)
- [ ] Selector matches deployment labels (component: dashboard)
- [ ] Add comment: "NodePort 30080 for external access from Windows host"

### Task 5: Update Control API Helm Template
- [ ] Edit `helm-chart/file-simulator/templates/control-api.yaml`
- [ ] Verify image references localhost:5000/file-simulator-control-api:latest
- [ ] Ensure imagePullPolicy: IfNotPresent (pull from local registry)
- [ ] This enables Deploy-Production.ps1 to push both images to same registry

### Task 6: Test Helm Template Rendering
- [ ] Run: helm template file-sim ./helm-chart/file-simulator --debug
- [ ] Verify dashboard deployment renders with correct image, ports, health checks
- [ ] Verify dashboard service renders with NodePort 30080
- [ ] Verify nas deployment shows two volumes (nfs-data emptyDir + shared-data PVC)
- [ ] Verify nas volumeMounts show /data and /shared correctly
- [ ] Check for YAML syntax errors or missing fields
- [ ] Run: helm lint ./helm-chart/file-simulator (should pass with no errors)

## Verification
```bash
# Lint Helm chart
helm lint ./helm-chart/file-simulator

# Template dry-run
helm template file-sim ./helm-chart/file-simulator --debug > /tmp/rendered.yaml

# Check dashboard resources
grep -A 30 "kind: Deployment" /tmp/rendered.yaml | grep -A 30 "component: dashboard"

# Check NAS volumes
grep -A 20 "name: nfs-server" /tmp/rendered.yaml | grep -A 10 "volumes:"

# Verify health endpoints
grep "/health" /tmp/rendered.yaml
```

## Success Criteria
- [ ] nas.yaml template includes nfs-data emptyDir volume for /data mount
- [ ] nas.yaml template includes shared-data PVC volume for /shared mount
- [ ] nas.yaml init container syncs from /shared to /data (not /data to /data)
- [ ] nas.yaml preserves NFS export configuration for /data
- [ ] Comment in nas.yaml explains NFS fix pattern
- [ ] values.yaml includes dashboard configuration section
- [ ] dashboard.image.repository points to localhost:5000/file-simulator-dashboard
- [ ] dashboard.service.nodePort set to 30080
- [ ] dashboard.yaml defines Deployment with health checks
- [ ] dashboard.yaml defines Service with NodePort 30080
- [ ] Dashboard container runs as non-root user (101)
- [ ] Dashboard liveness and readiness probes use /health endpoint
- [ ] Dashboard resources minimal: 32Mi request, 128Mi limit
- [ ] Helm lint passes with no errors
- [ ] Helm template renders dashboard and NAS correctly
- [ ] No manual nfs-fix-patch.yaml needed after deployment

## Commit
```bash
git add helm-chart/file-simulator
git commit -m "feat(12-06): add dashboard Helm template and incorporate NFS fix

- Add dashboard deployment and service template (NodePort 30080)
- Incorporate NFS fix directly into nas.yaml template
- Use emptyDir for /data (NFS export), PVC for /shared (storage)
- Update init container to sync /shared â†’ /data
- Add dashboard configuration to values.yaml (local registry image)
- Add health check probes for dashboard container
- Eliminate need for manual nfs-fix-patch.yaml post-deployment

NFS servers will now deploy correctly without manual patching.

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```
