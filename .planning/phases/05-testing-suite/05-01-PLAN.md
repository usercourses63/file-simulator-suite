---
phase: 05-testing-suite
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/test-multi-nas.ps1
autonomous: true

must_haves:
  truths:
    - "Running ./scripts/test-multi-nas.ps1 executes all 7 NAS health checks"
    - "Running ./scripts/test-multi-nas.ps1 verifies cross-NAS isolation"
    - "Running ./scripts/test-multi-nas.ps1 tests pod restart persistence"
    - "Test script exits with code 0 when all tests pass"
    - "Test script exits with code 1 when any test fails"
  artifacts:
    - path: "scripts/test-multi-nas.ps1"
      provides: "Complete Phase 5 testing suite"
      contains: "Test-AllNASHealthChecks"
    - path: "scripts/test-multi-nas.ps1"
      provides: "Cross-NAS isolation testing"
      contains: "Test-CrossNASIsolation"
    - path: "scripts/test-multi-nas.ps1"
      provides: "Pod restart persistence testing"
      contains: "Test-PodRestartPersistence"
  key_links:
    - from: "scripts/test-multi-nas.ps1"
      to: "kubectl --context=file-simulator"
      via: "kubectl exec commands"
      pattern: "kubectl --context=file-simulator"
    - from: "Test-PodRestartPersistence"
      to: "kubectl wait"
      via: "pod readiness check"
      pattern: "kubectl.*wait --for=condition=ready"
---

<objective>
Extend test-multi-nas.ps1 with comprehensive Phase 5 tests for health checks, cross-NAS isolation, and pod restart persistence.

Purpose: Complete the testing suite that validates topology correctness, isolation guarantees, and data persistence across pod restarts. This enables users to run a single command (./scripts/test-multi-nas.ps1) to verify the entire 7-server NAS topology.

Output: Extended test-multi-nas.ps1 script with all TST-01 through TST-05 requirements implemented.
</objective>

<execution_context>
@C:\Users\UserC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\UserC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-testing-suite/05-RESEARCH.md
@scripts/test-multi-nas.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Test Helper Functions</name>
  <files>scripts/test-multi-nas.ps1</files>
  <action>
Add three new helper functions to test-multi-nas.ps1 BEFORE the existing Test-NFSToWindows function (around line 481).

**Function 1: Test-AllNASHealthChecks**
- Tests TST-01: Verify all 7 NAS servers accessible
- For each NAS server (nas-input-1/2/3, nas-backup, nas-output-1/2/3):
  - Check pod is ready via kubectl jsonpath: `{.items[0].status.conditions[?(@.type=="Ready")].status}` equals "True"
  - Check service exists via kubectl get svc with ClusterIP extraction
  - NodePort check optional (rpcbind limitation documented)
- Uses MANDATORY --context=file-simulator flag on ALL kubectl commands
- Returns boolean $allHealthy status
- Increments $script:testsPassed or $script:testsFailed counters

**Function 2: Test-CrossNASIsolation**
- Tests TST-04: Verify files on one server not visible on others
- Creates unique isolation marker file on nas-input-1 with timestamp in filename
- Verifies file exists on nas-input-1
- Checks ALL other 6 servers do NOT have the file (negative test)
- Cleanup: Deletes marker file in finally block
- Uses MANDATORY --context=file-simulator flag on ALL kubectl commands
- Returns boolean $isolationVerified status

**Function 3: Test-PodRestartPersistence**
- Tests TST-05: Verify files persist after pod restart
- Accepts $NasName parameter
- Creates test file via kubectl exec to /data/
- Verifies file exists
- Deletes pod with --grace-period=0 --force for quick test cycles
- Waits 5 seconds, then uses kubectl wait --for=condition=ready with 120s timeout
- Gets new pod name and verifies file still exists
- Uses MANDATORY --context=file-simulator flag on ALL kubectl commands
- Returns boolean success status

CRITICAL: Follow the exact patterns from 05-RESEARCH.md. Use Try-Catch-Finally for cleanup. Check $LASTEXITCODE after kubectl commands.
  </action>
  <verify>
Verify functions added by checking script content:
```powershell
Select-String -Path scripts/test-multi-nas.ps1 -Pattern "function Test-AllNASHealthChecks"
Select-String -Path scripts/test-multi-nas.ps1 -Pattern "function Test-CrossNASIsolation"
Select-String -Path scripts/test-multi-nas.ps1 -Pattern "function Test-PodRestartPersistence"
```
All three patterns should match.
  </verify>
  <done>
Three new test functions exist in test-multi-nas.ps1: Test-AllNASHealthChecks, Test-CrossNASIsolation, Test-PodRestartPersistence. Each function uses --context=file-simulator on all kubectl commands.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Phase 5 Test Execution Section</name>
  <files>scripts/test-multi-nas.ps1</files>
  <action>
Add Phase 5 test execution section AFTER the existing Phase 3 tests (after line 646 "Phase 3 tests complete") and BEFORE the Summary section (line 649).

**Section header:**
```powershell
# ============================================================================
# PHASE 5: COMPREHENSIVE TESTING SUITE (TST-01 through TST-05)
# ============================================================================
Write-Host ""
Write-Host "=== Phase 5: Comprehensive Testing Suite ===" -ForegroundColor Cyan
Write-Host ""
```

**Step B4: Health Check Validation (TST-01)**
- Call Test-AllNASHealthChecks
- Write-Pass or Write-Fail based on result

**Step B5: Round-Trip Coverage (TST-02, TST-03)**
- TST-02 (Windows to NFS visibility) is validated by existing tests:
  - Step 5 (Init Container Success Check): Verifies init container syncs Windows files to NFS /data
  - Step 8 (Runtime Subdirectory Creation): Creates files via kubectl exec confirming write access
  - The init container pattern copies Windows hostPath content to NFS export on pod start
- TST-03 (NFS to Windows visibility) is validated by existing Test-NFSToWindows function in Phase 3
- Add comment block explaining this coverage rather than duplicating tests:
```powershell
# TST-02/TST-03 Coverage Note:
# - TST-02 (Windows->NFS): Validated via init container pattern in Steps 5 and 8.
#   The init container syncs C:\simulator-data\{nas-name} to /data on pod startup.
#   Step 5 confirms init container completed; Step 8 confirms write access to /data.
# - TST-03 (NFS->Windows): Validated via Test-NFSToWindows in Phase 3 (Step B2).
#   Output servers have sidecar that syncs /data changes back to Windows hostPath.
Write-Host "Step B5: Round-Trip Coverage (TST-02, TST-03)" -ForegroundColor Cyan
Write-Host "  TST-02 (Windows->NFS): Covered by init container sync (Steps 5, 8)" -ForegroundColor Green
Write-Host "  TST-03 (NFS->Windows): Covered by Test-NFSToWindows (Phase 3 Step B2)" -ForegroundColor Green
```

**Step B6: Cross-NAS Isolation (TST-04)**
- Call Test-CrossNASIsolation
- Write-Pass or Write-Fail based on result

**Step B7: Pod Restart Persistence (TST-05)**
- Add warning: "NOTE: This will delete and recreate pods (may take 2-3 minutes)"
- Add -SkipPersistenceTests parameter check to allow skipping slow tests
- Test subset of servers: nas-input-1, nas-output-1, nas-backup (representative of each category)
- Call Test-PodRestartPersistence for each

**Phase 5 Summary:**
Track Phase 5 specific pass/fail counts and display before main summary.
  </action>
  <verify>
```powershell
Select-String -Path scripts/test-multi-nas.ps1 -Pattern "Phase 5: Comprehensive Testing Suite"
Select-String -Path scripts/test-multi-nas.ps1 -Pattern "TST-01"
Select-String -Path scripts/test-multi-nas.ps1 -Pattern "TST-02.*init container"
Select-String -Path scripts/test-multi-nas.ps1 -Pattern "TST-04"
Select-String -Path scripts/test-multi-nas.ps1 -Pattern "TST-05"
```
All patterns should match, confirming Phase 5 section exists with all requirement references and TST-02 coverage clarification.
  </verify>
  <done>
Phase 5 test execution section added to test-multi-nas.ps1. Section includes health check tests (TST-01), explicit coverage notes explaining TST-02 is validated via init container pattern in Steps 5 and 8, TST-03 is validated via existing Test-NFSToWindows in Phase 3, cross-NAS isolation tests (TST-04), and pod restart persistence tests (TST-05).
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Script Parameter and Update Summary</name>
  <files>scripts/test-multi-nas.ps1</files>
  <action>
**Part A: Add -SkipPersistenceTests parameter**
Add to existing param() block at top of script (line 5-9):
```powershell
[switch]$SkipPersistenceTests
```

**Part B: Update Summary Section**
Modify the final summary section (starting around line 649) to include Phase 5 results:

1. Add Phase 5 to the "7-Server NAS Topology Validated" checklist:
   - "[OK] All 7 NAS servers healthy (TST-01)"
   - "[OK] Storage isolation verified (TST-04)"
   - "[OK] Pod restart persistence validated (TST-05)"

2. Update "Next Steps" section to remove Phase 3 references (bidirectional sync already complete) and instead reference:
   - "1. Run with -SkipPersistenceTests for quick validation"
   - "2. Review any FAIL results above"
   - "3. Project validation complete - all 5 phases passing"

3. Update the exit code logic to ensure $testsFailed includes all phases (existing logic should work, but verify it captures Phase 5 failures).
  </action>
  <verify>
```powershell
Select-String -Path scripts/test-multi-nas.ps1 -Pattern "SkipPersistenceTests"
Select-String -Path scripts/test-multi-nas.ps1 -Pattern "TST-01"
Select-String -Path scripts/test-multi-nas.ps1 -Pattern "all 5 phases"
```
All patterns should match.

Run script syntax check:
```powershell
powershell -NoProfile -Command "& { $null = [System.Management.Automation.Language.Parser]::ParseFile('scripts/test-multi-nas.ps1', [ref]$null, [ref]$null) }"
```
Should complete without errors.
  </verify>
  <done>
-SkipPersistenceTests parameter added. Summary section updated to include Phase 5 results. Script passes PowerShell syntax validation. Exit code logic correctly captures all test failures.
  </done>
</task>

</tasks>

<verification>
After all tasks complete, run the full test suite to verify Phase 5 tests execute:

```powershell
# Quick syntax validation
powershell -NoProfile -Command "& { $null = [System.Management.Automation.Language.Parser]::ParseFile('scripts/test-multi-nas.ps1', [ref]$null, [ref]$null) }"

# Verify Phase 5 test functions exist
Select-String -Path scripts/test-multi-nas.ps1 -Pattern "function Test-(AllNASHealthChecks|CrossNASIsolation|PodRestartPersistence)"

# Check for mandatory --context flag usage
$contextCount = (Select-String -Path scripts/test-multi-nas.ps1 -Pattern "kubectl --context=file-simulator" | Measure-Object).Count
Write-Host "kubectl --context=file-simulator used $contextCount times"

# If cluster is running, execute the test suite:
# ./scripts/test-multi-nas.ps1 -SkipPersistenceTests
```
</verification>

<success_criteria>
1. test-multi-nas.ps1 contains Test-AllNASHealthChecks function (TST-01)
2. test-multi-nas.ps1 contains Test-CrossNASIsolation function (TST-04)
3. test-multi-nas.ps1 contains Test-PodRestartPersistence function (TST-05)
4. Phase 5 test section added with Write-Step calls for B4-B7
5. -SkipPersistenceTests parameter allows skipping slow tests
6. Script syntax validates without errors
7. All kubectl commands use --context=file-simulator flag
8. Summary section references Phase 5 results and TST requirements
9. TST-02 coverage explicitly documented as validated via init container pattern (Steps 5, 8)
</success_criteria>

<output>
After completion, create `.planning/phases/05-testing-suite/05-01-SUMMARY.md`
</output>
