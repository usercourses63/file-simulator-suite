---
phase: 11-dynamic-server-management
plan: 10
type: execute
wave: 1
depends_on: []
files_modified:
  - src/FileSimulator.ControlApi/Controllers/ConfigurationController.cs
  - src/FileSimulator.ControlApi/Services/ConfigurationExportService.cs
  - src/FileSimulator.ControlApi/Models/ConfigurationModels.cs
  - src/dashboard/src/hooks/useConfigExport.ts
  - src/dashboard/src/components/DeleteConfirmDialog.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can import configuration file without TypeError"
    - "Delete confirmation shows correct server name(s) for single, batch, and single-via-multiselect"
  artifacts:
    - path: "src/FileSimulator.ControlApi/Controllers/ConfigurationController.cs"
      provides: "Validate endpoint returns ImportValidation with willCreate and conflicts"
    - path: "src/dashboard/src/components/DeleteConfirmDialog.tsx"
      provides: "Title displays correctly for all delete scenarios"
  key_links:
    - from: "src/dashboard/src/hooks/useConfigExport.ts"
      to: "/api/configuration/validate"
      via: "fetch and type mapping"
      pattern: "validation\\.conflicts"
---

<objective>
Fix two UAT gaps from Phase 11 Dynamic Server Management:
1. GAP-1: Import configuration TypeError when processing file
2. GAP-2: Delete confirmation dialog shows empty server name

Purpose: Complete Phase 11 by closing remaining UI bugs discovered during UAT
Output: Working import workflow and correct delete confirmation UX
</objective>

<execution_context>
@C:\Users\UserC\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\UserC\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-dynamic-server-management/11-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix backend validate endpoint return type (GAP-1)</name>
  <files>
    src/FileSimulator.ControlApi/Models/ConfigurationModels.cs
    src/FileSimulator.ControlApi/Services/ConfigurationExportService.cs
    src/FileSimulator.ControlApi/Controllers/ConfigurationController.cs
  </files>
  <action>
The frontend expects `/api/configuration/validate` to return `ImportValidation`:
```typescript
interface ImportValidation {
  willCreate: ServerConfiguration[];
  conflicts: ConflictInfo[];
}
```

But the backend returns `ImportResult`:
```csharp
record ImportResult {
  List<string> Created;
  List<string> Skipped;
  Dictionary<string, string> Failed;
}
```

Fix by:

1. In `ConfigurationModels.cs`, add new models:

```csharp
/// <summary>
/// Conflict information for import validation.
/// </summary>
public record ConflictInfo
{
    public required string ServerName { get; init; }
    public required string Protocol { get; init; }
    public int? ExistingNodePort { get; init; }
    public int? ImportNodePort { get; init; }
}

/// <summary>
/// Validation result for import preview (not actual import).
/// </summary>
public record ImportValidation
{
    public List<ServerConfiguration> WillCreate { get; init; } = new();
    public List<ConflictInfo> Conflicts { get; init; } = new();
}
```

2. In `ConfigurationExportService.cs`, update `ValidateImportAsync` to return `ImportValidation` instead of `ImportResult`:

```csharp
public async Task<ImportValidation> ValidateImportAsync(
    ServerConfigurationExport config,
    CancellationToken ct = default)
{
    var result = new ImportValidation();
    var existingServers = await _discoveryService.DiscoverServersAsync(ct);
    var existingMap = existingServers.ToDictionary(s => s.Name, s => s);

    foreach (var serverConfig in config.Servers)
    {
        if (!serverConfig.IsDynamic)
        {
            // Skip static servers - not importable
            continue;
        }

        if (existingMap.TryGetValue(serverConfig.Name, out var existing))
        {
            result.Conflicts.Add(new ConflictInfo
            {
                ServerName = serverConfig.Name,
                Protocol = serverConfig.Protocol,
                ExistingNodePort = existing.NodePort,
                ImportNodePort = serverConfig.NodePort
            });
        }
        else
        {
            result.WillCreate.Add(serverConfig);
        }
    }

    return result;
}
```

3. Update `IConfigurationExportService` interface return type:
```csharp
Task<ImportValidation> ValidateImportAsync(
    ServerConfigurationExport config,
    CancellationToken ct = default);
```

4. In `ConfigurationController.cs`, update the validate endpoint:
```csharp
[HttpPost("validate")]
public async Task<ActionResult<ImportValidation>> ValidateImport(
    [FromBody] ServerConfigurationExport config,
    CancellationToken ct)
{
    try
    {
        var result = await _exportService.ValidateImportAsync(config, ct);
        return Ok(result);
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "Failed to validate import");
        return StatusCode(500, new { error = "Failed to validate import", details = ex.Message });
    }
}
```
  </action>
  <verify>
Build backend: `dotnet build src/FileSimulator.ControlApi`
No compile errors. API returns correct JSON structure.
  </verify>
  <done>
POST /api/configuration/validate returns JSON with `willCreate` array and `conflicts` array (camelCase).
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix delete confirmation dialog title logic (GAP-2)</name>
  <files>src/dashboard/src/components/DeleteConfirmDialog.tsx</files>
  <action>
The bug: When deleting via multi-select with exactly 1 server, `isBatch` is false (requires >1), but `serverName` is empty because `deleteTarget` is null.

Fix by changing the condition logic:

```typescript
// OLD (buggy)
const isBatch = serverNames && serverNames.length > 1;
const title = isBatch
  ? `Delete ${serverNames.length} servers?`
  : `Delete server "${serverName}"?`;

// NEW (fixed)
// Use serverNames if provided (even for single item from multi-select)
const isBatch = serverNames && serverNames.length > 0;
const displayName = isBatch
  ? (serverNames.length === 1 ? serverNames[0] : null)
  : serverName;
const title = isBatch && serverNames.length > 1
  ? `Delete ${serverNames.length} servers?`
  : `Delete server "${displayName}"?`;
```

Full updated component section:

```typescript
if (!isOpen) return null;

// Determine display mode - use serverNames if provided (even for single)
const useServerNames = serverNames && serverNames.length > 0;
const isMultiple = useServerNames && serverNames.length > 1;

// Get display name for single server delete
const displayName = useServerNames
  ? serverNames[0]  // First name from batch (handles single-via-multiselect)
  : serverName;     // Direct single delete

const title = isMultiple
  ? `Delete ${serverNames.length} servers?`
  : `Delete server "${displayName}"?`;
```

This handles three scenarios:
1. Single delete via trash icon: `serverName="my-ftp"`, `serverNames=undefined` -> shows "Delete server \"my-ftp\"?"
2. Multi-select with 1 server: `serverName=""`, `serverNames=["my-ftp"]` -> shows "Delete server \"my-ftp\"?"
3. Multi-select with N servers: `serverName=""`, `serverNames=["a","b"]` -> shows "Delete 2 servers?"
  </action>
  <verify>
Build frontend: `cd src/dashboard && npm run build`
No TypeScript errors.
  </verify>
  <done>
Delete confirmation title correctly shows server name(s) in all three scenarios.
  </done>
</task>

</tasks>

<verification>
1. Start backend: `dotnet run --project src/FileSimulator.ControlApi`
2. Test validate endpoint:
```bash
curl -X POST http://localhost:5000/api/configuration/validate \
  -H "Content-Type: application/json" \
  -d '{"version":"2.0","namespace":"file-simulator","releasePrefix":"file-sim","servers":[{"name":"test-ftp","protocol":"FTP","isDynamic":true,"ftp":{"username":"u","password":"p"}}]}'
```
Response should have `willCreate` and `conflicts` arrays.

3. Test delete dialog in browser:
   - Single delete via hover trash icon -> shows correct name
   - Multi-select 1 server -> shows correct name
   - Multi-select 2+ servers -> shows count
</verification>

<success_criteria>
- Import configuration workflow completes without TypeError
- Delete confirmation dialog shows correct server name in all scenarios
- Backend builds without errors
- Frontend builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-dynamic-server-management/11-10-SUMMARY.md`
</output>
