---
phase: 11-dynamic-server-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - helm-chart/file-simulator/values.yaml
  - src/FileSimulator.ControlApi/FileSimulator.ControlApi.csproj
  - src/FileSimulator.ControlApi/Models/CreateServerRequests.cs
  - src/FileSimulator.ControlApi/Validators/CreateFtpServerValidator.cs
  - src/FileSimulator.ControlApi/Validators/CreateSftpServerValidator.cs
  - src/FileSimulator.ControlApi/Validators/CreateNasServerValidator.cs
autonomous: true

must_haves:
  truths:
    - "RBAC permits create, update, delete operations on deployments, services, configmaps, and PVCs"
    - "FluentValidation validates server creation requests before Kubernetes API calls"
    - "Server name must be lowercase alphanumeric with hyphens, 3-32 chars"
  artifacts:
    - path: "helm-chart/file-simulator/values.yaml"
      provides: "Extended RBAC rules with write permissions"
      contains: "create, update, delete"
    - path: "src/FileSimulator.ControlApi/Models/CreateServerRequests.cs"
      provides: "Request DTOs for FTP, SFTP, NAS server creation"
      exports: ["CreateFtpServerRequest", "CreateSftpServerRequest", "CreateNasServerRequest"]
    - path: "src/FileSimulator.ControlApi/Validators/CreateFtpServerValidator.cs"
      provides: "FTP server creation validation rules"
      contains: "AbstractValidator"
  key_links:
    - from: "Program.cs"
      to: "FluentValidation"
      via: "AddValidatorsFromAssemblyContaining"
      pattern: "AddValidatorsFromAssembly"
---

<objective>
Update RBAC permissions and create request models with validation for dynamic server management.

Purpose: Phase 11 requires write operations to Kubernetes API. Current RBAC is read-only (Phase 6). Models and validators ensure valid requests before expensive API calls.
Output: Updated values.yaml with write RBAC, request DTOs with FluentValidation.
</objective>

<execution_context>
@C:\Users\UserC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\UserC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-dynamic-server-management/11-RESEARCH.md

# Existing code to extend
@helm-chart/file-simulator/values.yaml
@src/FileSimulator.ControlApi/Models/DiscoveredServer.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update RBAC and add FluentValidation package</name>
  <files>helm-chart/file-simulator/values.yaml, src/FileSimulator.ControlApi/FileSimulator.ControlApi.csproj</files>
  <action>
1. Update values.yaml controlApi.rbac.rules section to add write permissions:
```yaml
rules:
  - apiGroups: [""]
    resources: ["pods", "services", "configmaps", "persistentvolumeclaims"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: ["apps"]
    resources: ["deployments"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
```

2. Add FluentValidation packages to the .csproj:
```bash
cd src/FileSimulator.ControlApi
dotnet add package FluentValidation.DependencyInjectionExtensions --version 11.9.0
```

Note: Do NOT deploy helm yet - just update the values file. Deployment happens after all backend code is ready.
  </action>
  <verify>
- `dotnet restore src/FileSimulator.ControlApi` succeeds
- values.yaml contains "create, update, patch, delete" verbs
- values.yaml includes persistentvolumeclaims resource
  </verify>
  <done>RBAC rules include write permissions for deployments, services, configmaps, PVCs. FluentValidation package added to project.</done>
</task>

<task type="auto">
  <name>Task 2: Create request models and validators</name>
  <files>
src/FileSimulator.ControlApi/Models/CreateServerRequests.cs
src/FileSimulator.ControlApi/Validators/CreateFtpServerValidator.cs
src/FileSimulator.ControlApi/Validators/CreateSftpServerValidator.cs
src/FileSimulator.ControlApi/Validators/CreateNasServerValidator.cs
src/FileSimulator.ControlApi/Program.cs
  </files>
  <action>
1. Create Models/CreateServerRequests.cs with three request records:

```csharp
namespace FileSimulator.ControlApi.Models;

/// <summary>
/// Base properties shared by all server creation requests.
/// </summary>
public abstract record CreateServerRequestBase
{
    /// <summary>
    /// Server instance name (lowercase alphanumeric with hyphens, 3-32 chars).
    /// Combined with protocol to form unique resource names.
    /// </summary>
    public required string Name { get; init; }

    /// <summary>
    /// Optional NodePort (30000-32767). If null, Kubernetes auto-assigns.
    /// </summary>
    public int? NodePort { get; init; }
}

/// <summary>
/// Request to create a new FTP server instance.
/// </summary>
public record CreateFtpServerRequest : CreateServerRequestBase
{
    /// <summary>FTP username for authentication.</summary>
    public required string Username { get; init; }

    /// <summary>FTP password (min 8 chars).</summary>
    public required string Password { get; init; }

    /// <summary>Passive mode start port (optional, defaults based on NodePort).</summary>
    public int? PassivePortStart { get; init; }

    /// <summary>Passive mode end port (optional, defaults to start + 10).</summary>
    public int? PassivePortEnd { get; init; }
}

/// <summary>
/// Request to create a new SFTP server instance.
/// </summary>
public record CreateSftpServerRequest : CreateServerRequestBase
{
    /// <summary>SFTP username.</summary>
    public required string Username { get; init; }

    /// <summary>SFTP password (min 8 chars).</summary>
    public required string Password { get; init; }

    /// <summary>User UID (default: 1000).</summary>
    public int Uid { get; init; } = 1000;

    /// <summary>User GID (default: 1000).</summary>
    public int Gid { get; init; } = 1000;
}

/// <summary>
/// Request to create a new NAS (NFS) server instance.
/// </summary>
public record CreateNasServerRequest : CreateServerRequestBase
{
    /// <summary>
    /// Directory path relative to shared PVC root.
    /// Presets: "input", "output", "backup" or custom path.
    /// </summary>
    public required string Directory { get; init; }

    /// <summary>NFS export options (default: rw,sync,no_subtree_check,no_root_squash).</summary>
    public string ExportOptions { get; init; } = "rw,sync,no_subtree_check,no_root_squash";
}
```

2. Create Validators/CreateFtpServerValidator.cs:
```csharp
using FluentValidation;
using FileSimulator.ControlApi.Models;

namespace FileSimulator.ControlApi.Validators;

public class CreateFtpServerValidator : AbstractValidator<CreateFtpServerRequest>
{
    public CreateFtpServerValidator()
    {
        RuleFor(x => x.Name)
            .NotEmpty()
            .Matches("^[a-z0-9-]+$").WithMessage("Name must be lowercase alphanumeric with hyphens only")
            .Length(3, 32).WithMessage("Name must be between 3 and 32 characters");

        RuleFor(x => x.NodePort)
            .InclusiveBetween(30000, 32767)
            .When(x => x.NodePort.HasValue)
            .WithMessage("NodePort must be in range 30000-32767");

        RuleFor(x => x.Username)
            .NotEmpty()
            .Length(3, 32);

        RuleFor(x => x.Password)
            .NotEmpty()
            .MinimumLength(8).WithMessage("Password must be at least 8 characters");

        RuleFor(x => x.PassivePortStart)
            .InclusiveBetween(30000, 32700)
            .When(x => x.PassivePortStart.HasValue)
            .WithMessage("PassivePortStart must be in range 30000-32700");

        RuleFor(x => x.PassivePortEnd)
            .GreaterThan(x => x.PassivePortStart ?? 0)
            .When(x => x.PassivePortEnd.HasValue && x.PassivePortStart.HasValue)
            .WithMessage("PassivePortEnd must be greater than PassivePortStart");
    }
}
```

3. Create Validators/CreateSftpServerValidator.cs (similar pattern with Uid/Gid rules)

4. Create Validators/CreateNasServerValidator.cs (similar pattern with Directory rules - must not contain .. or start with /)

5. Register validators in Program.cs (add near other service registrations):
```csharp
using FluentValidation;
// ... existing usings

// Add after builder.Services.AddSingleton<IKubernetesDiscoveryService...>
builder.Services.AddValidatorsFromAssemblyContaining<CreateFtpServerValidator>();
```
  </action>
  <verify>
- `dotnet build src/FileSimulator.ControlApi` compiles without errors
- All three request records exist with proper properties
- All three validators exist with proper rules
- Program.cs registers validators
  </verify>
  <done>Request DTOs (CreateFtpServerRequest, CreateSftpServerRequest, CreateNasServerRequest) created with FluentValidation validators registered in DI.</done>
</task>

</tasks>

<verification>
1. `dotnet build src/FileSimulator.ControlApi` succeeds
2. values.yaml RBAC includes: pods, services, configmaps, persistentvolumeclaims, deployments with full CRUD verbs
3. FluentValidation package version 11.9.0 in .csproj
4. Three request records with proper properties
5. Three validators with proper rules
</verification>

<success_criteria>
- RBAC rules updated for Phase 11 write operations
- Request models define all configuration options from CONTEXT.md (full control)
- Validators enforce name format, port ranges, password requirements
- Project compiles and validators are registered
</success_criteria>

<output>
After completion, create `.planning/phases/11-dynamic-server-management/11-01-SUMMARY.md`
</output>
