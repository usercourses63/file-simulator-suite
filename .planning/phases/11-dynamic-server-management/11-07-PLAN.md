---
phase: 11-dynamic-server-management
plan: 07
type: execute
wave: 3
depends_on: ["11-04"]
files_modified:
  - src/dashboard/src/hooks/useMultiSelect.ts
  - src/dashboard/src/components/DeleteConfirmDialog.tsx
  - src/dashboard/src/components/BatchOperationsBar.tsx
  - src/dashboard/src/components/ServerCard.tsx
  - src/dashboard/src/components/ServerGrid.tsx
  - src/dashboard/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "Multi-select with checkboxes for dynamic servers"
    - "Batch delete supported with single confirmation"
    - "Static servers show 'Managed by Helm' badge, no delete option"
    - "Delete confirmation dialog for single and batch delete"
  artifacts:
    - path: "src/dashboard/src/hooks/useMultiSelect.ts"
      provides: "Multi-select state management"
      min_lines: 30
    - path: "src/dashboard/src/components/DeleteConfirmDialog.tsx"
      provides: "Deletion confirmation with NAS file option"
      min_lines: 40
    - path: "src/dashboard/src/components/BatchOperationsBar.tsx"
      provides: "Batch action bar for selected servers"
      min_lines: 30
  key_links:
    - from: "ServerCard"
      to: "useMultiSelect"
      via: "checkbox and onToggleSelect"
      pattern: "onToggleSelect"
    - from: "BatchOperationsBar"
      to: "useServerManagement.deleteServer"
      via: "batch delete handler"
      pattern: "deleteServer"
---

<objective>
Implement multi-select, batch operations, and delete functionality for dynamic servers.

Purpose: Enable power users to manage multiple servers efficiently with batch deletion. Protect static servers from accidental deletion.
Output: Multi-select hook, delete confirmation, batch operations bar, updated ServerCard/Grid.
</objective>

<execution_context>
@C:\Users\UserC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\UserC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-dynamic-server-management/11-CONTEXT.md
@.planning/phases/11-dynamic-server-management/11-RESEARCH.md

# Existing components to modify
@src/dashboard/src/components/ServerCard.tsx
@src/dashboard/src/components/ServerGrid.tsx
@src/dashboard/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useMultiSelect hook and delete dialog</name>
  <files>
src/dashboard/src/hooks/useMultiSelect.ts
src/dashboard/src/components/DeleteConfirmDialog.tsx
src/dashboard/src/components/BatchOperationsBar.tsx
  </files>
  <action>
1. Create src/dashboard/src/hooks/useMultiSelect.ts:

```typescript
import { useState, useCallback, useMemo } from 'react';

interface MultiSelectItem {
  name: string;
  isDynamic?: boolean;
}

interface UseMultiSelectReturn<T extends MultiSelectItem> {
  selectedIds: Set<string>;
  selectedItems: T[];
  selectedCount: number;
  isSelected: (id: string) => boolean;
  toggleSelect: (id: string) => void;
  selectAll: () => void;
  clearSelection: () => void;
  setSelected: (ids: string[]) => void;
}

export function useMultiSelect<T extends MultiSelectItem>(
  items: T[],
  canSelect: (item: T) => boolean = (item) => item.isDynamic === true
): UseMultiSelectReturn<T> {
  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());

  const toggleSelect = useCallback((id: string) => {
    setSelectedIds(prev => {
      const next = new Set(prev);
      if (next.has(id)) {
        next.delete(id);
      } else {
        next.add(id);
      }
      return next;
    });
  }, []);

  const selectAll = useCallback(() => {
    const selectableIds = items
      .filter(canSelect)
      .map(item => item.name);
    setSelectedIds(new Set(selectableIds));
  }, [items, canSelect]);

  const clearSelection = useCallback(() => {
    setSelectedIds(new Set());
  }, []);

  const setSelected = useCallback((ids: string[]) => {
    setSelectedIds(new Set(ids));
  }, []);

  const isSelected = useCallback((id: string) => selectedIds.has(id), [selectedIds]);

  const selectedItems = useMemo(
    () => items.filter(item => selectedIds.has(item.name)),
    [items, selectedIds]
  );

  return {
    selectedIds,
    selectedItems,
    selectedCount: selectedIds.size,
    isSelected,
    toggleSelect,
    selectAll,
    clearSelection,
    setSelected
  };
}

export default useMultiSelect;
```

2. Create src/dashboard/src/components/DeleteConfirmDialog.tsx:

```tsx
import { useState } from 'react';
import './DeleteConfirmDialog.css';

interface DeleteConfirmDialogProps {
  isOpen: boolean;
  serverName: string;
  serverNames?: string[];  // For batch delete
  isNasServer: boolean;
  isDeleting: boolean;
  onConfirm: (deleteData: boolean) => void;
  onCancel: () => void;
}

export function DeleteConfirmDialog({
  isOpen,
  serverName,
  serverNames,
  isNasServer,
  isDeleting,
  onConfirm,
  onCancel
}: DeleteConfirmDialogProps) {
  const [deleteFiles, setDeleteFiles] = useState(false);

  if (!isOpen) return null;

  const isBatch = serverNames && serverNames.length > 1;
  const title = isBatch
    ? `Delete ${serverNames.length} servers?`
    : `Delete server "${serverName}"?`;

  const handleConfirm = () => {
    onConfirm(deleteFiles);
  };

  return (
    <div className="modal-overlay" onClick={onCancel}>
      <div className="delete-confirm-dialog" onClick={e => e.stopPropagation()}>
        <div className="dialog-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2m3 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6h14z" />
          </svg>
        </div>

        <h3>{title}</h3>

        {isBatch && (
          <div className="server-list">
            {serverNames.map(name => (
              <span key={name} className="server-tag">{name}</span>
            ))}
          </div>
        )}

        <p className="warning-text">
          This will permanently delete the deployment and service.
          {isNasServer && ' The NAS directory may contain files.'}
        </p>

        {isNasServer && (
          <label className="delete-files-option">
            <input
              type="checkbox"
              checked={deleteFiles}
              onChange={e => setDeleteFiles(e.target.checked)}
              disabled={isDeleting}
            />
            Also delete files from Windows directory
          </label>
        )}

        <div className="dialog-actions">
          <button
            type="button"
            className="btn btn--secondary"
            onClick={onCancel}
            disabled={isDeleting}
          >
            Cancel
          </button>
          <button
            type="button"
            className="btn btn--danger"
            onClick={handleConfirm}
            disabled={isDeleting}
          >
            {isDeleting ? 'Deleting...' : 'Delete'}
          </button>
        </div>
      </div>
    </div>
  );
}

export default DeleteConfirmDialog;
```

Add DeleteConfirmDialog.css:

```css
.delete-confirm-dialog {
  background: var(--bg-primary);
  border-radius: 8px;
  padding: 24px;
  width: 400px;
  max-width: 95vw;
  text-align: center;
}

.dialog-icon {
  width: 48px;
  height: 48px;
  margin: 0 auto 16px;
  color: var(--error-color);
}

.dialog-icon svg {
  width: 100%;
  height: 100%;
}

.delete-confirm-dialog h3 {
  margin: 0 0 12px;
  font-size: 1.25rem;
}

.server-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
  margin-bottom: 16px;
}

.server-tag {
  background: var(--bg-secondary);
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
}

.warning-text {
  color: var(--text-secondary);
  margin-bottom: 16px;
}

.delete-files-option {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  margin-bottom: 20px;
  cursor: pointer;
}

.dialog-actions {
  display: flex;
  gap: 12px;
  justify-content: center;
}

.btn--danger {
  background: var(--error-color);
  color: white;
}

.btn--danger:hover:not(:disabled) {
  filter: brightness(1.1);
}
```

3. Create src/dashboard/src/components/BatchOperationsBar.tsx:

```tsx
import './BatchOperationsBar.css';

interface BatchOperationsBarProps {
  selectedCount: number;
  onDelete: () => void;
  onSelectAll: () => void;
  onClearSelection: () => void;
  isDeleting?: boolean;
}

export function BatchOperationsBar({
  selectedCount,
  onDelete,
  onSelectAll,
  onClearSelection,
  isDeleting
}: BatchOperationsBarProps) {
  if (selectedCount === 0) return null;

  return (
    <div className="batch-operations-bar">
      <span className="selection-count">
        {selectedCount} server{selectedCount !== 1 ? 's' : ''} selected
      </span>

      <div className="batch-actions">
        <button
          type="button"
          className="batch-btn batch-btn--secondary"
          onClick={onSelectAll}
          disabled={isDeleting}
        >
          Select All
        </button>
        <button
          type="button"
          className="batch-btn batch-btn--secondary"
          onClick={onClearSelection}
          disabled={isDeleting}
        >
          Clear
        </button>
        <button
          type="button"
          className="batch-btn batch-btn--danger"
          onClick={onDelete}
          disabled={isDeleting}
        >
          {isDeleting ? 'Deleting...' : `Delete (${selectedCount})`}
        </button>
      </div>
    </div>
  );
}

export default BatchOperationsBar;
```

Add BatchOperationsBar.css:

```css
.batch-operations-bar {
  position: sticky;
  top: 0;
  z-index: 50;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 20px;
  background: var(--accent-color);
  color: white;
  margin: -20px -20px 20px;
  border-radius: 8px 8px 0 0;
}

.selection-count {
  font-weight: 500;
}

.batch-actions {
  display: flex;
  gap: 8px;
}

.batch-btn {
  padding: 8px 16px;
  border-radius: 4px;
  font-size: 14px;
  cursor: pointer;
  border: none;
  font-weight: 500;
}

.batch-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.batch-btn--secondary {
  background: rgba(255, 255, 255, 0.2);
  color: white;
}

.batch-btn--secondary:hover:not(:disabled) {
  background: rgba(255, 255, 255, 0.3);
}

.batch-btn--danger {
  background: var(--error-color);
  color: white;
}

.batch-btn--danger:hover:not(:disabled) {
  filter: brightness(1.1);
}
```
  </action>
  <verify>
- All three files created
- useMultiSelect filters by isDynamic by default
- DeleteConfirmDialog shows NAS file option
- BatchOperationsBar shows selection count and actions
  </verify>
  <done>Multi-select hook, delete confirmation dialog with NAS file option, batch operations bar.</done>
</task>

<task type="auto">
  <name>Task 2: Update ServerCard and ServerGrid with multi-select and delete</name>
  <files>
src/dashboard/src/components/ServerCard.tsx
src/dashboard/src/components/ServerGrid.tsx
src/dashboard/src/App.tsx
src/dashboard/src/App.css
  </files>
  <action>
1. Update ServerCard.tsx to add checkbox and dynamic badge:

```tsx
import { useState, useEffect, useRef } from 'react';
import { ServerStatus } from '../types/server';
import { getHealthState, getHealthStateText } from '../utils/healthStatus';
import ServerSparkline from './ServerSparkline';

interface ServerCardProps {
  server: ServerStatus;
  onClick: () => void;
  sparklineData?: number[];
  onSparklineClick?: () => void;
  // New props for multi-select
  showCheckbox?: boolean;
  isSelected?: boolean;
  onToggleSelect?: () => void;
  onDelete?: () => void;
  isDynamic?: boolean;
  managedBy?: string;
}

export function ServerCard({
  server,
  onClick,
  sparklineData,
  onSparklineClick,
  showCheckbox,
  isSelected,
  onToggleSelect,
  onDelete,
  isDynamic,
  managedBy
}: ServerCardProps) {
  const healthState = getHealthState(server);
  const healthText = getHealthStateText(healthState);

  const prevHealthState = useRef(healthState);
  const [isAnimating, setIsAnimating] = useState(false);

  useEffect(() => {
    if (prevHealthState.current !== healthState) {
      setIsAnimating(true);
      prevHealthState.current = healthState;
      const timer = setTimeout(() => setIsAnimating(false), 600);
      return () => clearTimeout(timer);
    }
  }, [healthState]);

  const formatLatency = (latencyMs?: number) => {
    if (latencyMs === undefined) return '-';
    if (latencyMs < 1000) return `${latencyMs}ms`;
    return `${(latencyMs / 1000).toFixed(1)}s`;
  };

  const handleSparklineClick = (e: React.MouseEvent) => {
    e.stopPropagation();
    onSparklineClick?.();
  };

  const handleCheckboxClick = (e: React.MouseEvent) => {
    e.stopPropagation();
    onToggleSelect?.();
  };

  const handleDeleteClick = (e: React.MouseEvent) => {
    e.stopPropagation();
    onDelete?.();
  };

  return (
    <div
      className={`server-card server-card--${healthState} ${isAnimating ? 'server-card--pulse' : ''} ${isSelected ? 'server-card--selected' : ''}`}
      onClick={onClick}
      role="button"
      tabIndex={0}
      onKeyDown={(e) => e.key === 'Enter' && onClick()}
    >
      {/* Selection checkbox for dynamic servers */}
      {showCheckbox && isDynamic && (
        <div className="server-card-checkbox" onClick={handleCheckboxClick}>
          <input
            type="checkbox"
            checked={isSelected}
            onChange={() => {}}
            onClick={e => e.stopPropagation()}
          />
        </div>
      )}

      <div className="server-card-header">
        <span className="server-name">{server.name}</span>
        <div className="server-badges">
          <span className="server-protocol">{server.protocol}</span>
          {isDynamic ? (
            <span className="badge badge--dynamic">Dynamic</span>
          ) : (
            <span className="badge badge--helm" title="Managed by Helm - cannot be deleted">
              Helm
            </span>
          )}
        </div>
      </div>

      <div className="server-card-body">
        <div className="server-status">
          <span className={`status-dot status-dot--${healthState}`}></span>
          <span className="status-text">{healthText}</span>
        </div>

        <div className="server-metrics">
          <span className="metric-label">Latency:</span>
          <span className="metric-value">{formatLatency(server.latencyMs)}</span>
        </div>
      </div>

      {sparklineData && sparklineData.length > 0 && (
        <div className="server-card-sparkline" onClick={handleSparklineClick}>
          <ServerSparkline
            data={sparklineData}
            isHealthy={server.isHealthy}
            onClick={onSparklineClick}
          />
        </div>
      )}

      {server.healthMessage && (
        <div className="server-card-footer">
          <span className="health-message">{server.healthMessage}</span>
        </div>
      )}

      {/* Delete button for dynamic servers */}
      {isDynamic && onDelete && (
        <button
          className="server-card-delete"
          onClick={handleDeleteClick}
          title="Delete server"
        >
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2m3 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6h14z" />
          </svg>
        </button>
      )}
    </div>
  );
}

export default ServerCard;
```

2. Update ServerGrid.tsx to add multi-select support:

```tsx
import { ServerStatus } from '../types/server';
import ServerCard from './ServerCard';

interface ServerGridProps {
  servers: ServerStatus[];
  onCardClick: (server: ServerStatus) => void;
  sparklineData?: Record<string, number[]>;
  onSparklineClick?: (serverId: string) => void;
  // Multi-select props
  showMultiSelect?: boolean;
  selectedIds?: Set<string>;
  onToggleSelect?: (id: string) => void;
  onDelete?: (server: ServerStatus) => void;
  // Dynamic server info
  dynamicInfo?: Record<string, { isDynamic: boolean; managedBy: string }>;
}

export function ServerGrid({
  servers,
  onCardClick,
  sparklineData,
  onSparklineClick,
  showMultiSelect,
  selectedIds,
  onToggleSelect,
  onDelete,
  dynamicInfo
}: ServerGridProps) {
  if (servers.length === 0) {
    return (
      <div className="server-grid-empty">
        <p>No servers found</p>
      </div>
    );
  }

  return (
    <div className="server-grid">
      {servers.map(server => {
        const info = dynamicInfo?.[server.name];
        return (
          <ServerCard
            key={server.name}
            server={server}
            onClick={() => onCardClick(server)}
            sparklineData={sparklineData?.[server.name]}
            onSparklineClick={onSparklineClick ? () => onSparklineClick(server.name) : undefined}
            showCheckbox={showMultiSelect}
            isSelected={selectedIds?.has(server.name)}
            onToggleSelect={onToggleSelect ? () => onToggleSelect(server.name) : undefined}
            onDelete={onDelete ? () => onDelete(server) : undefined}
            isDynamic={info?.isDynamic ?? false}
            managedBy={info?.managedBy ?? 'Helm'}
          />
        );
      })}
    </div>
  );
}

export default ServerGrid;
```

3. Update App.tsx to integrate multi-select and add Create Server button:

Add imports at top:
```tsx
import { useMultiSelect } from './hooks/useMultiSelect';
import { useServerManagement } from './hooks/useServerManagement';
import CreateServerModal from './components/CreateServerModal';
import DeleteConfirmDialog from './components/DeleteConfirmDialog';
import BatchOperationsBar from './components/BatchOperationsBar';
```

Add state and handlers in App component:
```tsx
// Add server button state
const [showCreateModal, setShowCreateModal] = useState(false);

// Delete dialog state
const [deleteTarget, setDeleteTarget] = useState<{ name: string; protocol: string } | null>(null);
const [batchDeleteTargets, setBatchDeleteTargets] = useState<string[]>([]);

// Server management
const { deleteServer, isLoading: isDeleting } = useServerManagement({ apiBaseUrl });

// Multi-select for servers tab
const serversWithDynamicInfo = data?.servers.map(s => ({
  ...s,
  isDynamic: false,  // TODO: Extend ServerStatus type to include this
  name: s.name
})) ?? [];

const {
  selectedIds,
  selectedItems,
  selectedCount,
  isSelected,
  toggleSelect,
  selectAll,
  clearSelection
} = useMultiSelect(serversWithDynamicInfo);

// Handle single delete
const handleDelete = (server: { name: string; protocol: string }) => {
  setDeleteTarget(server);
};

// Handle batch delete
const handleBatchDelete = () => {
  setBatchDeleteTargets(Array.from(selectedIds));
};

// Confirm delete
const handleConfirmDelete = async (deleteData: boolean) => {
  try {
    if (batchDeleteTargets.length > 0) {
      // Batch delete
      await Promise.all(batchDeleteTargets.map(name => deleteServer(name, deleteData)));
      clearSelection();
      setBatchDeleteTargets([]);
    } else if (deleteTarget) {
      // Single delete
      await deleteServer(deleteTarget.name, deleteData);
      setDeleteTarget(null);
    }
  } catch (err) {
    console.error('Delete failed:', err);
  }
};

// Cancel delete
const handleCancelDelete = () => {
  setDeleteTarget(null);
  setBatchDeleteTargets([]);
};

// Refresh after create
const handleServerCreated = () => {
  // SignalR will push update automatically
  setShowCreateModal(false);
};
```

Update header to add Create Server button (after nav tabs):
```tsx
<nav className="header-tabs">
  {/* existing tabs */}
</nav>
<button
  className="btn btn--primary header-add-btn"
  onClick={() => setShowCreateModal(true)}
>
  + Add Server
</button>
```

Update servers tab to include batch bar and multi-select:
```tsx
{activeTab === 'servers' && (
  <>
    {data ? (
      <>
        <BatchOperationsBar
          selectedCount={selectedCount}
          onDelete={handleBatchDelete}
          onSelectAll={selectAll}
          onClearSelection={clearSelection}
          isDeleting={isDeleting}
        />
        <SummaryHeader servers={data.servers} />
        <ServerGrid
          servers={data.servers}
          onCardClick={setSelectedServer}
          sparklineData={latestSamples}
          onSparklineClick={handleSparklineClick}
          showMultiSelect={true}
          selectedIds={selectedIds}
          onToggleSelect={toggleSelect}
          onDelete={handleDelete}
          dynamicInfo={{}}  // TODO: Get from extended ServerStatus
        />
      </>
    ) : (
      // loading state
    )}
  </>
)}
```

Add modals at end of App component:
```tsx
<CreateServerModal
  isOpen={showCreateModal}
  onClose={() => setShowCreateModal(false)}
  onCreated={handleServerCreated}
  apiBaseUrl={apiBaseUrl}
/>

<DeleteConfirmDialog
  isOpen={deleteTarget !== null || batchDeleteTargets.length > 0}
  serverName={deleteTarget?.name ?? ''}
  serverNames={batchDeleteTargets.length > 0 ? batchDeleteTargets : undefined}
  isNasServer={deleteTarget?.protocol === 'NAS' || batchDeleteTargets.some(n => n.includes('nas'))}
  isDeleting={isDeleting}
  onConfirm={handleConfirmDelete}
  onCancel={handleCancelDelete}
/>
```

4. Add styles to App.css:

```css
/* Header Add Button */
.header-add-btn {
  margin-left: auto;
}

/* Server Card Multi-select */
.server-card--selected {
  outline: 2px solid var(--accent-color);
  outline-offset: 2px;
}

.server-card-checkbox {
  position: absolute;
  top: 12px;
  left: 12px;
  z-index: 10;
}

.server-card-checkbox input {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

/* Server Card Delete Button */
.server-card-delete {
  position: absolute;
  top: 8px;
  right: 8px;
  width: 28px;
  height: 28px;
  padding: 4px;
  border: none;
  background: rgba(239, 68, 68, 0.1);
  border-radius: 4px;
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.2s;
  color: var(--error-color);
}

.server-card:hover .server-card-delete {
  opacity: 1;
}

.server-card-delete:hover {
  background: var(--error-color);
  color: white;
}

.server-card-delete svg {
  width: 100%;
  height: 100%;
}

/* Badges */
.server-badges {
  display: flex;
  gap: 6px;
  align-items: center;
}

.badge {
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: 600;
  text-transform: uppercase;
}

.badge--dynamic {
  background: rgba(59, 130, 246, 0.2);
  color: #3b82f6;
}

.badge--helm {
  background: rgba(156, 163, 175, 0.2);
  color: #6b7280;
}
```
  </action>
  <verify>
- ServerCard shows checkbox for dynamic servers
- ServerCard shows Helm badge for static servers
- ServerCard shows delete button on hover for dynamic servers
- BatchOperationsBar appears when items selected
- DeleteConfirmDialog shows for single and batch delete
- App integrates all components
  </verify>
  <done>Multi-select with batch operations, delete confirmation with NAS file option, dynamic vs static server distinction.</done>
</task>

</tasks>

<verification>
1. `npm run build` in dashboard succeeds
2. Dynamic servers show checkbox and delete button
3. Static servers show "Helm" badge, no delete option
4. Multi-select enables batch delete
5. Delete dialog asks about files for NAS servers
</verification>

<success_criteria>
- Multi-select delete supported (CONTEXT.md)
- Static servers: "Managed by Helm" badge, no delete (CONTEXT.md)
- Simple confirm dialog for delete (CONTEXT.md)
- NAS: ask about files each time (CONTEXT.md)
- Immediate deletion after confirmation (CONTEXT.md)
</success_criteria>

<output>
After completion, create `.planning/phases/11-dynamic-server-management/11-07-SUMMARY.md`
</output>
