---
phase: 02-7-server-topology
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - helm-chart/file-simulator/templates/nas-multi.yaml
  - helm-chart/file-simulator/values-multi-nas.yaml
autonomous: true

must_haves:
  truths:
    - "Helm template renders 7 Deployment resources (one per NAS server)"
    - "Helm template renders 7 Service resources with unique NodePorts"
    - "Each NAS server has unique hostPath directory configuration"
    - "Each NAS server can be independently enabled/disabled"
  artifacts:
    - path: "helm-chart/file-simulator/templates/nas-multi.yaml"
      provides: "Range-loop template generating 7 Deployment+Service pairs"
      min_lines: 100
      contains: "range $index, $nas := .Values.nasServers"
    - path: "helm-chart/file-simulator/values-multi-nas.yaml"
      provides: "7 NAS server configurations with unique names, NodePorts, hostPaths"
      min_lines: 150
      contains: "nas-input-1"
  key_links:
    - from: "nas-multi.yaml"
      to: "values-multi-nas.yaml"
      via: ".Values.nasServers list iteration"
      pattern: "range.*nasServers"
    - from: "nas-multi.yaml"
      to: "_helpers.tpl"
      via: "include file-simulator.fullname $"
      pattern: 'include "file-simulator\.(fullname|namespace|labels)"'
---

<objective>
Create the multi-instance NAS Helm template and values configuration for deploying 7 independent NAS servers.

Purpose: Scale the Phase 1 validated init container + unfs3 pattern to production-matching 7-server topology using established Helm multi-instance patterns (proven in ftp-multi.yaml).

Output: nas-multi.yaml template + values-multi-nas.yaml configuration ready for deployment.
</objective>

<execution_context>
@C:\Users\UserC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\UserC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-7-server-topology/02-RESEARCH.md

# Phase 1 validated pattern - follow exactly
@helm-chart/file-simulator/templates/nas-test.yaml

# Existing multi-instance pattern to follow
@helm-chart/file-simulator/templates/ftp-multi.yaml

# Helper functions for templates
@helm-chart/file-simulator/templates/_helpers.tpl

# Existing multi-instance values structure
@helm-chart/file-simulator/values-multi-instance.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create nas-multi.yaml Helm Template</name>
  <files>helm-chart/file-simulator/templates/nas-multi.yaml</files>
  <action>
Create nas-multi.yaml template that generates 7 Deployment+Service pairs using Helm range loop.

**Template structure:**
1. Add template header comment explaining purpose (multi-instance NAS, use with values-multi-nas.yaml)
2. Guard with `{{- if .Values.nasServers }}`
3. Use `{{- range $index, $nas := .Values.nasServers }}` to iterate over server list
4. Inside loop, guard each server with `{{- if $nas.enabled }}`
5. Generate Deployment resource (copy structure from nas-test.yaml, parameterize with $nas fields)
6. Generate Service resource (copy structure from nas-test.yaml, parameterize with $nas fields)

**Critical implementation details:**
- Use `$` (root scope) when calling include functions: `{{ include "file-simulator.fullname" $ }}`
- Use `$nas.name` for component name suffix: `{{ include "file-simulator.fullname" $ }}-{{ $nas.name }}`
- Use `$index` for simulator.instance label: `simulator.instance: "{{ $index }}"`
- Use `$nas.service.nodePort` for NodePort assignment
- Use `{{ $.Values.global.storage.hostPath }}/{{ $nas.name }}` for hostPath (ensures isolation)
- Keep init container + unfs3 pattern exactly as validated in Phase 1
- Resource limits from `$nas.resources` using `{{- toYaml $nas.resources | nindent 12 }}`

**From nas-test.yaml pattern (keep these exactly):**
- Init container: alpine + rsync, sync Windows mount -> emptyDir
- Main container: alpine + unfs3, serve /data on port 2049
- Security context: NET_BIND_SERVICE capability, no privileged mode
- Probes: TCP liveness/readiness on port 2049
- Volumes: windows-data (hostPath), nfs-export (emptyDir)

**Key differences from nas-test.yaml:**
- Range loop instead of single instance
- Use $nas fields instead of .Values.nasTest fields
- Use $ for root scope in include calls
- Add simulator.instance label with $index
  </action>
  <verify>
```bash
helm lint helm-chart/file-simulator
helm template file-sim helm-chart/file-simulator -f helm-chart/file-simulator/values-multi-nas.yaml --debug 2>&1 | head -50
```
Template renders without errors. Verify range loop generates resources for each NAS server.
  </verify>
  <done>nas-multi.yaml template exists, passes Helm lint, uses range loop over .Values.nasServers</done>
</task>

<task type="auto">
  <name>Task 2: Create values-multi-nas.yaml Configuration</name>
  <files>helm-chart/file-simulator/values-multi-nas.yaml</files>
  <action>
Create values-multi-nas.yaml with complete configuration for 7 NAS servers.

**Structure:**
```yaml
global:
  storage:
    hostPath: /mnt/simulator-data
    size: 10Gi
    storageClass: ""

namespace:
  create: true
  name: file-simulator

nasServers:
  # Input servers (3)
  - name: nas-input-1
    enabled: true
    initImage: {repository: alpine, tag: latest, pullPolicy: IfNotPresent}
    image: {repository: alpine, tag: latest, pullPolicy: IfNotPresent}
    service: {type: NodePort, port: 2049, nodePort: 32150}
    resources: {requests: {memory: "64Mi", cpu: "50m"}, limits: {memory: "256Mi", cpu: "200m"}}

  - name: nas-input-2  # nodePort: 32151
  - name: nas-input-3  # nodePort: 32152

  # Backup server (1)
  - name: nas-backup    # nodePort: 32153

  # Output servers (3)
  - name: nas-output-1  # nodePort: 32154
  - name: nas-output-2  # nodePort: 32155
  - name: nas-output-3  # nodePort: 32156

# Disable other protocols for Phase 2 focus
ftp: {enabled: false}
sftp: {enabled: false}
http: {enabled: false}
s3: {enabled: false}
smb: {enabled: false}
management: {enabled: false}
nasTest: {enabled: false}
```

**NodePort assignments (32150-32156):**
- nas-input-1: 32150
- nas-input-2: 32151
- nas-input-3: 32152
- nas-backup: 32153
- nas-output-1: 32154
- nas-output-2: 32155
- nas-output-3: 32156

**Resource allocation (from RESEARCH.md):**
- Total: 7 pods x 64Mi = 448Mi request (fits in 8GB Minikube)
- Each pod: 64Mi request, 256Mi limit
- CPU: 50m request, 200m limit per pod

**Add descriptive comments:**
- Section headers for input/backup/output groupings
- NodePort mapping documentation
- Resource capacity math
  </action>
  <verify>
```bash
# Verify YAML syntax
helm template file-sim helm-chart/file-simulator -f helm-chart/file-simulator/values-multi-nas.yaml 2>&1 | grep -c "kind: Deployment"
# Should output: 7

helm template file-sim helm-chart/file-simulator -f helm-chart/file-simulator/values-multi-nas.yaml 2>&1 | grep -c "kind: Service"
# Should output: 7 (or more if other services enabled)

# Verify unique NodePorts
helm template file-sim helm-chart/file-simulator -f helm-chart/file-simulator/values-multi-nas.yaml 2>&1 | grep "nodePort:" | sort | uniq -c
# Should show 7 unique ports (32150-32156)
```
  </verify>
  <done>values-multi-nas.yaml exists with 7 NAS server configs, unique NodePorts 32150-32156, proper resource limits</done>
</task>

</tasks>

<verification>
**Template Validation:**
```bash
# Helm lint
helm lint helm-chart/file-simulator

# Render and count resources
helm template file-sim helm-chart/file-simulator -f helm-chart/file-simulator/values-multi-nas.yaml --debug > /tmp/rendered.yaml

# Count Deployments (should be 7)
grep -c "kind: Deployment" /tmp/rendered.yaml

# Count Services (should be at least 7)
grep -c "kind: Service" /tmp/rendered.yaml

# Verify unique server names
grep "app.kubernetes.io/component:" /tmp/rendered.yaml | sort | uniq

# Verify unique NodePorts
grep "nodePort:" /tmp/rendered.yaml | sort | uniq

# Verify hostPath isolation
grep "path: /mnt/simulator-data" /tmp/rendered.yaml
```

**No privileged mode:**
```bash
grep -i "privileged:" /tmp/rendered.yaml
# Should show no "privileged: true" for NAS deployments
```
</verification>

<success_criteria>
1. nas-multi.yaml template renders 7 Deployment resources (one per NAS server)
2. nas-multi.yaml template renders 7 Service resources with NodePorts 32150-32156
3. Each NAS server has unique hostPath: /mnt/simulator-data/{nas-name}
4. Each NAS server can be independently disabled via enabled: false
5. No privileged: true in any NAS deployment
6. Helm lint passes without errors
7. Template uses $ for root scope in include calls (no template errors)
</success_criteria>

<output>
After completion, create `.planning/phases/02-7-server-topology/02-01-SUMMARY.md`
</output>
