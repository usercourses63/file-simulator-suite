---
phase: 02-7-server-topology
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified: []
autonomous: true

must_haves:
  truths:
    - "All 7 NAS pods are Running status in Minikube"
    - "Each NAS server accessible via unique NodePort from Windows host"
    - "Files in nas-input-1 NOT visible in nas-input-2 (storage isolation)"
    - "Subdirectories in Windows visible via NFS mount (EXP-01)"
  artifacts: []
  key_links:
    - from: "kubectl get pods"
      to: "7 NAS deployments"
      via: "selector labels"
      pattern: "simulator.protocol=nfs"
    - from: "Windows C:\\simulator-data\\*"
      to: "Pod /data directories"
      via: "init container rsync"
      pattern: "rsync.*windows-mount.*nfs-data"
---

<objective>
Deploy the 7-server NAS topology to Minikube and validate basic functionality: pod status, storage isolation, and subdirectory mounts.

Purpose: Prove the multi-instance pattern deploys correctly and meets core requirements (isolation, subdirectory support).

Output: 7 running NAS pods with validated storage isolation and subdirectory mounts.
</objective>

<execution_context>
@C:\Users\UserC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\UserC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-7-server-topology/02-RESEARCH.md
@.planning/phases/02-7-server-topology/02-01-SUMMARY.md

# Phase 1 test script pattern
@scripts/test-nas-pattern.ps1

# Values file to deploy
@helm-chart/file-simulator/values-multi-nas.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deploy 7 NAS Servers to Minikube</name>
  <files>None (deployment only)</files>
  <action>
Deploy the 7-server NAS topology using Helm.

**Pre-deployment checks:**
```bash
# Verify Minikube is running with mount
minikube status

# Check available NodePorts (32150-32156 should be free)
kubectl get svc --all-namespaces | grep -E "321[5-6][0-6]"
```

**Create Windows directories for all 7 NAS servers:**
```powershell
$nasServers = @("nas-input-1", "nas-input-2", "nas-input-3", "nas-backup", "nas-output-1", "nas-output-2", "nas-output-3")
foreach ($nas in $nasServers) {
    New-Item -ItemType Directory -Force -Path "C:\simulator-data\$nas"
    Set-Content -Path "C:\simulator-data\$nas\README.txt" -Value "This directory belongs to $nas"
}
```

**Deploy with Helm:**
```bash
helm upgrade --install file-sim ./helm-chart/file-simulator \
  -f ./helm-chart/file-simulator/values-multi-nas.yaml \
  --namespace file-simulator \
  --create-namespace
```

**Wait for all pods to be ready:**
```bash
kubectl wait --for=condition=Ready pod -l simulator.protocol=nfs -n file-simulator --timeout=180s
```

**Verify deployment:**
```bash
kubectl get pods -n file-simulator -l simulator.protocol=nfs
# Should show 7 pods all in Running state
```

**If any pods fail to start:**
1. Check pod events: `kubectl describe pod <pod-name> -n file-simulator`
2. Check init container logs: `kubectl logs <pod-name> -c sync-windows-data -n file-simulator`
3. Check main container logs: `kubectl logs <pod-name> -c nfs-server -n file-simulator`
4. Verify Windows directories exist: `ls C:\simulator-data\`
  </action>
  <verify>
```bash
kubectl get pods -n file-simulator -l simulator.protocol=nfs -o wide
# All 7 pods should be Running with 1/1 READY

kubectl get svc -n file-simulator -l simulator.protocol=nfs
# All 7 services should exist with NodePorts
```
  </verify>
  <done>All 7 NAS pods (nas-input-1/2/3, nas-backup, nas-output-1/2/3) running with 1/1 READY status</done>
</task>

<task type="auto">
  <name>Task 2: Validate Storage Isolation and Subdirectory Mounts (EXP-01)</name>
  <files>None (validation only)</files>
  <action>
Verify that each NAS server sees only its own files and subdirectories are correctly mounted.

**Create unique test files on Windows (one per NAS):**
```powershell
$nasServers = @("nas-input-1", "nas-input-2", "nas-input-3", "nas-backup", "nas-output-1", "nas-output-2", "nas-output-3")
foreach ($nas in $nasServers) {
    Set-Content -Path "C:\simulator-data\$nas\isolation-test-$nas.txt" -Value "This file should ONLY be visible in $nas"
}
```

**Create subdirectory structure for EXP-01 validation:**
```powershell
# Create subdirectories in nas-input-1 to test EXP-01
New-Item -ItemType Directory -Force -Path "C:\simulator-data\nas-input-1\sub-1"
New-Item -ItemType Directory -Force -Path "C:\simulator-data\nas-input-1\sub-1\nested"
Set-Content -Path "C:\simulator-data\nas-input-1\sub-1\subdir-test.txt" -Value "File in subdirectory sub-1"
Set-Content -Path "C:\simulator-data\nas-input-1\sub-1\nested\deep-test.txt" -Value "File in nested subdirectory"
```

**Restart all NAS pods to trigger init container sync:**
```bash
kubectl delete pods -n file-simulator -l simulator.protocol=nfs
kubectl wait --for=condition=Ready pod -l simulator.protocol=nfs -n file-simulator --timeout=180s
```

**Verify each pod sees only its own test file:**
```bash
# For each NAS server, count txt files in /data
# Each should see exactly 2 files: README.txt + isolation-test-{name}.txt

for nas in nas-input-1 nas-input-2 nas-input-3 nas-backup nas-output-1 nas-output-2 nas-output-3; do
  echo "=== $nas ==="
  POD=$(kubectl get pod -n file-simulator -l app.kubernetes.io/component=$nas -o jsonpath='{.items[0].metadata.name}')
  kubectl exec -n file-simulator $POD -- ls -la /data
  echo "File count: $(kubectl exec -n file-simulator $POD -- sh -c 'ls /data/*.txt 2>/dev/null | wc -l')"
  echo ""
done
```

**Verify subdirectory mount (EXP-01):**
```bash
# nas-input-1 should see subdirectory structure
POD=$(kubectl get pod -n file-simulator -l app.kubernetes.io/component=nas-input-1 -o jsonpath='{.items[0].metadata.name}')

# Check subdirectory exists
kubectl exec -n file-simulator $POD -- ls -la /data/sub-1/
# Should show: subdir-test.txt, nested/

# Check nested subdirectory
kubectl exec -n file-simulator $POD -- ls -la /data/sub-1/nested/
# Should show: deep-test.txt

# Read file from subdirectory
kubectl exec -n file-simulator $POD -- cat /data/sub-1/subdir-test.txt
# Should output: "File in subdirectory sub-1"

# Read file from nested subdirectory
kubectl exec -n file-simulator $POD -- cat /data/sub-1/nested/deep-test.txt
# Should output: "File in nested subdirectory"
```

**Isolation test (critical):**
- nas-input-1 should NOT see isolation-test-nas-input-2.txt
- Each pod should see exactly 2 .txt files in root (README + its own isolation test)
- nas-input-1 should see sub-1/ directory with nested content

**If isolation fails:**
- Check hostPath in deployment: `kubectl get deployment -n file-simulator -o yaml | grep "path:"`
- Verify each deployment has unique path
  </action>
  <verify>
Each NAS pod shows exactly 2 .txt files in root (README.txt and its own isolation-test file).
No pod shows files from other NAS servers.
nas-input-1 shows sub-1/subdir-test.txt and sub-1/nested/deep-test.txt (EXP-01).
  </verify>
  <done>Storage isolation verified - each NAS sees only its own directory contents; subdirectory mounts work (EXP-01)</done>
</task>

</tasks>

<verification>
**Deployment Status:**
```bash
kubectl get pods -n file-simulator -l simulator.protocol=nfs -o wide
kubectl get svc -n file-simulator -l simulator.protocol=nfs
```

**Storage Isolation (must pass):**
```bash
# Each pod should see exactly its own files
for nas in nas-input-1 nas-input-2 nas-input-3 nas-backup nas-output-1 nas-output-2 nas-output-3; do
  POD=$(kubectl get pod -n file-simulator -l app.kubernetes.io/component=$nas -o jsonpath='{.items[0].metadata.name}')
  echo "$nas: $(kubectl exec -n file-simulator $POD -- sh -c 'ls /data/ | wc -l') files"
done
```

**Subdirectory Mounts (EXP-01):**
```bash
POD=$(kubectl get pod -n file-simulator -l app.kubernetes.io/component=nas-input-1 -o jsonpath='{.items[0].metadata.name}')
kubectl exec -n file-simulator $POD -- ls -laR /data/sub-1/
```

**Security Context:**
```bash
kubectl get pods -n file-simulator -l simulator.protocol=nfs -o jsonpath='{range .items[*]}{.metadata.name}: privileged={.spec.containers[0].securityContext.privileged}{"\n"}{end}'
# Should show no "privileged=true"
```
</verification>

<success_criteria>
1. All 7 NAS pods deployed and Running (1/1 READY)
2. Each NAS server has unique NodePort (32150-32156) accessible
3. Storage isolation verified (nas-input-1 files NOT visible in nas-input-2)
4. Subdirectory mounts work (EXP-01) - Windows subdirs visible via NFS
5. No privileged security context on any NAS pod
</success_criteria>

<output>
After completion, create `.planning/phases/02-7-server-topology/02-02-SUMMARY.md`
</output>
