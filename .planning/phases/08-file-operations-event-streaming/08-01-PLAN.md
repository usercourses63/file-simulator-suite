---
phase: 08-file-operations-event-streaming
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/FileSimulator.ControlApi/Models/FileEventDto.cs
  - src/FileSimulator.ControlApi/Services/FileWatcherService.cs
  - src/FileSimulator.ControlApi/Hubs/FileEventsHub.cs
  - src/FileSimulator.ControlApi/Program.cs
autonomous: true

must_haves:
  truths:
    - "FileSystemWatcher monitors C:\\simulator-data directory recursively"
    - "File events are debounced (500ms) before broadcasting"
    - "SignalR hub broadcasts file events to all connected clients"
    - "Buffer overflow is detected and logged"
  artifacts:
    - path: "src/FileSimulator.ControlApi/Models/FileEventDto.cs"
      provides: "File event data transfer object"
      contains: "class FileEventDto"
    - path: "src/FileSimulator.ControlApi/Services/FileWatcherService.cs"
      provides: "FileSystemWatcher with debouncing"
      contains: "class FileWatcherService"
      min_lines: 100
    - path: "src/FileSimulator.ControlApi/Hubs/FileEventsHub.cs"
      provides: "SignalR hub for file events"
      contains: "class FileEventsHub"
  key_links:
    - from: "src/FileSimulator.ControlApi/Services/FileWatcherService.cs"
      to: "FileEventsHub"
      via: "IHubContext injection"
      pattern: "IHubContext<FileEventsHub>"
    - from: "src/FileSimulator.ControlApi/Program.cs"
      to: "FileWatcherService"
      via: "AddHostedService registration"
      pattern: "AddHostedService.*FileWatcherService"
---

<objective>
Implement backend FileSystemWatcher service with debouncing and SignalR broadcasting for real-time file event streaming.

Purpose: Enable real-time file event notifications when files are created, modified, deleted, or renamed in the Windows simulator-data directory.

Output:
- FileEventDto model for file event data
- FileWatcherService BackgroundService with 500ms debouncing
- FileEventsHub SignalR hub for file event broadcasting
- Program.cs wired with new services
</objective>

<execution_context>
@C:\Users\UserC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\UserC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-file-operations-event-streaming/08-RESEARCH.md

# Existing backend patterns
@src/FileSimulator.ControlApi/Program.cs
@src/FileSimulator.ControlApi/Hubs/ServerStatusHub.cs
@src/FileSimulator.ControlApi/Services/ServerStatusBroadcaster.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FileEventDto model and FileEventsHub</name>
  <files>
    src/FileSimulator.ControlApi/Models/FileEventDto.cs
    src/FileSimulator.ControlApi/Hubs/FileEventsHub.cs
  </files>
  <action>
Create FileEventDto.cs in Models folder:
- Path (string): Full path to the file
- RelativePath (string): Path relative to base directory
- FileName (string): Just the filename
- EventType (string): Created, Modified, Deleted, Renamed
- OldPath (string?): For rename events, the previous path
- Timestamp (DateTime): When event occurred
- Protocols (List<string>): Which protocols can see this file (based on directory mapping)
- IsDirectory (bool): Whether this is a directory event

Create FileEventsHub.cs in Hubs folder following ServerStatusHub pattern:
- Constructor with ILogger<FileEventsHub>
- OnConnectedAsync logging connection
- OnDisconnectedAsync logging disconnection
- No client-callable methods needed (push-only hub)

Protocol mapping for GetVisibleProtocols based on actual C:\simulator-data structure:
- nas-input-1, nas-input-2, nas-input-3 -> ["NAS"]
- nas-output-1, nas-output-2, nas-output-3 -> ["NAS"]
- nas-backup -> ["NAS"]
- ftpuser -> ["FTP"]
- nfs -> ["NFS"]
- input, output, processed, archive -> ["FTP", "SFTP", "HTTP", "S3", "SMB", "NFS"] (shared)
- Default -> empty list

Do NOT include .minio.sys or .deleted directories in protocol mapping.
  </action>
  <verify>
Files exist and compile:
```powershell
dotnet build src/FileSimulator.ControlApi/FileSimulator.ControlApi.csproj
```
  </verify>
  <done>FileEventDto model has all required properties. FileEventsHub follows existing hub pattern with proper logging.</done>
</task>

<task type="auto">
  <name>Task 2: Create FileWatcherService with debouncing</name>
  <files>
    src/FileSimulator.ControlApi/Services/FileWatcherService.cs
  </files>
  <action>
Create FileWatcherService.cs as a BackgroundService:

1. Constructor injection:
   - IConfiguration (for WindowsDataPath, default "C:\\simulator-data")
   - IHubContext<FileEventsHub> for broadcasting
   - ILogger<FileWatcherService>

2. FileSystemWatcher configuration:
   - Path from config["FileWatcher:Path"] ?? @"C:\simulator-data"
   - NotifyFilter: FileName | DirectoryName | LastWrite | Size
   - IncludeSubdirectories = true
   - InternalBufferSize = 65536 (64 KB maximum for network shares)
   - EnableRaisingEvents = false (start in ExecuteAsync)

3. Event handlers:
   - Created, Changed, Deleted -> OnFileSystemEvent
   - Renamed -> OnRenamed (handles OldPath)
   - Error -> OnError (CRITICAL: log InternalBufferOverflowException)

4. Debouncing with Dictionary<string, Timer>:
   - Key: "{fullPath}:{eventType}"
   - 500ms timer delay
   - Cancel existing timer if new event for same key
   - Thread-safe with lock object

5. Protocol visibility detection via GetVisibleProtocols(string fullPath):
   - Extract top-level directory from path
   - Map to protocol list per mapping in Task 1

6. Circular buffer for event history:
   - Private List<FileEventDto> with max 50 events
   - Lock for thread safety
   - GetRecentEvents(int count) method

7. Broadcast via SignalR:
   - _hubContext.Clients.All.SendAsync("FileEvent", dto)
   - Log each broadcast at Debug level

8. Dispose properly:
   - Dispose FileSystemWatcher
   - Dispose all timers in dictionary
   - Clear circular buffer

CRITICAL: Handle InternalBufferOverflowException in OnError - log at Critical level. This is the main pitfall with network mounts.
  </action>
  <verify>
File compiles and service registered:
```powershell
dotnet build src/FileSimulator.ControlApi/FileSimulator.ControlApi.csproj
```
  </verify>
  <done>FileWatcherService monitors directory, debounces events at 500ms, broadcasts via SignalR, logs buffer overflow.</done>
</task>

<task type="auto">
  <name>Task 3: Wire services into Program.cs</name>
  <files>
    src/FileSimulator.ControlApi/Program.cs
  </files>
  <action>
Update Program.cs to register new services:

1. Add using for FileEventsHub

2. Register FileWatcherService as singleton and hosted service:
```csharp
builder.Services.AddSingleton<FileWatcherService>();
builder.Services.AddHostedService(sp => sp.GetRequiredService<FileWatcherService>());
```

3. Map FileEventsHub:
```csharp
app.MapHub<FileEventsHub>("/hubs/fileevents");
```

4. Update root endpoint to include new hub URL:
```csharp
endpoints = new[]
{
    "/health",
    "/hubs/status",
    "/hubs/fileevents",  // NEW
    "/api/version",
    "/api/servers",
    "/api/status",
    "/api/servers/{name}",
    "/api/files",        // Placeholder for Plan 02
    "/api/files/tree",   // Placeholder for Plan 02
    "/api/files/upload", // Placeholder for Plan 02
    "/api/files/download" // Placeholder for Plan 02
}
```

5. Add startup log:
```csharp
Log.Information("FileEvents hub available at /hubs/fileevents");
```
  </action>
  <verify>
Build and run locally:
```powershell
dotnet build src/FileSimulator.ControlApi/FileSimulator.ControlApi.csproj
```

If C:\simulator-data exists, test locally:
```powershell
cd src/FileSimulator.ControlApi
dotnet run
# In another terminal, create a test file
echo "test" > C:\simulator-data\test-event.txt
# Check logs for "Broadcast Created for C:\simulator-data\test-event.txt"
```
  </verify>
  <done>Program.cs registers FileWatcherService as hosted service and maps /hubs/fileevents endpoint.</done>
</task>

</tasks>

<verification>
1. Solution builds: `dotnet build src/FileSimulator.ControlApi/FileSimulator.ControlApi.csproj`
2. FileWatcherService starts monitoring on startup (check logs)
3. FileEventsHub accepts connections at /hubs/fileevents
4. Creating a file in C:\simulator-data triggers debounced broadcast
</verification>

<success_criteria>
- FileSystemWatcher monitors C:\simulator-data recursively
- Events debounced at 500ms window
- SignalR broadcasts FileEvent messages to /hubs/fileevents
- Buffer overflow detected and logged at Critical level
- Protocol visibility correctly mapped per directory structure
</success_criteria>

<output>
After completion, create `.planning/phases/08-file-operations-event-streaming/08-01-SUMMARY.md`
</output>
