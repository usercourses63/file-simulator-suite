---
phase: 14-comprehensive-api-driven-integration-testing
plan: 10
type: execute
wave: 6
depends_on: ["14-08"]
files_modified:
  - tests/FileSimulator.IntegrationTests/Protocols/FtpProtocolTests.cs
  - tests/FileSimulator.IntegrationTests/DynamicServers/DynamicFtpServerTests.cs
  - tests/FileSimulator.IntegrationTests/CrossProtocol/CrossProtocolFileVisibilityTests.cs
  - tests/FileSimulator.IntegrationTests/Kafka/KafkaProduceConsumeTests.cs
  - tests/FileSimulator.IntegrationTests/Api/AlertApiTests.cs
  - src/FileSimulator.TestConsole/NasServerTests.cs
autonomous: true

must_haves:
  truths:
    - "All FTP tests pass using active mode"
    - "Kafka API tests use correct endpoint URLs"
    - "Alert API tests validate all endpoints"
    - "TestConsole runs without unhandled exceptions"
    - "100% pass rate achieved (excluding expected SMB skips)"
  artifacts:
    - path: "tests/FileSimulator.IntegrationTests/Api/AlertApiTests.cs"
      provides: "Alert API integration tests"
      contains: "api/alerts"
  key_links:
    - from: "tests/FileSimulator.IntegrationTests/Kafka/KafkaProduceConsumeTests.cs"
      to: "/api/kafka/topics/{name}/messages"
      via: "POST/GET"
      pattern: "topics.*messages"
---

<objective>
Fix all integration test failures to achieve 100% pass rate.

Purpose: Ensure all tests validate the complete simulator infrastructure without failures. Fix FTP passive mode issues, Kafka API endpoint URLs, add alert tests, and fix TestConsole.

Output: 100% test pass rate with all protocols, dynamic servers, Kafka, and alerts fully tested.
</objective>

<execution_context>
@C:\Users\UserC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\UserC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix FTP active mode in CrossProtocolFileVisibilityTests</name>
  <files>
    tests/FileSimulator.IntegrationTests/CrossProtocol/CrossProtocolFileVisibilityTests.cs
  </files>
  <action>
Add FTP active mode configuration to all FTP client instances in CrossProtocolFileVisibilityTests:

```csharp
ftpClient.Config.DataConnectionType = FtpDataConnectionType.AutoActive;
ftpClient.Config.DataConnectionConnectTimeout = 10000;
```

Apply to all test methods that create FTP clients:
- FtpToSftp_FileVisibility
- FtpToWebDav_FileVisibility
- S3ToFtp_FileVisibility
- AllProtocols_SharedStorageConsistency
  </action>
  <verify>
Run `dotnet test tests/FileSimulator.IntegrationTests --filter "FullyQualifiedName~CrossProtocolFileVisibilityTests"` - all tests pass.
  </verify>
  <done>
Cross-protocol tests pass with FTP active mode.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix Kafka API endpoint URLs</name>
  <files>
    tests/FileSimulator.IntegrationTests/Kafka/KafkaProduceConsumeTests.cs
  </files>
  <action>
Fix incorrect Kafka API endpoint URLs:

Current (wrong):
- `POST /api/kafka/produce`
- `GET /api/kafka/consume/{topic}`

Correct:
- `POST /api/kafka/topics/{topicName}/messages`
- `GET /api/kafka/topics/{topicName}/messages?count=N`

Update all occurrences in KafkaProduceConsumeTests.cs:
1. Replace `/api/kafka/produce` with `/api/kafka/topics/{topicName}/messages`
2. Replace `/api/kafka/consume/{topic}` with `/api/kafka/topics/{topicName}/messages?count=N&timeout=10`
3. Update request body structure if needed
  </action>
  <verify>
Run `dotnet test tests/FileSimulator.IntegrationTests --filter "FullyQualifiedName~KafkaProduceConsumeTests"` - all tests pass.
  </verify>
  <done>
Kafka API tests use correct endpoints and all pass.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Alert API integration tests</name>
  <files>
    tests/FileSimulator.IntegrationTests/Api/AlertApiTests.cs
  </files>
  <action>
Create `Api/AlertApiTests.cs` with tests for all alert endpoints:

1. [Collection("Simulator")] attribute
2. Constructor takes SimulatorCollectionFixture

Tests to implement:
- Alerts_GetActive_ReturnsResponse
- Alerts_GetHistory_ReturnsAlerts
- Alerts_GetHistory_FiltersBySeverity
- Alerts_GetStats_ReturnsStatistics
- Alerts_GetById_ReturnsNotFoundForInvalidId

API endpoints:
- GET /api/alerts/active
- GET /api/alerts/history
- GET /api/alerts/history?severity=critical
- GET /api/alerts/stats
- GET /api/alerts/{id}
  </action>
  <verify>
Run `dotnet test tests/FileSimulator.IntegrationTests --filter "FullyQualifiedName~AlertApiTests"` - all tests pass.
  </verify>
  <done>
Alert API tests created and passing.
  </done>
</task>

<task type="auto">
  <name>Task 4: Fix TestConsole legacy NFS entry</name>
  <files>
    src/FileSimulator.TestConsole/NasServerTests.cs
  </files>
  <action>
The TestConsole has a legacy "Nfs" entry in connection info that fails TCP connection.
All actual NAS servers (nas-input-*, nas-output-*, nas-backup) work correctly.

Fix by filtering out the generic "Nfs" entry and only testing actual NAS servers.
The NAS servers are identified by names starting with "nas-".
  </action>
  <verify>
Run `cd src/FileSimulator.TestConsole && dotnet run -- --api-url http://file-simulator.local:30500` - completes without errors.
  </verify>
  <done>
TestConsole runs without NFS errors.
  </done>
</task>

<task type="auto">
  <name>Task 5: Run full test suite and verify 100%</name>
  <files>
    scripts/Run-IntegrationTests.ps1
  </files>
  <action>
Run the complete test suite and verify all tests pass:

```powershell
.\scripts\Run-IntegrationTests.ps1
```

Expected results:
- All FTP protocol tests: PASS
- All FTP dynamic server tests: PASS
- All Kafka API tests: PASS
- All cross-protocol tests: PASS
- All alert API tests: PASS
- SMB tests: SKIP (requires tunnel) - acceptable
- Total: 100% pass (excluding expected skips)
  </action>
  <verify>
JUnit XML shows 0 failures. TestConsole completes without errors.
  </verify>
  <done>
100% pass rate achieved.
  </done>
</task>

</tasks>

<verification>
1. `dotnet test tests/FileSimulator.IntegrationTests` exits 0
2. JUnit XML shows 0 failures
3. TestConsole runs without unhandled exceptions
4. All protocols tested: FTP, SFTP, HTTP, WebDAV, S3, NFS
5. Dynamic servers tested: FTP, SFTP, NAS
6. Kafka tested: topics, produce/consume
7. Alerts tested: active, history, stats
</verification>

<success_criteria>
- 100% pass rate (excluding expected SMB tunnel skips)
- All FTP tests pass with active mode
- All Kafka API tests use correct endpoints
- Alert API fully tested
- TestConsole completes without errors
- No orphaned test resources
</success_criteria>

<output>
After completion, create `.planning/phases/14-comprehensive-api-driven-integration-testing/14-10-SUMMARY.md`
</output>
