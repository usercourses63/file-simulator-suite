---
phase: 14-comprehensive-api-driven-integration-testing
plan: 06
type: execute
wave: 3
depends_on: ["14-02", "14-03"]
files_modified:
  - tests/FileSimulator.IntegrationTests/CrossProtocol/CrossProtocolFileVisibilityTests.cs
  - tests/FileSimulator.IntegrationTests/Kafka/KafkaTopicManagementTests.cs
  - tests/FileSimulator.IntegrationTests/Kafka/KafkaProduceConsumeTests.cs
autonomous: true

must_haves:
  truths:
    - "File uploaded via FTP is visible via SFTP"
    - "File uploaded via SFTP is visible via HTTP"
    - "File uploaded via S3 is visible via WebDAV"
    - "Kafka topic can be created via API"
    - "Kafka messages can be produced and consumed via API"
  artifacts:
    - path: "tests/FileSimulator.IntegrationTests/CrossProtocol/CrossProtocolFileVisibilityTests.cs"
      provides: "Cross-protocol file visibility tests"
      contains: "VisibleVia"
    - path: "tests/FileSimulator.IntegrationTests/Kafka/KafkaTopicManagementTests.cs"
      provides: "Kafka topic management tests"
      contains: "api/kafka/topics"
    - path: "tests/FileSimulator.IntegrationTests/Kafka/KafkaProduceConsumeTests.cs"
      provides: "Kafka produce/consume tests"
      contains: "ProduceAsync"
  key_links:
    - from: "tests/FileSimulator.IntegrationTests/CrossProtocol/CrossProtocolFileVisibilityTests.cs"
      to: "shared PVC"
      via: "file operations across protocols"
      pattern: "Upload.*Visible"
---

<objective>
Implement cross-protocol file visibility tests and Kafka integration tests.

Purpose: Validate that the shared storage (PVC) allows files uploaded via one protocol to be visible via other protocols. Also validate Kafka topic lifecycle and message produce/consume operations.

Output: Cross-protocol file visibility tests and complete Kafka integration tests.
</objective>

<execution_context>
@C:\Users\UserC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\UserC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-comprehensive-api-driven-integration-testing/14-RESEARCH.md
@src/FileSimulator.TestConsole/CrossProtocolTest.cs (existing patterns)
@src/FileSimulator.TestConsole/KafkaTests.cs (Kafka patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cross-protocol file visibility tests</name>
  <files>
    tests/FileSimulator.IntegrationTests/CrossProtocol/CrossProtocolFileVisibilityTests.cs
  </files>
  <action>
Create `CrossProtocol/CrossProtocolFileVisibilityTests.cs`:

1. Class structure:
   - [Collection("Simulator")] attribute
   - Constructor takes SimulatorCollectionFixture
   - Helper method: WaitForFileVisibility(listFunc, fileName, timeout) - polls until file appears

2. Test: FtpToSftp_FileVisibility()
   - Upload unique file via FTP to /output
   - Wait 500ms for filesystem sync
   - List files via SFTP in /data/output
   - Assert file appears in SFTP listing (with retry/polling for sync delay)
   - Cleanup: Delete via FTP

3. Test: SftpToHttp_FileVisibility()
   - Upload unique file via SFTP to /data/output
   - Wait 500ms
   - GET file list via HTTP /api/files/output
   - Assert file appears in HTTP JSON response
   - Cleanup: Delete via SFTP

4. Test: FtpToWebDav_FileVisibility()
   - Upload unique file via FTP to /output
   - Wait 500ms
   - List via WebDAV GET /output/
   - Assert filename appears in HTML directory listing
   - Cleanup: Delete via FTP

5. Test: S3ToFtp_FileVisibility()
   - Upload unique file via S3 to output bucket
   - Wait 500ms
   - List via FTP /output
   - Assert file appears in FTP listing
   - Cleanup: Delete via S3

6. Test: AllProtocols_SharedStorageConsistency()
   - Upload file via FTP
   - Verify visible via: SFTP, HTTP, WebDAV
   - Download via each protocol
   - Assert content matches
   - Cleanup: Delete via FTP

7. Retry pattern for visibility checks:
   ```csharp
   var fileVisible = await Policy
       .HandleResult<bool>(visible => !visible)
       .WaitAndRetryAsync(5, _ => TimeSpan.FromMilliseconds(500))
       .ExecuteAsync(async () =>
       {
           var files = await ListFilesAsync();
           return files.Any(f => f.Contains(fileName));
       });
   fileVisible.Should().BeTrue("file should be visible within 2.5 seconds");
   ```

All tests must cleanup files in finally block.
  </action>
  <verify>
Run `dotnet test tests/FileSimulator.IntegrationTests --filter "FullyQualifiedName~CrossProtocolFileVisibilityTests"` - tests pass.
  </verify>
  <done>
Cross-protocol file visibility verified for FTP, SFTP, HTTP, WebDAV, S3.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Kafka topic management tests</name>
  <files>
    tests/FileSimulator.IntegrationTests/Kafka/KafkaTopicManagementTests.cs
  </files>
  <action>
Create `Kafka/KafkaTopicManagementTests.cs`:

1. Class structure:
   - [Collection("Simulator")] attribute
   - Constructor takes SimulatorCollectionFixture
   - Helper: GenerateTopicName() returns "test-topic-{Guid:N}"

2. Test: Kafka_CreateTopic_ViaApi()
   - Generate unique topic name
   - POST /api/kafka/topics with body: { name, partitions: 1, replicationFactor: 1 }
   - Assert response.IsSuccessStatusCode
   - Cleanup: DELETE /api/kafka/topics/{name}

3. Test: Kafka_ListTopics_ContainsCreatedTopic()
   - Create topic via API
   - GET /api/kafka/topics
   - Deserialize response to list
   - Assert created topic name in list
   - Cleanup: Delete topic

4. Test: Kafka_DeleteTopic_RemovesTopic()
   - Create topic
   - DELETE /api/kafka/topics/{name}
   - GET /api/kafka/topics
   - Assert topic no longer in list

5. Test: Kafka_CreateTopic_DirectClient()
   - Use Confluent.Kafka AdminClient directly
   - Create topic with AdminClient.CreateTopicsAsync
   - Verify via AdminClient.GetMetadata
   - Cleanup: AdminClient.DeleteTopicsAsync

6. Test: Kafka_BrokerConnectivity()
   - Use AdminClient to get broker metadata
   - Assert at least one broker exists
   - Assert broker is reachable

Configuration from appsettings.test.json:
- BootstrapServers: file-simulator.local:30093

All tests must cleanup topics in finally block.
  </action>
  <verify>
Run `dotnet test tests/FileSimulator.IntegrationTests --filter "FullyQualifiedName~KafkaTopicManagementTests"` - tests pass.
  </verify>
  <done>
Kafka topic management tests cover create, list, delete via API and direct client.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Kafka produce/consume tests</name>
  <files>
    tests/FileSimulator.IntegrationTests/Kafka/KafkaProduceConsumeTests.cs
  </files>
  <action>
Create `Kafka/KafkaProduceConsumeTests.cs`:

1. Class structure:
   - [Collection("Simulator")] attribute
   - Constructor takes SimulatorCollectionFixture
   - Helper: CreateTestTopic() - creates unique topic and returns name

2. Test: Kafka_Produce_ViaApi()
   - Create topic
   - POST /api/kafka/produce with body: { topic, key: "test-key", value: "test-value" }
   - Assert response.IsSuccessStatusCode
   - Cleanup: Delete topic

3. Test: Kafka_Consume_ViaApi()
   - Create topic
   - Produce message via API
   - Wait 500ms for message to be available
   - GET /api/kafka/consume/{topic}?count=1&timeout=10
   - Deserialize response to message list
   - Assert message has correct key and value
   - Cleanup: Delete topic

4. Test: Kafka_ProduceConsume_DirectClient()
   - Create topic
   - Use IProducer<string, string> to produce message
   - Use IConsumer<string, string> to consume (with unique consumer group)
   - Assert consumed message matches produced
   - Cleanup: Delete topic

5. Test: Kafka_ProduceMultiple_ConsumeAll()
   - Create topic
   - Produce 5 messages with keys "key-1" through "key-5"
   - Consume with count=5
   - Assert all 5 messages received
   - Assert order matches production order
   - Cleanup: Delete topic

6. Test: Kafka_FullCycle_ApiEndToEnd()
   - Create topic via API
   - Produce message via API
   - Consume message via API
   - Verify message content
   - Delete topic via API
   - Verify topic gone

Consumer configuration:
- Unique GroupId per test: $"test-group-{Guid.NewGuid():N}"
- AutoOffsetReset: Earliest
- EnableAutoCommit: false

All tests must cleanup topics in finally block.
  </action>
  <verify>
Run `dotnet test tests/FileSimulator.IntegrationTests --filter "FullyQualifiedName~KafkaProduceConsumeTests"` - tests pass.
  </verify>
  <done>
Kafka produce/consume tests cover API and direct client patterns.
  </done>
</task>

</tasks>

<verification>
1. Cross-protocol tests: 5 tests pass demonstrating file visibility across protocols
2. Kafka topic tests: 5 tests pass covering create, list, delete
3. Kafka produce/consume tests: 5 tests pass covering message flow
4. No orphaned topics left after tests
5. No orphaned test files left in shared storage
</verification>

<success_criteria>
- Cross-protocol: Files uploaded via FTP visible via SFTP, HTTP, WebDAV (and vice versa)
- Kafka topics: Create, list, delete work via both API and direct client
- Kafka messages: Produce and consume work via both API and direct client
- Message content verified: key and value match after produce/consume cycle
</success_criteria>

<output>
After completion, create `.planning/phases/14-comprehensive-api-driven-integration-testing/14-06-SUMMARY.md`
</output>
