---
phase: 14-comprehensive-api-driven-integration-testing
plan: 07
type: execute
wave: 3
depends_on: ["14-03"]
files_modified:
  - tests/FileSimulator.IntegrationTests/NasServers/MultiNasServerTests.cs
  - tests/FileSimulator.IntegrationTests/Api/ConnectionInfoApiTests.cs
autonomous: true

must_haves:
  truths:
    - "All 7 static NAS servers (input-1/2/3, output-1/2/3, backup) are accessible"
    - "Each NAS server can be tested independently for file operations"
    - "Connection info API returns credentials for all protocols"
    - "Connection info includes all 7 NAS servers with correct ports"
  artifacts:
    - path: "tests/FileSimulator.IntegrationTests/NasServers/MultiNasServerTests.cs"
      provides: "Tests for all 7 NAS servers independently"
      contains: "nas-input-1"
    - path: "tests/FileSimulator.IntegrationTests/Api/ConnectionInfoApiTests.cs"
      provides: "API credential validation tests"
      contains: "connection-info"
  key_links:
    - from: "tests/FileSimulator.IntegrationTests/NasServers/MultiNasServerTests.cs"
      to: "/api/connection-info"
      via: "GetConnectionInfoAsync"
      pattern: "nas-input-\\d"
---

<objective>
Implement multi-NAS server tests (7 servers) and connection info API validation.

Purpose: Validate that all 7 static NAS servers (input-1, input-2, input-3, output-1, output-2, output-3, backup) are fully functional, and that the connection info API returns correct credentials for all protocols.

Output: Comprehensive tests for all NAS servers and API credential validation.
</objective>

<execution_context>
@C:\Users\UserC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\UserC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-comprehensive-api-driven-integration-testing/14-RESEARCH.md
@src/FileSimulator.TestConsole/NasServerTests.cs (NAS test patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create multi-NAS server tests</name>
  <files>
    tests/FileSimulator.IntegrationTests/NasServers/MultiNasServerTests.cs
  </files>
  <action>
Create `NasServers/MultiNasServerTests.cs`:

1. Class structure:
   - [Collection("Simulator")] attribute
   - Constructor takes SimulatorCollectionFixture
   - Helper: GetNasServersFromConnectionInfo() - filters NAS servers from connection info

2. Test: AllNasServers_TcpConnectivity()
   - Get all NAS servers from connection info
   - For each NAS server, attempt TCP connection
   - Collect results: server name, success/fail, latency
   - Assert all 7 servers are TCP reachable
   - Output summary table for debugging

3. Theory: NasServer_TcpReachable (per server)
   - [Theory]
   - [InlineData("nas-input-1")]
   - [InlineData("nas-input-2")]
   - [InlineData("nas-input-3")]
   - [InlineData("nas-output-1")]
   - [InlineData("nas-output-2")]
   - [InlineData("nas-output-3")]
   - [InlineData("nas-backup")]
   - Test TCP connectivity for specific server

4. Theory: NasServer_FileOperations_WhenMounted (per server)
   - [Theory] with same InlineData
   - Skip if mount path doesn't exist for server
   - Test write (skip for backup - read-only), read, list, delete
   - Each server has mount path: C:\simulator-data\{server-name}

5. Test: InputServers_AreWritable()
   - For nas-input-1, nas-input-2, nas-input-3
   - Skip if mounts not available
   - Write test file to each
   - Assert writes succeed
   - Cleanup: delete files

6. Test: OutputServers_AreWritable()
   - For nas-output-1, nas-output-2, nas-output-3
   - Skip if mounts not available
   - Write test file to each
   - Assert writes succeed
   - Cleanup: delete files

7. Test: BackupServer_IsReadOnly()
   - For nas-backup
   - Skip if mount not available
   - Verify read operations work
   - Note: Backup server is typically read-only, so write test may be skipped

8. Test: AllNasServers_HaveDifferentPorts()
   - Get all NAS servers from connection info
   - Assert each server has unique port
   - Assert ports are in valid range (32049-32055 or similar)

Mount path detection for each NAS server:
- Windows: C:\simulator-data\{server-name} (e.g., C:\simulator-data\nas-input-1)
- Check Directory.Exists() before file operation tests
  </action>
  <verify>
Run `dotnet test tests/FileSimulator.IntegrationTests --filter "FullyQualifiedName~MultiNasServerTests"` - TCP tests pass, file tests pass if mounted.
  </verify>
  <done>
All 7 NAS servers tested for TCP connectivity and file operations (when mounted).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create connection info API validation tests</name>
  <files>
    tests/FileSimulator.IntegrationTests/Api/ConnectionInfoApiTests.cs
  </files>
  <action>
Create `Api/ConnectionInfoApiTests.cs`:

1. Class structure:
   - [Collection("Simulator")] attribute
   - Constructor takes SimulatorCollectionFixture

2. Test: ConnectionInfo_ReturnsAllProtocols()
   - GET /api/connection-info
   - Assert response contains: Ftp, Sftp, Http, WebDav, S3, Smb, Nfs (or equivalent keys)
   - Assert no null values for required protocols

3. Test: ConnectionInfo_FtpCredentials_AreValid()
   - Get connection info
   - Assert Ftp.Host is not null/empty
   - Assert Ftp.Port > 0
   - Assert Ftp.Username is not null/empty
   - Assert Ftp.Password is not null/empty
   - Try connecting with credentials to verify they work

4. Test: ConnectionInfo_SftpCredentials_AreValid()
   - Same pattern as FTP but for SFTP

5. Test: ConnectionInfo_S3Credentials_AreValid()
   - Assert S3.ServiceUrl is valid URL
   - Assert S3.AccessKey and S3.SecretKey are not null/empty
   - Try listing buckets to verify credentials work

6. Test: ConnectionInfo_WebDavCredentials_AreValid()
   - Assert WebDav.BaseUrl is valid URL
   - Assert WebDav.Username and WebDav.Password are not null/empty
   - Try GET with auth to verify credentials work

7. Test: ConnectionInfo_SmbCredentials_Present()
   - Assert Smb.Host and Smb.Port are valid
   - Assert Smb.Username and Smb.Password are not null/empty
   - Assert Smb.ShareName is not null/empty
   - (Don't test actual connection - requires tunnel)

8. Test: ConnectionInfo_NasServers_AllPresent()
   - Get connection info
   - Filter for NAS servers (keys containing "nas")
   - Assert count >= 7 (input-1/2/3, output-1/2/3, backup)
   - Assert each NAS server has Host and Port

9. Test: ConnectionInfo_KafkaBootstrap_Present()
   - Assert Kafka.BootstrapServers is not null/empty
   - Assert format is host:port

10. Test: ConnectionInfo_Formats_ReturnCorrectContentType()
    - GET /api/connection-info (JSON default)
    - GET /api/connection-info?format=env (text)
    - GET /api/connection-info?format=yaml (text)
    - GET /api/connection-info?format=dotnet (JSON)
    - Assert correct Content-Type headers
  </action>
  <verify>
Run `dotnet test tests/FileSimulator.IntegrationTests --filter "FullyQualifiedName~ConnectionInfoApiTests"` - all tests pass.
  </verify>
  <done>
Connection info API validated for all protocols and all 7 NAS servers.
  </done>
</task>

</tasks>

<verification>
1. Multi-NAS tests: TCP tests pass for all 7 servers
2. Multi-NAS tests: File operation tests pass when mounts available
3. Connection info tests: All protocol credentials present and valid
4. Connection info tests: All 7 NAS servers present with unique ports
5. Connection info tests: All format options return correct content type
</verification>

<success_criteria>
- All 7 NAS servers (input-1/2/3, output-1/2/3, backup) are TCP reachable
- Each NAS server can perform file operations when mounted
- Connection info API returns valid credentials for all protocols
- Credentials actually work when used to connect to services
- NAS servers have unique ports for proper service discovery
</success_criteria>

<output>
After completion, create `.planning/phases/14-comprehensive-api-driven-integration-testing/14-07-SUMMARY.md`
</output>
