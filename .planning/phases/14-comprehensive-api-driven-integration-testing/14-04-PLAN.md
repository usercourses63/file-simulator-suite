---
phase: 14-comprehensive-api-driven-integration-testing
plan: 04
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - tests/FileSimulator.IntegrationTests/DynamicServers/FtpServerLifecycleTests.cs
  - tests/FileSimulator.IntegrationTests/DynamicServers/SftpServerLifecycleTests.cs
  - tests/FileSimulator.IntegrationTests/Support/DynamicServerHelpers.cs
autonomous: true

must_haves:
  truths:
    - "Dynamic FTP server can be created via API"
    - "Dynamic FTP server becomes ready within 60 seconds"
    - "Dynamic FTP server accepts connections and file operations"
    - "Dynamic FTP server is deleted and resources cleaned up"
    - "Dynamic SFTP server lifecycle works identically to FTP"
  artifacts:
    - path: "tests/FileSimulator.IntegrationTests/DynamicServers/FtpServerLifecycleTests.cs"
      provides: "Dynamic FTP server lifecycle tests"
      contains: "CreateServerAsync"
    - path: "tests/FileSimulator.IntegrationTests/DynamicServers/SftpServerLifecycleTests.cs"
      provides: "Dynamic SFTP server lifecycle tests"
      contains: "CreateServerAsync"
    - path: "tests/FileSimulator.IntegrationTests/Support/DynamicServerHelpers.cs"
      provides: "API helpers for dynamic server management"
      exports: ["CreateServerAsync", "WaitForServerReadyAsync", "DeleteServerAsync"]
  key_links:
    - from: "tests/FileSimulator.IntegrationTests/DynamicServers/FtpServerLifecycleTests.cs"
      to: "/api/servers"
      via: "PostAsJsonAsync"
      pattern: "PostAsJsonAsync.*api/servers"
---

<objective>
Implement dynamic FTP and SFTP server lifecycle tests (create, test connectivity, file ops, delete).

Purpose: Validate that the Control API can create and manage dynamic protocol servers, and that these servers are fully functional for file operations.

Output: Complete lifecycle tests for FTP and SFTP dynamic servers.
</objective>

<execution_context>
@C:\Users\UserC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\UserC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-comprehensive-api-driven-integration-testing/14-RESEARCH.md
@src/FileSimulator.TestConsole/DynamicServerTests.cs (existing patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dynamic server API helpers</name>
  <files>
    tests/FileSimulator.IntegrationTests/Support/DynamicServerHelpers.cs
  </files>
  <action>
Create `Support/DynamicServerHelpers.cs` with API interaction helpers:

1. Model classes:
   - CreateFtpServerRequest: name, username, password, directory
   - CreateSftpServerRequest: name, username, password, directory
   - CreateNasServerRequest: name, directory, readOnly
   - ServerCreationResponse: name, host, port, username, password, serviceName, deploymentName
   - ServerStatusResponse: name, protocol, status, podReady, host, port, username, password, directory

2. CreateFtpServerAsync(HttpClient, string name, string? directory = null) -> ServerCreationResponse:
   - POST /api/servers with body: { name, username: "testuser", password: "testpass123", directory: directory ?? "input/test-dynamic" }
   - Use RetryPolicies.HttpRetryPolicy for resilience
   - Return deserialized response or throw on failure
   - Log creation request for debugging

3. CreateSftpServerAsync(HttpClient, string name, string? directory = null) -> ServerCreationResponse:
   - Same as FTP but POST to /api/servers with SFTP-appropriate body

4. CreateNasServerAsync(HttpClient, string name, string? directory = null, bool readOnly = false) -> ServerCreationResponse:
   - POST /api/servers with NAS body

5. WaitForServerReadyAsync(HttpClient, string name, TimeSpan? timeout = null) -> ServerStatusResponse:
   - Default timeout: 60 seconds
   - Poll GET /api/servers/{name} every 2 seconds
   - Use RetryPolicies.ServerReadinessPolicy
   - Return status when PodReady=true AND Status="Running"
   - Throw TimeoutException with details if not ready in time

6. DeleteServerAsync(HttpClient, string name) -> bool:
   - DELETE /api/servers/{name}
   - Accept both 200 and 404 as success (idempotent delete)
   - Poll to verify deletion (max 30 seconds)
   - Return true if deleted, false if failed

7. GetServerStatusAsync(HttpClient, string name) -> ServerStatusResponse?:
   - GET /api/servers/{name}
   - Return null on 404, throw on other errors

All methods should:
- Use System.Text.Json with PropertyNameCaseInsensitive
- Log operations to console for test debugging
- Handle HTTP errors with meaningful exceptions
  </action>
  <verify>
Run `dotnet build tests/FileSimulator.IntegrationTests` - compiles without errors.
  </verify>
  <done>
Dynamic server helpers provide clean API for server lifecycle management.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FTP dynamic server lifecycle tests</name>
  <files>
    tests/FileSimulator.IntegrationTests/DynamicServers/FtpServerLifecycleTests.cs
  </files>
  <action>
Create `DynamicServers/FtpServerLifecycleTests.cs`:

1. Class structure:
   - [Collection("Simulator")] attribute
   - Constructor takes SimulatorCollectionFixture

2. Test: FtpServer_Create_ReturnsServerInfo()
   - Generate unique name: TestHelpers.GenerateUniqueServerName("ftp")
   - Create server via DynamicServerHelpers.CreateFtpServerAsync
   - Assert response has Name, Host, Port
   - Cleanup: DeleteServerAsync in finally

3. Test: FtpServer_BecomesReady_WithinTimeout()
   - Create server
   - WaitForServerReadyAsync with 60s timeout
   - Assert status.PodReady == true
   - Assert status.Status == "Running"
   - Cleanup: DeleteServerAsync in finally

4. Test: FtpServer_AcceptsConnections_WhenReady()
   - Create server
   - Wait for ready
   - Create AsyncFtpClient with returned Host/Port/Username/Password
   - Connect and assert IsConnected
   - Disconnect
   - Cleanup: DeleteServerAsync in finally

5. Test: FtpServer_FileOperations_WorkCorrectly()
   - Create server
   - Wait for ready
   - Connect with FTP client
   - Upload test file
   - List directory, assert file found
   - Download file, assert content matches
   - Delete file, verify deleted
   - Disconnect
   - Cleanup: DeleteServerAsync in finally

6. Test: FtpServer_Delete_CleansUpResources()
   - Create server
   - Wait for ready
   - Delete server
   - Poll GetServerStatusAsync until returns null (404)
   - Assert server is truly gone within 60s

7. Test: FtpServer_CompleteLifecycle()
   - End-to-end test combining all steps:
   - Create -> Wait -> Connect -> Upload -> Download -> Delete File -> Delete Server
   - Assert each step succeeds

All tests MUST use try/finally for cleanup:
```csharp
var serverName = TestHelpers.GenerateUniqueServerName("ftp");
try
{
    // test logic
}
finally
{
    await DynamicServerHelpers.DeleteServerAsync(_fixture.ApiClient, serverName);
}
```
  </action>
  <verify>
Run `dotnet test tests/FileSimulator.IntegrationTests --filter "FullyQualifiedName~FtpServerLifecycleTests"` - all tests pass.
  </verify>
  <done>
Dynamic FTP server lifecycle tests cover create, ready, connect, file ops, delete.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create SFTP dynamic server lifecycle tests</name>
  <files>
    tests/FileSimulator.IntegrationTests/DynamicServers/SftpServerLifecycleTests.cs
  </files>
  <action>
Create `DynamicServers/SftpServerLifecycleTests.cs`:

Same structure as FTP tests but using SFTP:

1. Test: SftpServer_Create_ReturnsServerInfo()
2. Test: SftpServer_BecomesReady_WithinTimeout()
3. Test: SftpServer_AcceptsConnections_WhenReady()
   - Use SftpClient from SSH.NET
   - Wrap in Task.Run() since SSH.NET is synchronous
4. Test: SftpServer_FileOperations_WorkCorrectly()
5. Test: SftpServer_Delete_CleansUpResources()
6. Test: SftpServer_CompleteLifecycle()

Key differences from FTP:
- Use DynamicServerHelpers.CreateSftpServerAsync
- Use SftpClient instead of AsyncFtpClient
- Remote path is /data/{filename} (SFTP uses /data as root)
- Use Task.Run() for all SftpClient operations

All tests use try/finally cleanup pattern.
  </action>
  <verify>
Run `dotnet test tests/FileSimulator.IntegrationTests --filter "FullyQualifiedName~SftpServerLifecycleTests"` - all tests pass.
  </verify>
  <done>
Dynamic SFTP server lifecycle tests cover complete lifecycle.
  </done>
</task>

</tasks>

<verification>
1. FTP lifecycle tests: 6 tests pass
2. SFTP lifecycle tests: 6 tests pass
3. No orphaned dynamic servers left after tests (verify with `kubectl get pods -n file-simulator`)
4. Tests complete within reasonable time (< 3 minutes each)
</verification>

<success_criteria>
- Dynamic FTP server: create -> ready in < 60s -> connect -> file ops -> delete
- Dynamic SFTP server: create -> ready in < 60s -> connect -> file ops -> delete
- All tests clean up servers in finally blocks (no orphans)
- Tests use unique server names to avoid conflicts
</success_criteria>

<output>
After completion, create `.planning/phases/14-comprehensive-api-driven-integration-testing/14-04-SUMMARY.md`
</output>
