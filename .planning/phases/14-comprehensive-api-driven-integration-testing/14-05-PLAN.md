---
phase: 14-comprehensive-api-driven-integration-testing
plan: 05
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - tests/FileSimulator.IntegrationTests/DynamicServers/NasServerLifecycleTests.cs
autonomous: true

must_haves:
  truths:
    - "Dynamic NAS server can be created via API"
    - "Dynamic NAS server becomes ready within 60 seconds"
    - "Dynamic NAS server TCP port is accessible"
    - "Dynamic NAS server is deleted and resources cleaned up"
  artifacts:
    - path: "tests/FileSimulator.IntegrationTests/DynamicServers/NasServerLifecycleTests.cs"
      provides: "Dynamic NAS server lifecycle tests"
      contains: "CreateNasServerAsync"
  key_links:
    - from: "tests/FileSimulator.IntegrationTests/DynamicServers/NasServerLifecycleTests.cs"
      to: "/api/servers"
      via: "PostAsJsonAsync"
      pattern: "CreateNasServerAsync"
---

<objective>
Implement dynamic NAS server lifecycle tests (create, test NFS port, delete).

Purpose: Validate that the Control API can create and manage dynamic NAS servers. NFS file operations require mount which may not be available, so tests focus on server lifecycle and TCP connectivity.

Output: Complete lifecycle tests for dynamic NAS servers with platform-aware file operation testing.
</objective>

<execution_context>
@C:\Users\UserC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\UserC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-comprehensive-api-driven-integration-testing/14-RESEARCH.md
@src/FileSimulator.TestConsole/DynamicServerTests.cs (NAS patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NAS dynamic server lifecycle tests</name>
  <files>
    tests/FileSimulator.IntegrationTests/DynamicServers/NasServerLifecycleTests.cs
  </files>
  <action>
Create `DynamicServers/NasServerLifecycleTests.cs`:

1. Class structure:
   - [Collection("Simulator")] attribute
   - Constructor takes SimulatorCollectionFixture

2. Test: NasServer_Create_ReturnsServerInfo()
   - Generate unique name: TestHelpers.GenerateUniqueServerName("nas")
   - Create server via DynamicServerHelpers.CreateNasServerAsync
   - Assert response has Name, Host, Port
   - Cleanup: DeleteServerAsync in finally

3. Test: NasServer_BecomesReady_WithinTimeout()
   - Create server with directory: "input/test-dynamic-nas"
   - WaitForServerReadyAsync with 60s timeout
   - Assert status.PodReady == true
   - Assert status.Status == "Running"
   - Cleanup: DeleteServerAsync in finally

4. Test: NasServer_TcpPort_IsAccessible()
   - Create server
   - Wait for ready
   - Use TcpClient to connect to returned Host:Port
   - Assert connection succeeds
   - Cleanup: DeleteServerAsync in finally

5. Test: NasServer_ReadOnly_ConfigurationApplied()
   - Create server with readOnly: true
   - Wait for ready
   - Get server status
   - Assert server is created successfully (readOnly config passed to Helm)
   - Cleanup: DeleteServerAsync in finally

6. Test: NasServer_Delete_CleansUpResources()
   - Create server
   - Wait for ready
   - Delete server
   - Poll GetServerStatusAsync until returns null (404)
   - Assert server is truly gone within 60s

7. Test: NasServer_CompleteLifecycle()
   - End-to-end test: Create -> Wait -> TCP Connect -> Delete
   - Assert each step succeeds

8. Test (Conditional): NasServer_FileOperations_WhenMountAvailable()
   - Check if NFS mount is available (Windows: C:\simulator-data\nas-{name})
   - Skip if mount not available with clear message
   - If available: Write file, read file, verify content, delete file
   - This test validates the dynamic NAS directory is properly linked to host filesystem
   - Cleanup: DeleteServerAsync in finally

Note on NAS file operations:
- Dynamic NAS servers create subdirectories under C:\simulator-data
- The directory name matches the server name (e.g., nas-test-xxx -> C:\simulator-data\nas-test-xxx)
- This may take a few seconds to sync via Minikube mount
- File operations should include retry logic for sync delays

All tests MUST use try/finally for cleanup:
```csharp
var serverName = TestHelpers.GenerateUniqueServerName("nas");
try
{
    // test logic
}
finally
{
    await DynamicServerHelpers.DeleteServerAsync(_fixture.ApiClient, serverName);
}
```
  </action>
  <verify>
Run `dotnet test tests/FileSimulator.IntegrationTests --filter "FullyQualifiedName~NasServerLifecycleTests"` - all tests pass.
  </verify>
  <done>
Dynamic NAS server lifecycle tests cover create, ready, TCP connect, delete.
  </done>
</task>

</tasks>

<verification>
1. NAS lifecycle tests: 7-8 tests pass
2. TCP connectivity test always passes when server is ready
3. No orphaned dynamic NAS servers left after tests
4. Tests complete within reasonable time (< 3 minutes each)
5. File operation test passes when mount available, skips gracefully when not
</verification>

<success_criteria>
- Dynamic NAS server: create -> ready in < 60s -> TCP connect -> delete
- File operations test: passes when mount available, skips with message when not
- All tests clean up servers in finally blocks (no orphans)
- Tests use unique server names to avoid conflicts
</success_criteria>

<output>
After completion, create `.planning/phases/14-comprehensive-api-driven-integration-testing/14-05-SUMMARY.md`
</output>
