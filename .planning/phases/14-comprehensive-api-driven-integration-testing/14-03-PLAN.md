---
phase: 14-comprehensive-api-driven-integration-testing
plan: 03
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - tests/FileSimulator.IntegrationTests/Protocols/SmbProtocolTests.cs
  - tests/FileSimulator.IntegrationTests/Protocols/NfsProtocolTests.cs
  - tests/FileSimulator.IntegrationTests/Support/PlatformHelpers.cs
autonomous: true

must_haves:
  truths:
    - "SMB tests pass when minikube tunnel is active OR skip with clear message"
    - "NFS TCP connectivity test passes"
    - "NFS file operations pass when mount path exists OR skip with clear message"
  artifacts:
    - path: "tests/FileSimulator.IntegrationTests/Protocols/SmbProtocolTests.cs"
      provides: "SMB protocol integration tests with platform-specific handling"
      contains: "SMB2Client"
    - path: "tests/FileSimulator.IntegrationTests/Protocols/NfsProtocolTests.cs"
      provides: "NFS protocol tests with mount detection"
      contains: "TcpClient"
    - path: "tests/FileSimulator.IntegrationTests/Support/PlatformHelpers.cs"
      provides: "Platform-specific test helpers"
      exports: ["IsSmbAccessible", "IsNfsMounted"]
  key_links:
    - from: "tests/FileSimulator.IntegrationTests/Protocols/SmbProtocolTests.cs"
      to: "minikube tunnel"
      via: "LoadBalancer IP resolution"
      pattern: "SMB2Client.*Connect"
---

<objective>
Implement static protocol tests for SMB and NFS with platform-specific handling.

Purpose: SMB requires minikube tunnel on Windows (LoadBalancer), NFS requires mounted filesystem. Tests must handle these constraints gracefully - passing when infrastructure available, skipping with clear message when not.

Output: SMB and NFS protocol tests that work across different environments.
</objective>

<execution_context>
@C:\Users\UserC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\UserC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-comprehensive-api-driven-integration-testing/14-RESEARCH.md
@src/FileSimulator.TestConsole/Program.cs (SMB and NFS test patterns)
@CLAUDE.md (SMB tunnel requirement, NFS Windows limitations)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create platform helpers for SMB and NFS detection</name>
  <files>
    tests/FileSimulator.IntegrationTests/Support/PlatformHelpers.cs
  </files>
  <action>
Create `Support/PlatformHelpers.cs` with platform-specific detection:

1. IsSmbAccessibleAsync(string host, int port) -> Task<bool>:
   - Try TCP connection to SMB port
   - Try SMB2Client.Connect() with DirectTCPTransport
   - Return true if both succeed, false otherwise
   - Catch exceptions and return false (don't throw)
   - Log diagnostic info to console

2. IsNfsMountedAsync(string mountPath) -> Task<bool>:
   - Check if mountPath directory exists
   - Check if it contains files (not just empty mount point)
   - On Windows, check for simulator-data directory structure
   - Return true if mounted and accessible, false otherwise

3. GetNfsMountPath() -> string:
   - Windows: Return @"C:\simulator-data" (standard Minikube mount)
   - Linux: Return "/mnt/nfs" or from env var NFS_MOUNT_PATH
   - Use RuntimeInformation.IsOSPlatform for detection

4. TryTcpConnect(string host, int port, TimeSpan timeout) -> Task<bool>:
   - Generic TCP connectivity helper
   - Returns true if connection succeeds within timeout
   - Used by both SMB and NFS tests

5. GetSkipMessage(string protocol, string requirement) -> string:
   - Returns standardized skip message:
   - "{protocol} test skipped: {requirement}. To run this test: {instructions}"
  </action>
  <verify>
Run `dotnet build tests/FileSimulator.IntegrationTests` - compiles without errors.
  </verify>
  <done>
Platform helpers detect SMB accessibility and NFS mount status.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SMB protocol tests with tunnel detection</name>
  <files>
    tests/FileSimulator.IntegrationTests/Protocols/SmbProtocolTests.cs
  </files>
  <action>
Create SMB protocol tests in `Protocols/SmbProtocolTests.cs`:

1. Class structure:
   - [Collection("Simulator")] attribute
   - Constructor takes SimulatorCollectionFixture
   - Private _smbAccessible field set in constructor via PlatformHelpers.IsSmbAccessibleAsync()

2. Skip pattern for all tests:
   ```csharp
   if (!_smbAccessible)
   {
       Skip.If(true, PlatformHelpers.GetSkipMessage("SMB",
           "requires 'minikube tunnel' running in Administrator terminal"));
   }
   ```

3. Test methods (use SMBLibrary SMB2Client):
   - SMB_CanConnect() - Connect to SMB server, login, assert success
   - SMB_TreeConnect_AccessesShare() - Login, TreeConnect to "simulator" share, assert success
   - SMB_Upload_CreatesFile() - CreateFile with WRITE access, WriteFile, CloseFile
   - SMB_Download_ReturnsContent() - Upload, CreateFile with READ, ReadFile, assert content
   - SMB_List_ReturnsUploadedFile() - Upload, CreateFile dir, QueryDirectory, assert file found
   - SMB_Delete_RemovesFile() - Upload, CreateFile with DELETE_ON_CLOSE, CloseFile, verify deleted
   - SMB_FullCycle_CRUD() - Complete cycle with cleanup

4. SMB helper methods:
   - CreateSmbClient() - returns configured SMB2Client
   - LoginAndConnect(SMB2Client, shareName) - login and tree connect, returns ISMBFileStore
   - Cleanup in finally blocks using fileStore.Disconnect() and client.Disconnect()

5. Configuration from connection-info:
   - Host, Port, Username ("smbuser"), Password ("smbpass123"), ShareName ("simulator"), BasePath ("output")
  </action>
  <verify>
With minikube tunnel running: `dotnet test tests/FileSimulator.IntegrationTests --filter "FullyQualifiedName~SmbProtocolTests"` - tests pass.
Without tunnel: Tests skip with clear message about requirement.
  </verify>
  <done>
SMB tests pass when tunnel active, skip gracefully when not.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create NFS protocol tests with mount detection</name>
  <files>
    tests/FileSimulator.IntegrationTests/Protocols/NfsProtocolTests.cs
  </files>
  <action>
Create NFS protocol tests in `Protocols/NfsProtocolTests.cs`:

1. Class structure:
   - [Collection("Simulator")] attribute
   - Constructor takes SimulatorCollectionFixture
   - Private _nfsMounted field set by checking mount path
   - Private _nfsTcpAccessible field set by TCP connect test

2. Test methods - two categories:

   **Always-run tests (TCP connectivity):**
   - NFS_TcpConnectivity_ServerReachable() - TcpClient connect to NFS port, assert success

   **Conditional tests (require mount):**
   - NFS_Mount_DirectoryExists() - Skip if !_nfsMounted, else assert mount path exists
   - NFS_Upload_CreatesFile() - Skip if !_nfsMounted, else File.WriteAllText, verify exists
   - NFS_Download_ReturnsContent() - Skip if !_nfsMounted, else write, read, assert content
   - NFS_List_ReturnsUploadedFile() - Skip if !_nfsMounted, else Directory.GetFiles, assert found
   - NFS_Delete_RemovesFile() - Skip if !_nfsMounted, else File.Delete, verify !Exists
   - NFS_FullCycle_CRUD() - Skip if !_nfsMounted, complete cycle

3. Skip message for mount tests:
   "NFS file operation tests skipped: mount path not available.
    TCP connectivity verified. To run file operations:
    Linux: sudo mount -t nfs {host}:/data {mountPath}
    Windows: Use C:\\simulator-data via Minikube mount"

4. Windows-specific path handling:
   - Use Path.Combine for cross-platform paths
   - Base path is C:\simulator-data\output or /mnt/nfs/output
   - Create subdirectory if needed

5. Cleanup: Delete test files in finally block
  </action>
  <verify>
`dotnet test tests/FileSimulator.IntegrationTests --filter "FullyQualifiedName~NfsProtocolTests"` - TCP test passes, file ops pass if mounted.
  </verify>
  <done>
NFS TCP connectivity always tested, file operations tested when mount available.
  </done>
</task>

</tasks>

<verification>
1. With minikube tunnel: SMB tests pass (6+ tests)
2. Without minikube tunnel: SMB tests skip with clear "requires minikube tunnel" message
3. NFS TCP connectivity test always passes
4. With mount: NFS file operation tests pass (6+ tests)
5. Without mount: NFS file tests skip with clear "mount path not available" message
</verification>

<success_criteria>
- SMB protocol: 7 tests pass when tunnel active, all skip gracefully otherwise
- NFS protocol: TCP test always passes, 6 file operation tests pass when mounted
- Skip messages include clear instructions for how to enable the tests
- No hanging tests waiting for unavailable infrastructure
</success_criteria>

<output>
After completion, create `.planning/phases/14-comprehensive-api-driven-integration-testing/14-03-SUMMARY.md`
</output>
