---
phase: 14-comprehensive-api-driven-integration-testing
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - tests/FileSimulator.IntegrationTests/Protocols/FtpProtocolTests.cs
  - tests/FileSimulator.IntegrationTests/Protocols/SftpProtocolTests.cs
  - tests/FileSimulator.IntegrationTests/Protocols/HttpProtocolTests.cs
  - tests/FileSimulator.IntegrationTests/Protocols/WebDavProtocolTests.cs
  - tests/FileSimulator.IntegrationTests/Protocols/S3ProtocolTests.cs
autonomous: true

must_haves:
  truths:
    - "FTP file operations (connect, upload, list, download, delete) pass"
    - "SFTP file operations (connect, upload, list, download, delete) pass"
    - "HTTP read operations (health, list) pass"
    - "WebDAV file operations (connect, upload, list, download, delete) pass"
    - "S3/MinIO file operations (connect, upload, list, download, delete) pass"
  artifacts:
    - path: "tests/FileSimulator.IntegrationTests/Protocols/FtpProtocolTests.cs"
      provides: "FTP protocol integration tests"
      contains: "[Collection(\"Simulator\")]"
    - path: "tests/FileSimulator.IntegrationTests/Protocols/SftpProtocolTests.cs"
      provides: "SFTP protocol integration tests"
      contains: "[Collection(\"Simulator\")]"
    - path: "tests/FileSimulator.IntegrationTests/Protocols/S3ProtocolTests.cs"
      provides: "S3/MinIO protocol integration tests"
      contains: "AmazonS3Client"
  key_links:
    - from: "tests/FileSimulator.IntegrationTests/Protocols/FtpProtocolTests.cs"
      to: "/api/connection-info"
      via: "fixture.GetConnectionInfoAsync()"
      pattern: "GetConnectionInfoAsync"
---

<objective>
Implement static protocol tests for FTP, SFTP, HTTP, WebDAV, and S3.

Purpose: Validate all file operations (upload, download, list, delete) work correctly for the primary network protocols. These tests use the static Helm-deployed servers.

Output: Complete test coverage for 5 protocols with full CRUD operations.
</objective>

<execution_context>
@C:\Users\UserC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\UserC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-comprehensive-api-driven-integration-testing/14-RESEARCH.md
@src/FileSimulator.TestConsole/Program.cs (existing protocol test patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FTP and SFTP protocol tests</name>
  <files>
    tests/FileSimulator.IntegrationTests/Protocols/FtpProtocolTests.cs
    tests/FileSimulator.IntegrationTests/Protocols/SftpProtocolTests.cs
  </files>
  <action>
Create FTP protocol tests in `Protocols/FtpProtocolTests.cs`:

1. Class structure:
   - [Collection("Simulator")] attribute
   - Constructor takes SimulatorCollectionFixture
   - Private helper: CreateTestContent() returns unique timestamped content
   - Private helper: GetFtpConfig() returns Ftp config from connection-info

2. Test methods (each is [Fact]):
   - FTP_CanConnect() - create AsyncFtpClient, connect, assert IsConnected, disconnect
   - FTP_Upload_CreatesFile() - upload test file to /output/{unique-name}.txt, verify via list
   - FTP_Download_ReturnsCorrectContent() - upload, download, assert content matches
   - FTP_List_ReturnsUploadedFile() - upload, list /output, assert file in listing
   - FTP_Delete_RemovesFile() - upload, delete, list, assert file not in listing
   - FTP_FullCycle_CRUD() - complete create/read/update/delete cycle in one test

3. Cleanup pattern: Use try/finally to delete test files even on assertion failure

Create SFTP protocol tests in `Protocols/SftpProtocolTests.cs`:
Same structure as FTP but using SftpClient from SSH.NET:
   - SFTP_CanConnect()
   - SFTP_Upload_CreatesFile()
   - SFTP_Download_ReturnsCorrectContent()
   - SFTP_List_ReturnsUploadedFile()
   - SFTP_Delete_RemovesFile()
   - SFTP_FullCycle_CRUD()

Use Task.Run() for SFTP operations (SSH.NET is synchronous).
Use FluentAssertions: .Should().BeTrue(), .Should().Contain(), .Should().Be()
  </action>
  <verify>
Run `dotnet test tests/FileSimulator.IntegrationTests --filter "FullyQualifiedName~FtpProtocolTests"` and `--filter "FullyQualifiedName~SftpProtocolTests"`.
  </verify>
  <done>
FTP and SFTP protocol tests pass all CRUD operations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create HTTP, WebDAV, and S3 protocol tests</name>
  <files>
    tests/FileSimulator.IntegrationTests/Protocols/HttpProtocolTests.cs
    tests/FileSimulator.IntegrationTests/Protocols/WebDavProtocolTests.cs
    tests/FileSimulator.IntegrationTests/Protocols/S3ProtocolTests.cs
  </files>
  <action>
Create HTTP protocol tests in `Protocols/HttpProtocolTests.cs`:

1. HTTP is read-only, so tests are:
   - HTTP_Health_ReturnsSuccess() - GET /health returns 200
   - HTTP_List_ReturnsDirectoryListing() - GET /api/files/ returns JSON listing
   - HTTP_Read_OutputDirectory_ReturnsContent() - GET /output/ returns directory listing

Create WebDAV protocol tests in `Protocols/WebDavProtocolTests.cs`:

1. Class structure similar to FTP but using HttpClient with Basic auth
2. Test methods:
   - WebDAV_CanConnect() - GET root with auth, assert 200
   - WebDAV_Upload_PUT_CreatesFile() - PUT file, verify via GET
   - WebDAV_Download_GET_ReturnsContent() - PUT, GET, assert content matches
   - WebDAV_List_ReturnsUploadedFile() - PUT, GET directory, assert filename in HTML
   - WebDAV_Delete_RemovesFile() - PUT, DELETE, GET returns 404
   - WebDAV_FullCycle_CRUD()

Create S3 protocol tests in `Protocols/S3ProtocolTests.cs`:

1. Use AmazonS3Client with ForcePathStyle=true for MinIO compatibility
2. Test methods:
   - S3_ListBuckets_ContainsOutputBucket() - ListBucketsAsync, assert "output" bucket exists
   - S3_Upload_PutObject_Succeeds() - PutObjectAsync with test content
   - S3_Download_GetObject_ReturnsContent() - PutObject, GetObject, read stream, assert content
   - S3_List_ReturnsUploadedObject() - PutObject, ListObjectsV2Async, assert key in results
   - S3_Delete_RemovesObject() - PutObject, DeleteObjectAsync, ListObjects, assert key not in results
   - S3_FullCycle_CRUD()

All tests should:
- Use unique file names (TestHelpers.GenerateUniqueFileName)
- Clean up test files in finally block
- Use FluentAssertions for assertions
  </action>
  <verify>
Run `dotnet test tests/FileSimulator.IntegrationTests --filter "FullyQualifiedName~HttpProtocolTests|WebDavProtocolTests|S3ProtocolTests"`.
  </verify>
  <done>
HTTP, WebDAV, and S3 protocol tests pass all operations.
  </done>
</task>

</tasks>

<verification>
1. `dotnet test tests/FileSimulator.IntegrationTests --filter "Category=Protocol"` passes all tests
2. Each protocol has at least 5 test methods covering CRUD operations
3. No test files left behind after test run (cleanup working)
</verification>

<success_criteria>
- FTP protocol: 6 tests pass (connect, upload, download, list, delete, full-cycle)
- SFTP protocol: 6 tests pass (connect, upload, download, list, delete, full-cycle)
- HTTP protocol: 3 tests pass (health, list, read)
- WebDAV protocol: 6 tests pass (connect, upload, download, list, delete, full-cycle)
- S3/MinIO protocol: 6 tests pass (buckets, upload, download, list, delete, full-cycle)
</success_criteria>

<output>
After completion, create `.planning/phases/14-comprehensive-api-driven-integration-testing/14-02-SUMMARY.md`
</output>
