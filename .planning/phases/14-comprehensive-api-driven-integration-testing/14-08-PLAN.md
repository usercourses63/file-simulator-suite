---
phase: 14-comprehensive-api-driven-integration-testing
plan: 08
type: execute
wave: 4
depends_on: ["14-02", "14-03", "14-04", "14-05", "14-06", "14-07"]
files_modified:
  - tests/FileSimulator.IntegrationTests/TestRunner.cs
  - tests/FileSimulator.IntegrationTests/GlobalSuppressions.cs
  - scripts/Run-IntegrationTests.ps1
  - .github/workflows/integration-tests.yml
autonomous: true

must_haves:
  truths:
    - "dotnet test exits with code 0 only when 100% tests pass"
    - "JUnit XML file is generated in test-results directory"
    - "PowerShell script runs all tests and reports summary"
    - "CI/CD workflow can consume JUnit XML for test reporting"
  artifacts:
    - path: "scripts/Run-IntegrationTests.ps1"
      provides: "Test execution script with summary reporting"
      contains: "dotnet test"
    - path: ".github/workflows/integration-tests.yml"
      provides: "GitHub Actions workflow for integration tests"
      contains: "junit"
  key_links:
    - from: "scripts/Run-IntegrationTests.ps1"
      to: "tests/FileSimulator.IntegrationTests"
      via: "dotnet test"
      pattern: "dotnet test.*IntegrationTests"
---

<objective>
Configure JUnit XML export, create test runner script, and CI/CD workflow.

Purpose: Enable CI/CD integration with JUnit XML test results and ensure the test suite exits with appropriate exit codes for automation. Provide convenient script for running tests locally.

Output: Complete CI/CD integration with JUnit XML export and pass/fail exit codes.
</objective>

<execution_context>
@C:\Users\UserC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\UserC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-comprehensive-api-driven-integration-testing/14-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test runner script</name>
  <files>
    scripts/Run-IntegrationTests.ps1
  </files>
  <action>
Create `scripts/Run-IntegrationTests.ps1`:

```powershell
#Requires -Version 7.0
<#
.SYNOPSIS
    Runs FileSimulator integration tests with JUnit XML output.

.DESCRIPTION
    Executes all integration tests and generates JUnit XML report for CI/CD integration.
    Returns exit code 0 only if 100% of tests pass.

.PARAMETER Filter
    Optional test filter (e.g., "FullyQualifiedName~Protocol")

.PARAMETER ResultsDir
    Directory for test results (default: test-results)

.PARAMETER Verbosity
    Test output verbosity: minimal, normal, detailed (default: normal)

.PARAMETER NoBuild
    Skip build step if tests are already built

.EXAMPLE
    .\Run-IntegrationTests.ps1

.EXAMPLE
    .\Run-IntegrationTests.ps1 -Filter "FullyQualifiedName~SmokeTests" -Verbosity detailed
#>
param(
    [string]$Filter,
    [string]$ResultsDir = "test-results",
    [ValidateSet("minimal", "normal", "detailed")]
    [string]$Verbosity = "normal",
    [switch]$NoBuild
)

$ErrorActionPreference = "Continue"
$projectPath = Join-Path $PSScriptRoot "..\tests\FileSimulator.IntegrationTests"
$resultsPath = Join-Path $PSScriptRoot "..\$ResultsDir"

# Ensure results directory exists
if (!(Test-Path $resultsPath)) {
    New-Item -ItemType Directory -Path $resultsPath -Force | Out-Null
}

Write-Host "╔═══════════════════════════════════════════════════════════════════╗" -ForegroundColor Cyan
Write-Host "║           FileSimulator Integration Tests                         ║" -ForegroundColor Cyan
Write-Host "╚═══════════════════════════════════════════════════════════════════╝" -ForegroundColor Cyan
Write-Host ""

# Build arguments
$testArgs = @(
    "test"
    $projectPath
    "--logger:junit;LogFilePath=$resultsPath/junit-integration-tests.xml"
    "--logger:console;verbosity=$Verbosity"
    "--results-directory:$resultsPath"
)

if ($NoBuild) {
    $testArgs += "--no-build"
}

if ($Filter) {
    $testArgs += "--filter"
    $testArgs += $Filter
    Write-Host "Filter: $Filter" -ForegroundColor Yellow
}

Write-Host "Running: dotnet $($testArgs -join ' ')" -ForegroundColor Gray
Write-Host ""

# Run tests
$startTime = Get-Date
& dotnet @testArgs
$exitCode = $LASTEXITCODE
$endTime = Get-Date
$duration = $endTime - $startTime

Write-Host ""
Write-Host "═══════════════════════════════════════════════════════════════════" -ForegroundColor Cyan

# Parse JUnit XML for summary
$junitFile = Join-Path $resultsPath "junit-integration-tests.xml"
if (Test-Path $junitFile) {
    [xml]$junit = Get-Content $junitFile
    $testSuites = $junit.testsuites

    $totalTests = [int]$testSuites.tests
    $failures = [int]$testSuites.failures
    $errors = [int]$testSuites.errors
    $skipped = [int]$testSuites.skipped
    $passed = $totalTests - $failures - $errors - $skipped

    Write-Host ""
    Write-Host "Test Summary:" -ForegroundColor White
    Write-Host "  Total:   $totalTests" -ForegroundColor White
    Write-Host "  Passed:  $passed" -ForegroundColor Green
    if ($failures -gt 0) {
        Write-Host "  Failed:  $failures" -ForegroundColor Red
    }
    if ($errors -gt 0) {
        Write-Host "  Errors:  $errors" -ForegroundColor Red
    }
    if ($skipped -gt 0) {
        Write-Host "  Skipped: $skipped" -ForegroundColor Yellow
    }
    Write-Host "  Duration: $($duration.ToString('mm\:ss'))" -ForegroundColor Gray
    Write-Host ""
    Write-Host "JUnit XML: $junitFile" -ForegroundColor Gray
}

# Exit with appropriate code
if ($exitCode -eq 0) {
    Write-Host "✓ All tests passed!" -ForegroundColor Green
} else {
    Write-Host "✗ Tests failed (exit code: $exitCode)" -ForegroundColor Red
}

exit $exitCode
```
  </action>
  <verify>
Run `.\scripts\Run-IntegrationTests.ps1 -Filter "FullyQualifiedName~SmokeTests"` - runs tests and generates JUnit XML.
  </verify>
  <done>
Test runner script executes tests with JUnit XML output and summary.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions workflow</name>
  <files>
    .github/workflows/integration-tests.yml
  </files>
  <action>
Create `.github/workflows/integration-tests.yml`:

```yaml
name: Integration Tests

on:
  workflow_dispatch:
    inputs:
      filter:
        description: 'Test filter (e.g., FullyQualifiedName~Protocol)'
        required: false
        default: ''

# Note: This workflow requires a running file-simulator cluster
# It's designed for manual execution after deployment verification

jobs:
  integration-tests:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET 9.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies
        run: dotnet restore tests/FileSimulator.IntegrationTests

      - name: Build test project
        run: dotnet build tests/FileSimulator.IntegrationTests --no-restore --configuration Release

      - name: Run integration tests
        id: test
        run: |
          $filter = "${{ github.event.inputs.filter }}"
          $args = @(
            "test"
            "tests/FileSimulator.IntegrationTests"
            "--no-build"
            "--configuration:Release"
            "--logger:junit;LogFilePath=test-results/junit-integration-tests.xml"
            "--logger:trx;LogFileName=test-results.trx"
          )
          if ($filter) {
            $args += "--filter"
            $args += $filter
          }
          & dotnet @args
        shell: pwsh
        continue-on-error: true
        env:
          # Override API URL if needed
          CONTROL_API_URL: ${{ vars.CONTROL_API_URL || 'http://file-simulator.local:30500' }}

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action/windows@v2
        if: always()
        with:
          files: test-results/*.xml
          check_name: 'Integration Test Results'
          comment_mode: 'off'

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            test-results/*.xml
            test-results/*.trx
          retention-days: 30

      - name: Check test result
        if: steps.test.outcome == 'failure'
        run: exit 1
```

Note: This workflow is designed for manual trigger because integration tests require a running file-simulator cluster.
  </action>
  <verify>
File created with valid YAML syntax. Workflow can be tested via GitHub Actions manual dispatch after setup.
  </verify>
  <done>
GitHub Actions workflow created for CI/CD integration.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add global suppressions and finalize project</name>
  <files>
    tests/FileSimulator.IntegrationTests/GlobalSuppressions.cs
  </files>
  <action>
Create `GlobalSuppressions.cs` to handle known analyzer warnings:

```csharp
// This file is used by Code Analysis to maintain SuppressMessage
// attributes that are applied to this project.
// Project-level suppressions either have no target or are given
// a specific target and scoped to a namespace, type, member, etc.

using System.Diagnostics.CodeAnalysis;

// Suppress async suffix requirement for test methods
[assembly: SuppressMessage("Style", "VSTHRD200:Use \"Async\" suffix for async methods",
    Justification = "Test method naming convention does not require Async suffix")]

// Suppress ConfigureAwait requirements for test methods
[assembly: SuppressMessage("Reliability", "CA2007:Consider calling ConfigureAwait on the awaited task",
    Justification = "Test methods don't need ConfigureAwait")]

// Suppress nullable reference warnings for test assertions
[assembly: SuppressMessage("Style", "IDE0270:Use coalesce expression",
    Justification = "Explicit null checks improve test readability")]
```

Also verify the project builds and test count:

1. Run `dotnet build tests/FileSimulator.IntegrationTests`
2. Run `dotnet test tests/FileSimulator.IntegrationTests --list-tests` to count tests
3. Verify expected test count (should be 50+ tests across all categories)
  </action>
  <verify>
Run `dotnet test tests/FileSimulator.IntegrationTests --list-tests | Measure-Object` - should show 50+ tests.
  </verify>
  <done>
Project finalized with suppressions and verified test count.
  </done>
</task>

</tasks>

<verification>
1. `dotnet test tests/FileSimulator.IntegrationTests` exits 0 when all tests pass
2. `dotnet test tests/FileSimulator.IntegrationTests` exits non-zero when any test fails
3. JUnit XML file generated at test-results/junit-integration-tests.xml
4. PowerShell script reports summary from JUnit XML
5. GitHub Actions workflow has valid YAML syntax
</verification>

<success_criteria>
- Exit code 0 only when 100% of tests pass
- JUnit XML export working for CI/CD integration
- PowerShell script provides convenient local test execution
- GitHub Actions workflow ready for manual integration test runs
- 50+ integration tests across all categories
</success_criteria>

<output>
After completion, create `.planning/phases/14-comprehensive-api-driven-integration-testing/14-08-SUMMARY.md`
</output>
